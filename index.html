<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <title>Teacher Swaps Kenya</title>
  <style>
    /* ... Your existing styles unchanged ... */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .blurred {
      filter: blur(5px);
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }
    .blurred:hover {
      filter: none; /* Hint at visibility after payment */
    }
    header {
      background-color: #4CAF50;
      color: white;
      padding: 15px;
      text-align: center;
    }
    nav ul {
      list-style-type: none;
      padding: 0;
    }
    nav ul li {
      display: inline;
      margin: 0 10px;
    }
#swapTable th {
  color: red;
  font-weight: bold;
}

    main {
      padding: 20px;
    }
    footer {
      background-color: #4CAF50;
      color: white;
      text-align: center;
      padding: 10px;
      position: relative;
      bottom: 0;
      width: 100%;
    }
    form {
      max-width: 400px;
      margin: auto;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input,
    select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table,
    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }

    /* Payment Modal Styles */
    #paymentModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
    }
    #paymentModal .modal-content {
      margin: 15% auto;
      padding: 20px;
      background: white;
      width: 80%;
      max-width: 400px;
      text-align: center;
      border-radius: 8px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
    }

    /* Alert Styling */
    .alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #4CAF50;
      color: white;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
      z-index: 1000;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
    }
  #matchesModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 70%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 500px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    text-align: center;
  }
  .modal-content button {
  margin-top: 15px;
  padding: 10px 20px;
  background-color: #4CAF50; /* Green */
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.modal-content button:hover {
  background-color: #45a049; /* Slightly darker green for hover */
}

  #registerForm input {
    background-color: #e6f7ff; /* Light blue background */
    border: 2px solid #3399ff; /* Blue border */
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
    font-size: 16px;
  }

  #registerForm input:focus {
    background-color: #d0f0ff; /* Slightly brighter on focus */
    outline: none;
    border-color: #007acc;
  }

  #registerForm label {
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
    font-weight: bold;
  }

  #registerForm button {
    margin-top: 15px;
    padding: 10px 20px;
    background-color: #3399ff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
  }

  #registerForm button:hover {
    background-color: #007acc;
  }
  /* Common input/select styling */
  form input,
  form select {
    background-color: #e6f7ff;
    border: 2px solid #3399ff;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
    font-size: 16px;
  }

  form input:focus,
  form select:focus {
    background-color: #d0f0ff;
    outline: none;
    border-color: #007acc;
  }

  form label {
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
    font-weight: bold;
  }

  form button {
    margin-top: 15px;
    padding: 10px 20px;
    background-color: #3399ff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
  }

  form button:hover {
    background-color: #007acc;
  }
  /* Styled input and select fields */
  form input,
  form select,
  select {
    background-color: #e6f7ff;
    border: 2px solid #3399ff;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
    font-size: 16px;
  }

  form input:focus,
  form select:focus,
  select:focus {
    background-color: #d0f0ff;
    outline: none;
    border-color: #007acc;
  }

  /* Labels */
  label {
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
    font-weight: bold;
  }

  /* Buttons */
  button {
    margin: 8px 5px 15px 0;
    padding: 10px 16px;
    background-color: #3399ff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
  }

  button:hover {
    background-color: #007acc;
  }

  .trigger-button {
    background-color: #33cc99;
  }

  .trigger-button:hover {
    background-color: #29a37d;
  }
 #register {
    display: none;
    background-image: url('https://i.imgur.com/WKwJ73A.jpeg');
    background-size: cover;
    background-position: center;
    padding: 40px;
    border-radius: 12px;
    color: white;
    min-height: 100vh; /* full viewport height */
  }

  #register h2,
  #register label {
    color: white;
    text-shadow: 1px 1px 3px #000;
  }

  #registerForm {
    background-color: rgba(0, 0, 0, 0.5); /* semi-transparent form background */
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    margin: auto;
  }

  #registerForm input {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: none;
    border-radius: 5px;
  }

  #registerForm button {
    width: 100%;
    padding: 10px;
    background-color: #4CAF50;
    border: none;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }

  #registerForm button:hover {
    background-color: #45a049;
  }

 #login {
    display: none;
    background-image: url('  https://i.imgur.com/iqBwsWm.png           ');
    background-size: cover;
    background-position: center;
    padding: 40px;
    border-radius: 12px;
    color: white;
    min-height: 100vh;
  }

  #login h2,
  #login label {
    color: white;
    text-shadow: 1px 1px 3px #000;
  }

  #loginForm {
    background-color: rgba(0, 0, 0, 0.5); /* transparent dark background for form */
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    margin: auto;
  }

  #loginForm input {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: none;
    border-radius: 5px;
  }

  #loginForm button {
    width: 100%;
    padding: 10px;
    background-color: #2196F3;
    border: none;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }

  #loginForm button:hover {
    background-color: #1976D2;
  }

#swaps {
  display: none;
  background-color: #4caf50; /* Green color */
  padding: 40px;
  border-radius: 12px;
  color: white;
  min-height: 100vh;
}


  #swaps h2,
  #swaps label {
    color: white;
    text-shadow: 1px 1px 3px #000;
  }

  #swapForm {
    background-color: rgba(0, 0, 0, 0.5); /* dark translucent form bg */
    padding: 20px;
    border-radius: 10px;
    max-width: 600px;
    margin: auto;
  }

  #swapForm input,
  #swapForm select {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: none;
    border-radius: 5px;
  }

  #swapForm button {
    width: 100%;
    padding: 10px;
    background-color: #ff9800;
    border: none;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }

  #swapForm button:hover {
    background-color: #f57c00;
  }

.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.7);
}

.modal-content {
  background: linear-gradient(135deg, #fff0f6, #ffe6f0);
  margin: 10% auto;
  padding: 20px;
  border-radius: 12px;
  width: 80%;
  max-width: 350px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  font-family: 'Arial', sans-serif;
}

.modal-body p {
  margin: 10px 0;
  color: #444;
  font-size: 15px;
}

.close {
  float: right;
  font-size: 24px;
  font-weight: bold;
  color: #f44336;
  cursor: pointer;
}
.service-card {
  scroll-snap-align: start;
  padding: 20px;
  background: #f0f8ff; /* Light blue background */
  border: 1px solid #ccc;
  border-radius: 10px;
  min-height: 170px;
  width: 100%; /* ✅ Makes it fill available grid column */
  box-sizing: border-box; /* ✅ Includes padding in width */
  box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease; /* Optional: smooth hover effect */
}

.market-card {
  padding: 20px;
  background: #ffe4b5;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.1);
  box-sizing: border-box;
  width: 100%; /* ✅ Allow it to fully fill the grid cell */
}

#bomJobsTable {
  width: 100%;
  border-collapse: collapse;
}
  .form-wrapper {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    gap: 20px;
    padding: 20px;
  }

  .form-wrapper form {
    flex: 1;
    max-width: 600px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 10px;
    background: #f9f9f9;
  }

  .side-image {
    flex: 0 0 150px;
  }

  .side-image img {
    width: 100%;
    height: auto;
    border-radius: 10px;
  }

  form input,
  form select,
  form button {
    width: 100%;
    margin-bottom: 12px;
    padding: 10px;
    font-size: 16px;
  }

  form button {
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }

  form button:hover {
    background-color: #0056b3;
  }

  @media (max-width: 768px) {
    .form-wrapper {
      flex-direction: column;
      align-items: center;
    }

    .side-image {
      display: none;
    }
  }
  .chat-bubble {
    display: flex;
    margin-bottom: 10px;
    max-width: 90%;
  }

  .chat-bubble.left {
    justify-content: flex-start;
  }

  .chat-bubble.right {
    justify-content: flex-end;
  }

  .chat-avatar {
    width: 35px;
    height: 35px;
    background: #bbb;
    color: white;
    border-radius: 50%;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    line-height: 35px;
    margin-right: 10px;
    flex-shrink: 0;
  }

  .chat-bubble.right .chat-avatar {
    order: 2;
    margin-left: 10px;
    margin-right: 0;
  }

  .chat-content {
    background: #f1f1f1;
    border-radius: 8px;
    padding: 8px 12px;
    max-width: 250px;
    position: relative;
  }

  .chat-bubble.right .chat-content {
    background: #007bff;
    color: white;
  }

  .chat-name {
    font-size: 0.9em;
    font-weight: bold;
    margin-bottom: 4px;
  }

  .chat-time {
    font-size: 0.75em;
    color: #999;
    text-align: right;
    margin-top: 4px;
  }
 .form-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px; /* space between items */
  }

  .side-image {
    width: 120px;
    height: auto;
  }

  #resourceForm {
    display: flex;
    flex-direction: column;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  #resourceForm label {
    margin-top: 10px;
  }

  #resourceForm input,
  #resourceForm button {
    margin-top: 5px;
    padding: 8px;
    font-size: 1rem;
  }

  #resourceForm button {
    margin-top: 15px;
    background-color: #1e90ff;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #resourceForm button i {
    margin-right: 6px;
  }
.form-container {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .side-image {
    width: 120px;
    height: auto;
  }

  #soulmateForm {
    display: flex;
    flex-direction: column;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    max-width: 400px;
    flex: 1;
  }

  #soulmateForm label {
    margin-top: 10px;
    font-weight: bold;
  }

  #soulmateForm input,
  #soulmateForm select {
    margin-top: 5px;
    padding: 8px;
    font-size: 1rem;
  }

  #soulmateForm button {
    margin-top: 20px;
    background-color: #e91e63;
    color: white;
    border: none;
    padding: 10px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 4px;
  }

  #soulmateForm button i {
    margin-right: 6px;
  }
.swap-card button:hover {
  opacity: 0.9;
  cursor: pointer;
}
.job-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  background-color: #f9f9f9;
}

.job-card h3 {
  color: #2e7d32;
}

.job-card p {
  margin-bottom: 8px;
}

.job-card button {
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
}

.rating {
  margin-top: 10px;
}

.rating .fas {
  cursor: pointer;
  color: #ccc;
}
#soulmateContainer {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Larger cards */
  gap: 20px;
  padding: 20px;
  box-sizing: border-box;
  max-width: 1200px;           /* ✅ Limits width to center content */
  margin: 0 auto;              /* ✅ Centers grid on screen */
  overflow-y: auto;
  max-height: 90vh;            /* ✅ Scrolls inside container */
  scroll-snap-type: y mandatory;
  scroll-padding-top: 20px;    /* Smooth snap spacing */
}

body {
  overflow-y: scroll;
  margin: 0;
  padding: 0;
  font-family: sans-serif;
}

.soulmate-card {
  scroll-snap-align: start;
  padding: 20px;
  background: #f0f8ff;         /* Light blue background */
  border: 1px solid #ccc;
  border-radius: 10px;
  min-height: 170px;
  width: 100%;                 /* Fills grid column */
  box-sizing: border-box;
  box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease;
}

.soulmate-card:hover {
  transform: scale(1.02);      /* Optional: subtle hover zoom */
}


@media (max-width: 768px) {
  /* Adjust the layout for mobile */
  #soulmateContainer {
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); /* Ensures smaller screens still look good */
  }

  .soulmate-card {
    padding: 15px; /* Slightly reduced padding for mobile */
  }
}
/* Style for headers */
header h1 {
  color: white;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.5rem;
  padding: 10px 20px;
  border: 2px solid #4CAF50; /* Green border */
  border-radius: 10px; /* Rounded corners */
  margin: 10px 0;
  background-color: rgba(0, 0, 0, 0.2); /* Semi-transparent background */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); /* Shadow for depth */
}

/* Apply border to other headers, like h2 */
h2 {
  color: #2196f3;
  padding: 8px 15px;
  border: 2px solid #2196f3; /* Blue border */
  border-radius: 8px;
  margin-bottom: 15px;
  background-color: #f1f8ff; /* Light background for contrast */
}

/* For smaller screens, adjust the header for better visibility */
@media (max-width: 768px) {
  header h1 {
    font-size: 1.2rem; /* Slightly smaller font size */
    padding: 8px 15px; /* Adjust padding for mobile */
  }

  h2 {
    font-size: 1.1rem;
    padding: 6px 12px; /* Adjust padding for smaller screens */
  }
}


.verified-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #4caf50;
  color: white;
  font-size: 12px;
  padding: 3px 7px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 2px rgba(0,0,0,0.2);
}


/* Photo Section */
.soulmate-photo img {
  border-radius: 8px;
  object-fit: cover;
  max-height: 200px;
  width: 100%;
}

/* Header Section (Name and Title) */
.soulmate-details h3 {
  color: #ffffff; /* White text for the name */
  font-size: 1.2em;
  background-color: #00796b; /* Green background for the name header */
  padding: 8px;
  border-radius: 8px;
  margin: 0;
  text-align: center;
}

/* Text Details Styling */
.soulmate-details p {
  margin-bottom: 5px;
  color: #333; /* Dark text color for clarity */
}

/* Contact Actions */
.contact-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.contact-actions a {
  color: #2196f3; /* Blue color for the phone/whatsapp links */
  text-decoration: none;
}

.contact-actions button {
  padding: 8px 12px;
  border-radius: 5px;
  cursor: pointer;
  background-color: #673ab7; /* Purple color for buttons */
  color: white;
  border: none;
  transition: background-color 0.3s ease;
}

.contact-actions button:hover {
  background-color: #5e35b1; /* Slightly darker purple on hover */
}

/* Rating Section */
.rating {
  margin-top: 10px;
}

.rating .fas {
  cursor: pointer;
  color: #ccc;
}

.rating .avg-rating {
  font-size: 1.1em;
  color: #00796b; /* Green color for the average rating */
}

/* Background Color Variations (Optional) */
.soulmate-card:nth-child(odd) {
  background-color: #e0f7fa; /* Light cyan for odd cards */
}

.soulmate-card:nth-child(even) {
  background-color: #f1f8e9; /* Light green for even cards */
}

.soulmate-details p {
  margin-bottom: 5px;
  color: #333; /* Dark text color */
  display: flex;
  align-items: center;
}

.soulmate-details p i {
  margin-right: 8px; /* Space between icon and text */
  color: #00796b; /* Color for the icons */
}

.soulmate-details h3 {
  font-size: 1.2em;
  display: flex;
  align-items: center;
}

.soulmate-details h3 i {
  margin-right: 8px;
}

.contact-actions button {
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  background-color: #673ab7;
  color: white;
  border: none;
}

.contact-actions a {
  color: #2196f3;
  text-decoration: none;
}
/* Highlight occupation with red background */
.highlight-occupation {
  color: red; /* Red text */
  font-weight: bold; /* Bold text */
  background-color: #ffebee; /* Light red background */
  padding: 4px; /* Padding to give space around the text */
  border-radius: 4px; /* Rounded corners */
}

.service-card {
  scroll-snap-align: start;
  padding: 20px;
  background: #f0f8ff; /* Light blue background */
  border: 1px solid #ccc;
  border-radius: 10px;
  min-height: 170px;
  width: 100%; /* ✅ Makes it fill available grid column */
  box-sizing: border-box; /* ✅ Includes padding in width */
  box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease; /* Optional: smooth hover effect */
}

/* Service Details */
.service-details {
  font-size: 1em;
}

.service-details p {
  margin-bottom: 5px;
  display: flex;
  align-items: center;
}

.service-details i {
  margin-right: 8px; /* Space between icon and text */
}

/* Contact Buttons */
.contact-actions a {
  color: #2196f3;
  text-decoration: none;
}

.contact-actions button {
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  background-color: #673ab7;
  color: white;
  border: none;
}

.contact-actions button:hover {
  background-color: #5e35b1;
}

/* Rating Stars */
.rating .fas {
  cursor: pointer;
  color: #ccc;
}
/* Highlight occupation with red background */
.highlight-occupation {
  color: red; /* Red text */
  font-weight: bold; /* Bold text */
  background-color: #ffebee; /* Light red background */
  padding: 4px; /* Padding to give space around the text */
  border-radius: 4px; /* Rounded corners */
}

/* Contact Buttons */
.contact-actions a {
  color: #2196f3;
  text-decoration: none;
}

.contact-actions button {
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  background-color: #673ab7;
  color: white;
  border: none;
}

.contact-actions button:hover {
  background-color: #5e35b1;
}

/* Rating Stars */
.rating .fas {
  cursor: pointer;
  color: #ccc;
}
.verified-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background-color: #e6f2ff;
  color: #007bff;
  font-weight: bold;
  font-size: 0.85em;
  padding: 4px 8px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}
 nav ul {
  list-style: none;
  padding: 0;
  margin: 0 auto;
  max-width: 1000px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px;
  justify-content: center;
}

nav ul li {
  text-align: center;
}

.menu-box {
  display: block;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 16px 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  text-decoration: none;
  color: #333;
}

.menu-box:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.menu-box img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  margin-bottom: 8px;
}

.menu-box span {
  display: block;
  font-size: 14px;
  font-weight: 600;
  margin-top: 4px;
}

/* Notification badge */
#notifBadge {
  display: none;
  background: red;
  color: white;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 11px;
  position: absolute;
  top: -5px;
  right: -5px;
}
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

.alert {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #4CAF50;
  color: white;
  padding: 15px;
  border-radius: 5px;
  text-align: center;
  z-index: 1000;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
}
.chat-item {
  display: flex;
  align-items: center;
  background: #ffffff;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.chat-item:hover {
  background: #f7f7f7;
}

.chat-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #d5d5d5;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #333;
  font-weight: bold;
  font-size: 20px;
  margin-right: 14px;
  overflow: hidden;
}

.chat-item-content {
  flex: 1;
}

.chat-name {
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.chat-last-message {
  font-size: 14px;
  color: #666;
  margin-top: 4px;
}

.chat-timestamp {
  font-size: 12px;
  color: #999;
  margin-top: 4px;
}

.chat-badge {
  background: #e53935;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  position: absolute;
  right: 12px;
  top: 12px;
}
.blurred-number {
  filter: blur(5px);
  color: gray;
  cursor: pointer;
  user-select: none;
}
@keyframes popFade {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.4); opacity: 0.8; }
  100% { transform: scale(1.8); opacity: 0; }
}
.like-button {
  background: #f0f2f5;
  border: 1px solid #ccc;
  border-radius: 20px;
  font-size: 16px;
  padding: 4px 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.like-button.liked {
  background: #1877f2;
  color: white;
  border-color: #1877f2;
}
@keyframes floatUp {
  to {
    transform: translateY(-120vh) rotate(360deg);
    opacity: 0;
  }
}
.custom-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
}

.custom-modal-content {
  background: linear-gradient(to right, #fdfbfb, #ebedee);
  border-radius: 12px;
  padding: 25px 30px;
  text-align: center;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  position: relative;
  animation: fadeIn 0.4s ease;
}

.custom-modal-content h2 {
  color: #2196f3;
  margin-bottom: 12px;
}

.custom-modal-content p {
  color: #444;
  margin-bottom: 20px;
}

.custom-close-btn {
  position: absolute;
  top: 10px;
  right: 14px;
  font-size: 24px;
  color: #f44336;
  cursor: pointer;
}

.pay-now-btn {
  background: #4CAF50;
  color: white;
  font-size: 16px;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.pay-now-btn:hover {
  background: #388e3c;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}
  .scrolling-banner {
    background-color: #fff3e0;
    border-bottom: 2px solid #ff7043;
    overflow: hidden;
    position: relative;
    white-space: nowrap;
    height: 40px;
    display: flex;
    align-items: center;
  }

  .scrolling-banner-content {
    display: inline-block;
    white-space: nowrap;
    padding-left: 120%;
    animation: scrollRight 100s linear infinite; /* ⬅️ Slower scroll */
    font-weight: bold;
    color: #d84315;
    font-size: 18px;
  }

  @keyframes scrollRight {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }
.scrolling-banner-content:hover {
  animation-play-state: paused;
}
/* 🔄 Spinner Fix (in case Font Awesome didn’t load properly) */
.fa-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* 🎨 Trending Highlight Animation */
.trending-highlight {
  background: #fffde7;
  border: 2px solid #ff9800;
  border-radius: 10px;
  padding: 10px;
  animation: glowPulse 1.8s ease-in-out infinite;
  box-shadow: 0 0 10px rgba(255, 152, 0, 0.4);
  margin-bottom: 12px;
}

@keyframes glowPulse {
  0% {
    box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
  }
  50% {
    box-shadow: 0 0 20px rgba(255, 152, 0, 0.6);
  }
  100% {
    box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
  }
}
.stars-container {
  display: flex;
  gap: 5px;
  cursor: pointer;
}

.star {
  font-size: 30px;
  color: #ddd;
}

.star:hover {
  color: gold;
}

.star.selected {
  color: gold;
}
.photo-container {
    position: relative;
    width: 200px;
    text-align: center;
    background-color: #f8f8f8;
    border-radius: 10px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 320px;
  }

  .photo-container img {
    width: 100%;
    height: 150px;
    object-fit: cover;
  }

  .buy-button {
    position: relative;
    margin-top: 10px;
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    margin-top: auto;
  }

  .photo-container:hover img {
    filter: blur(5px);
  }

  /* Modal Styles */
  #imageModal {
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  #buyNowButton {
    display: block;
  }

  #downloadButton {
    display: none; /* Hidden until after payment */
  }
/* Style for the logged-in user display */
#loggedInUser {
  text-align: center;
  margin-top: 10px;
  font-size: 18px;
  font-weight: bold;
}

#loggedInUser button {
  padding: 4px 8px;
  border: none;
  border-radius: 5px;
  background: red;
  color: white;
  cursor: pointer;
}

#loggedInUser button:hover {
  background: darkred; /* Darker color on hover */
}

/* Additional Header Styling */
header {
  background-color: #4CAF50;
  padding: 15px;
  text-align: center;
  position: relative;
}
/* Header container style */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
}

/* Left and Right Image Style */
header img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 50%; /* Circular images */
}

/* Logged-in user section styling */
#loggedInUser {
  text-align: center;
  font-weight: bold;
  color: white;
  margin-top: 10px;
}

/* Advertisement styling inside the header */
header p {
  font-size: 14px;
  color: white;
  margin-top: 10px;
}

/* Sponsored ad link style */
header a {
  color: #007bff;
  font-weight: bold;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  header {
    flex-direction: column; /* Stack header items vertically on smaller screens */
    align-items: center;
  }

  header img {
    width: 40px;
    height: 40px;
  }

  #loggedInUser {
    font-size: 14px;
  }

  header p {
    font-size: 12px;
  }

  header a {
    font-size: 12px;
  }
}
#alertsContainer {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px;
  max-height: 400px;
  overflow-y: auto;
  background: #e8f5e9; /* pale green */
  border: 2px solid #4CAF50;
  border-radius: 10px;
}
.alert-box {
  background: #ffffff;
  border: 2px solid #4CAF50;
  padding: 12px 16px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  font-size: 15px;
  color: #333;
}
#alertsContainer::-webkit-scrollbar {
  width: 6px;
}
#alertsContainer::-webkit-scrollbar-thumb {
  background-color: #4CAF50;
  border-radius: 10px;
}

  .likes-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .likes-modal-content {
    background: #fff;
    padding: 15px 20px;
    border-radius: 6px;
    width: 80%;
    max-width: 300px; /* Reduced width */
    max-height: 75%;
    overflow-y: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    text-align: center;
    font-size: 14px; /* Smaller text */
  }

  .likes-modal-close {
    position: absolute;
    right: 18px;
    top: 12px;
    font-size: 24px;
    cursor: pointer;
    color: #666;
  }

  #likesList {
    list-style: none;
    padding: 0;
    margin: 12px 0 0;
    text-align: left;
    font-size: 13px; /* Smaller list text */
  }

  #likesList li {
    padding: 6px;
    border-bottom: 1px solid #eee;
  }
  .alert-card {
    position: relative;
    background: #f9f9f9;
    border-left: 4px solid #007bff;
    padding: 10px 15px;
    margin: 10px 0;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .dots-btn {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
  }

  .dropdown {
    position: relative;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background-color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    padding: 5px;
    border-radius: 4px;
    z-index: 1000;
  }

  .dropdown-content button {
    background: none;
    border: none;
    padding: 5px 10px;
    width: 100%;
    text-align: left;
    cursor: pointer;
  }

  .dropdown-content button:hover {
    background-color: #f0f0f0;
  }
  #loadingSpinner {
    display: flex;
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
    z-index: 9999;
  }
  .spinner-container {
    text-align: center;
    padding: 30px;
  }
  .spinner {
    font-size: 36px;
    color: #ff5722;
  }
  .spinner-text {
    color: #666;
    font-weight: bold;
    margin-top: 10px;
  }
</style>


</head>
<body>
<header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-image: url('https://i.imgur.com/6kuZECC.jpeg'); background-size: cover; background-position: center;">

  <!-- Left Image -->
  <img src="https://i.imgur.com/pdTgJX3.jpeg" alt="Left Image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">

  <!-- Header Content -->
  <div style="flex-grow: 1; text-align: center;">
    <h1 style="color: white; font-weight: bold; display: flex; align-items: center; gap: 10px; justify-content: center;">
      <i class="fas fa-star"></i>
      Nyota Mtaani – Teacher Swaps & Daily Hustles
    </h1>

    <!-- Display logged-in user and logout button inside the header -->
    <div id="loggedInUser" style="text-align:center; margin-top:10px; color: white;"></div>

    <!-- Advertisement inside the header -->
    <p style="font-size: 14px; color: white; margin-top: 10px;">
      📢 Advertise your service here! 
      <a href="https://wa.me/254792755676" target="_blank" style="color: #007bff; font-weight: bold;">Call 0792755676</a>
    </p>
  </div>

  <!-- Right Image -->
  <img src="https://i.imgur.com/ZubSv7f.jpeg" alt="Right Image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">



</header>



<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 From Village to City — Your Swap, Your Way: County Moves, Mtaani Vibes,All Jobs, Market,Soulmate,Services & Swapsu | 📦 To Book This Space call 0792755676 | 📱 All in One Spot on Kenya’s #1 Nyota Platform for People Making Big Transitions | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>
<div id="loggedInUser" style="position:absolute; top:15px; right:20px; color:white; font-weight:bold;"></div>
<nav style="background-image: url('https://i.imgur.com/JCxt71v.jpeg'); background-size: cover; background-position: center; padding: 20px 20px;">

  
  <ul>
  <!-- Core Navigation -->
  <li><a class="menu-box" href="#" onclick="showPage('home')">
    <img src="https://i.imgur.com/lek58ah.jpeg" alt="Home">
    <span>Home</span></a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('login')">
    <img src="https://i.imgur.com/TsXskJc.jpeg" alt="Login">
    <span>Login</span></a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('register')">
    <img src="https://i.imgur.com/jKZaOkH.jpeg" alt="Register">
    <span>Register</span></a>
  </li>

  <!-- Notifications & Alerts -->
  <li>
    <a class="menu-box" href="#" onclick="showPage('notifications')" style="position: relative;">
      <img src="https://i.imgur.com/PBto8RH.jpeg" alt="Notifications">
      <span>Admin Notifications</span>
      <span id="notifBadge">0</span>
    </a>
  </li>

  <li>
    <a class="menu-box" href="#" onclick="loadAlerts()" style="position: relative;">
      <img src="https://i.imgur.com/IvZc6We.jpeg" alt="Alerts">
      <span>Alerts</span>
      <span id="alertsBadge" style="
        display:none;
        background:#f44336;
        color:white;
        font-size:12px;
        padding:2px 6px;
        border-radius:50%;
        position:absolute;
        top:0;
        right:0;
        font-weight:bold;
        min-width:18px;
        text-align:center;
      ">0</span>
    </a>
  </li>

  <li>
    <a class="menu-box" href="#" onclick="openMessagesPage()" style="position:relative;">
      <img src="https://i.imgur.com/XBAeDCN.jpeg" alt="Messages">
      <span>Messages</span>
      <span id="messagesUnreadBadge" style="display:none; background:red; color:white; border-radius:50%; padding:2px 6px; font-size:11px; position:absolute; top:0; right:0;"></span>
    </a>
  </li>

  <!-- Main Features -->
  <li><a class="menu-box" href="#" onclick="showPage('bomJobs')">
    <img src="https://i.imgur.com/8KM6Rib.jpeg" alt="Jobs">
    <span>My Jobs</span></a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('swaps')">
    <img src="https://i.imgur.com/iqBwsWm.png" alt="Swaps">
    <span>View Swaps</span></a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('seekingServices')">
    <img src="https://i.imgur.com/P1tHi7L.jpeg" alt="Services">
    <span>Services</span></a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('market')">
    <img src="https://i.imgur.com/P1MIsGM.jpeg" alt="Market">
    <span>Market</span></a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('soulmates')">
    <img src="https://i.imgur.com/FJjbSK9.jpeg" alt="Soulmate">
    <span>Soulmate</span></a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('resources')">
    <img src="https://i.imgur.com/GavIBlL.jpeg" alt="Resources">
    <span>Resources</span></a>
  </li>



  <li><a class="menu-box" href="#" onclick="showPage('trendingSection'); loadTrendingItems();">
    <img src="https://i.imgur.com/SjtDlJi.jpeg" alt="Trending">
    <span>🔥 Trending</span></a>
  </li>

  <!-- Help & Contact -->
  <li><a class="menu-box" href="#" onclick="showPage('usageHelp')">
    <img src="https://i.imgur.com/tHuRu3z.jpeg" alt="Help">
    <span>📘 How to Use</span></a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('contact')">
    <img src="https://i.imgur.com/SPqGvz9.jpeg" alt="Contact">
    <span>Contact Us</span></a>
  </li>
</ul>

</nav>


</header>

<!-- Loading Spinner Container -->
<div id="loadingSpinner" style="display: none;">
  <div class="spinner-container">
    <i class="fas fa-spinner fa-spin spinner"></i>
<p class="spinner-text" style="color: red;">Nyota</p>

  </div>
</div>

<!-- Custom Alert Modal -->
<div id="customAlert" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="custom-alert-content" style="background: white; padding: 20px; max-width: 400px; margin: auto; border-radius: 8px; text-align: center;">
        <span id="alertMessage" style="font-size: 16px; color: #333;"></span>
        <button onclick="closeCustomAlert()" style="background: #4CAF50; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">
            Close
        </button>
    </div>
</div>
<!-- Loading Spinner -->
<div id="loadingSpinner" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="spinner" style="border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 2s linear infinite;"></div>
</div>
<!-- Likes Modal -->
<div id="likesModal" class="likes-modal-overlay" style="display: none;" onclick="handleBackdropClick(event)">
  <div class="likes-modal-content">
    <span class="likes-modal-close" onclick="closeLikesModal()">&times;</span>
    <h2>❤️ Liked by</h2>
    <ul id="likesList"></ul>
    <button onclick="closeLikesModal()" style="margin-top: 15px; padding: 6px 12px; font-size: 13px; border: none; border-radius: 4px; background-color: #f44336; color: white; cursor: pointer;">
      Close
    </button>
  </div>
</div>
<div id="logoutToast" style="
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #4CAF50;
  color: white;
  padding: 10px 20px;
  border-radius: 5px;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 10000;
">
  ✅ You have been logged out successfully see you again .
</div>
<!-- Modal Structure -->
<div id="followersModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;">
  <div style="background-color: #f7f7f7; padding:20px; width:30%; max-width:400px; max-height:80%; overflow:auto; border-radius:8px; text-align:center; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);">
    <h2 style="color: #333; font-size: 1.5em; margin-bottom: 15px;">Followers</h2>
    <ul id="followersList" style="list-style-type:none; padding:0; margin:0; height:200px; overflow-y:auto; text-align:left; color: #555;">
      <!-- Followers will be listed here -->
    </ul>
    <button onclick="closeFollowersModal()" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">Close</button>
  </div>
</div>
<!-- 🔹 Market Chat Modal -->
<div id="marketChatModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div style="background:white; width:90%; max-width:500px; border-radius:8px; padding:15px; display:flex; flex-direction:column; height:80%;">
    
    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 id="marketChatName" style="margin:0;"></h3>
      <button onclick="closeMarketChat()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px;">Close</button>
    </div>

    <!-- Messages container -->
    <div id="marketChatMessages" style="flex:1; overflow-y:auto; border:1px solid #ccc; border-radius:6px; padding:10px; margin:10px 0;">
      <p style="text-align:center; color:gray;">Loading messages...</p>
    </div>

    <!-- Input area -->
    <div style="display:flex; gap:5px;">
      <input id="marketChatInput" type="text" placeholder="Type your message..." style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
      <button id="marketSendBtn" style="background:#4CAF50; color:white; border:none; padding:8px 15px; border-radius:4px;">Send</button>
    </div>

    <!-- Quick message buttons -->
    <div style="margin-top:8px; display:flex; gap:5px; flex-wrap:wrap;">
      <button onclick="sendMarketQuick('Hello 👋')" style="padding:6px; border:1px solid #ccc; border-radius:4px;">Hello 👋</button>
      <button onclick="sendMarketQuick('I am interested!')" style="padding:6px; border:1px solid #ccc; border-radius:4px;">I am interested!</button>
    </div>

  </div>
</div>








<!-- ✅ How to Use the System Section -->
<div id="usageHelp" class="page" style="display:none; padding: 20px;">
  <h2 style="color:#2196f3; text-align:center;">📘 How to Use the System</h2>
  <div style="max-width:800px;margin:auto;background:#f9f9f9;padding:20px;border-radius:10px;">
    <ul style="line-height:1.7; list-style:none; padding:0;">
      
      <li><a href="#" onclick="showPage('home')"><img src="https://i.imgur.com/lek58ah.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Home</strong></a> – See latest updates, featured jobs, market items, and quick links to other sections.</li>
      
      <li><a href="#" onclick="showPage('login')"><img src="https://i.imgur.com/TsXskJc.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Login</strong></a> – Enter your email and password to access your account. Use “Forgot Password” if needed.</li>
      
      <li><a href="#" onclick="showPage('register')"><img src="https://i.imgur.com/jKZaOkH.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Register</strong></a> – Create a new account by filling in your name, email, and password.</li>
      
      <li><a href="#" onclick="showPage('notifications')"><img src="https://i.imgur.com/PBto8RH.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Admin Notifications</strong></a> – (Admins only) See system updates, reports, and approvals.</li>
      
      <li><a href="#" onclick="loadAlerts()"><img src="https://i.imgur.com/IvZc6We.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Alerts</strong></a> – Notifications when someone shows interest in your listing, follows you, or interacts with your posts.</li>
      
      <li><a href="#" onclick="openMessagesPage()"><img src="https://i.imgur.com/XBAeDCN.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Messages</strong></a> – View and reply to job, market, swap, or service chats. Unread messages are highlighted.</li>
      
      <li><a href="#" onclick="showPage('bomJobs')"><img src="https://i.imgur.com/8KM6Rib.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>My Jobs</strong></a> – Post jobs, view applicants, show interest in other jobs, follow updates, unlock contacts, close/reopen jobs, and leave ratings.</li>
      
      <li><a href="#" onclick="showPage('swaps')"><img src="https://i.imgur.com/iqBwsWm.png" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Swaps</strong></a> – Browse and post swap listings (trade/exchange offers). Contact owners via chat or phone.</li>
      
      <li><a href="#" onclick="showPage('seekingServices')"><img src="https://i.imgur.com/P1tHi7L.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Services</strong></a> – Browse or post services and contact providers directly once unlocked.</li>
      
      <li><a href="#" onclick="showPage('market')"><img src="https://i.imgur.com/P1MIsGM.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Market</strong></a> – Buy or sell products. Use search and filters. Post your own items for sale.</li>
      
      <li><a href="#" onclick="showPage('soulmates')"><img src="https://i.imgur.com/FJjbSK9.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Soulmate</strong></a> – Discover and connect with people for social or personal networking.</li>
      
      <li><a href="#" onclick="showPage('resources')"><img src="https://i.imgur.com/GavIBlL.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Resources</strong></a> – Access useful information, guides, and learning materials.</li>
      
      <li><a href="#" onclick="showPage('trendingSection'); loadTrendingItems();"><img src="https://i.imgur.com/SjtDlJi.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>🔥 Trending</strong></a> – See popular boosted jobs, services, and items. Boost your listing for 7 days to appear here.</li>
      
      <li><a href="#" onclick="showPage('usageHelp')"><img src="https://i.imgur.com/tHuRu3z.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>📘 How to Use</strong></a> – Read this guide anytime to understand all features.</li>
      
      <li><a href="#" onclick="showPage('contact')"><img src="https://i.imgur.com/SPqGvz9.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Contact Us</strong></a> – Reach the admin team via email, phone, or WhatsApp.</li>
      
      <li>💳 <strong>Payments</strong> – Pay via MPESA to unlock job or service contacts, or access premium features like boosting listings.</li>
      
      <li>🚀 <strong>Boost Listings</strong> – Make your job or item appear in the 🔥 Trending section for 7 days.</li>
    </ul>
    <p style="color:#888;font-style:italic;">💡 Tip: Keep your profile updated, check 🔥 Trending daily, and use chat for faster responses.</p>
  </div>
</div>




  
<!-- 🔲 Review Modal -->
<div id="reviewModal" style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;z-index:999;justify-content:center;align-items:center;">
  <div style="background:white;padding:20px;border-radius:8px;max-width:400px;width:90%;position:relative;">
    <h3 style="margin-top:0;">📝 Leave a Review</h3>
    <input type="email" id="reviewEmail" placeholder="Your Email" style="width:100%;margin-bottom:10px;padding:8px;border-radius:5px;border:1px solid #ccc;">
    <textarea id="reviewComment" placeholder="Write your review..." style="width:100%;padding:8px;border-radius:5px;border:1px solid #ccc;"></textarea>
    
    <button onclick="submitReviewFromModal()" style="margin-top:10px;background:#4CAF50;color:#fff;padding:8px 14px;border:none;border-radius:5px;">Submit</button>
    
    <!-- ✅ New Close Button -->
    <button onclick="closeReviewModal()" style="margin-top:10px;background:#f44336;color:#fff;padding:8px 14px;border:none;border-radius:5px;">Close</button>

    <!-- ❌ Top-right corner close icon -->
    <button onclick="closeReviewModal()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:18px;">❌</button>
  </div>
</div>

<div id="allReviewsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:#fff; padding:20px; width:50%; max-width:600px; max-height:80%; overflow:auto; border-radius:10px; position:relative;">
    <span onclick="closeAllReviewsModal()" style="position:absolute; top:10px; right:20px; cursor:pointer; font-weight:bold; font-size:18px;">✖</span>
    <h3>💬 All Reviews</h3>
    <div id="allReviewsContainer" style="margin-top:10px;"></div>
  </div>
</div>

<!-- ✅ Colored Contact Section -->
<div id="contact" class="page" style="display:none; padding: 20px;">
  <div style="max-width:800px; margin:auto; background:#f0f8ff; padding:25px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.05);">
    <h2 style="text-align:center; color:#1976d2;">
      <i class="fas fa-envelope-open-text" style="color:#1976d2; margin-right:8px;"></i> Contact Us
    </h2>
    <p style="font-size:16px;">
      <i class="fas fa-envelope" style="color:#f57c00; margin-right:6px;"></i>
      <strong>Email:</strong> support@Nyotakenya.com

    <p style="font-size:16px;">
      <i class="fas fa-phone" style="color:#009688; margin-right:6px;"></i>
      <strong>Phone 2:</strong> +254 792 755 676
    </p>
    <p style="font-size:16px;">
      <i class="fab fa-facebook" style="color:#1877f2; margin-right:6px;"></i>
      <strong>Facebook:</strong> <a href="#" style="color:#1877f2;">Visit Page</a>
    </p>
    <p style="font-size:16px;">
      <i class="fab fa-youtube" style="color:#ff0000; margin-right:6px;"></i>
      <strong>YouTube:</strong> <a href="#" style="color:#ff0000;">Visit Channel</a>
    </p>
    <p style="font-size:16px;">
      <i class="fab fa-telegram" style="color:#0088cc; margin-right:6px;"></i>
      <strong>Telegram:</strong> <a href="#" style="color:#0088cc;">Join Group</a>
    </p>
  </div>
</div>
<section id="trendingSection" style="display: none; padding: 16px;">
  <h2 style="color: #ff5722; margin-bottom: 16px; text-align: center;">🔥 Trending Now</h2>
  <div id="trendingContainer" style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; align-items: center; width: 100%;">
    <!-- Trending items (cards) will appear here -->
  </div>
</section>

</div>
</div>



  <main id="content">
<div id="home" class="page" style="display: none;">
  <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0;">
  <img src="https://i.imgur.com/ld8vrze.jpeg" alt="Rasm" class="logo-img" style="width: 200px;">
  <img src="https://i.imgur.com/JTvf2AF.jpeg" alt="Rasm" class="logo-img" style="width: 200px;">
</div>
<h2>
  <i class="fas fa-users" style="color:#3f51b5; margin-right: 8px;"></i>
  📢 Advertise your service here! 
  <a href="https://wa.me/254792755676" target="_blank" style="text-decoration: none;">Click Here To Chat 0792755676</a>
</h2>
<!-- Open Graph Meta Tags for social sharing -->
<meta property="og:title" content="Teacher Swaps Kenya" />
<meta property="og:description" content="Find your perfect teacher swap match across Kenya!" />
<meta property="og:image" content="https://i.imgur.com/WKwJ73A.jpeg" />
<meta property="og:url" content="https://rasmtech.github.io/Kenya-Nairobi-teachers-swaps/" />
<meta property="og:type" content="website" />

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Teacher Swaps Kenya" />
<meta name="twitter:description" content="Find your perfect teacher swap match across Kenya!" />
<meta name="twitter:image" content="https://i.imgur.com/WKwJ73A.jpeg" />
   </div>
    <div id="register" class="page" style="display:none;">
   <h2>
  <i class="fas fa-user-shield" style="color:#f44336; margin-right: 8px;"></i>
  Register
</h2>

      <form id="registerForm">
        <label for="name">Name:</label>
        <input type="text" id="name" required />
        <label for="email">Email:</label>
        <input type="email" id="email" required />
        <label for="password">Password:</label>
        <input type="password" id="password" required />
 <button type="submit">
  <i class="fas fa-user-plus" style="margin-right: 6px; color: #ffffff;"></i> Register
</button>

      </form>
    </div>
    <div id="login" class="page" style="display:none;">
    <h2>
  <i class="fas fa-sign-in-alt" style="color:#2196f3; margin-right: 8px;"></i>
  Login
</h2>
<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>
   <!-- Login Form -->
<form id="loginForm" onsubmit="loginUser(event)">
    <label for="loginEmail">Email:</label>
    <input type="email" id="loginEmail" required />
    <label for="loginPassword">Password:</label>
    <input type="password" id="loginPassword" required />
    <button type="submit">
        <i class="fas fa-sign-in-alt" style="margin-right: 6px; color: #ffffff;"></i> Login
    </button>

<!-- Forgot Password Link with Icon -->
<div style="text-align: center; margin-top: 10px;">
    <a href="#" onclick="showPasswordReset()" style="text-decoration: none; color: #2196F3; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-key" style="margin-right: 8px; color: #2196F3;"></i> Forgot Password?
    </a>
</div>

</form>

<!-- Password Reset Request Form (Shown when 'Forgot Password?' is clicked) -->
<div id="resetRequestForm" style="display: none;">
    <h2>Forgot Password?</h2>
    <form onsubmit="sendResetLink(event)">
        <label for="email">Enter your email address:</label>
        <input type="email" id="resetEmail" required />
        <button type="submit">Send Reset Link</button>
    </form>
    <p style="text-align: center; margin-top: 10px;">
        <a href="#" onclick="hidePasswordReset()">Back to Login</a>
    </p>
</div>

<!-- Password Reset Form (Shown after user clicks the reset link in their email) -->
<div id="resetPasswordForm" style="display: none;">
    <h2>Reset Your Password</h2>
    <form onsubmit="resetPassword(event)">
        <label for="newPassword">New Password:</label>
        <input type="password" id="newPassword" required />
        <label for="confirmPassword">Confirm Password:</label>
        <input type="password" id="confirmPassword" required />
        <button type="submit">Reset Password</button>
    </form>
    <p style="text-align: center; margin-top: 10px;">
        <a href="#" onclick="hidePasswordReset()">Back to Login</a>
    </p>
</div>

      </form>
    </div>
    <div id="swaps" class="page" style="display:none;">
 <h2>
  <i class="fas fa-exchange-alt" style="color:#ff9800; margin-right: 8px;"></i>
  Register Your Swap Here
</h2>

<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>
      <form id="swapForm">
        <label for="teacherName">Teacher's Name:</label>
        <input type="text" id="teacherName" required />
        <label for="phone">Phone Number:</label>
        <input type="tel" id="phone" required />
        <label for="subjectCombination">Subject Combination:</label>
        <input type="text" id="subjectCombination" required />
        <label for="county">Current County:</label>
        <select id="county" required></select>
<label for="subCounty">Current Sub-county:</label>
<select id="subCounty" required>
  <option value="">Select Sub-county</option>
</select>
        <label for="swapCounty">Swap County To:</label>
        <select id="swapCounty" required></select>
        <label for="category">Category:</label>
        <select id="category" required>
          <option value="">Select Category</option>
          <option value="Primary School">Primary School Swaps</option>
          <option value="Junior Secondary">Junior Secondary Swaps</option>
          <option value="Senior Secondary">Senior Secondary Swaps</option>
        </select>
        <label for="hardship">Hardship:</label>
        <select id="hardship" required>
          <option value="Without Hardship">Without Hardship</option>
          <option value="With Hardship">With Hardship</option>
        </select>
 <button type="submit">
  <i class="fas fa-plus-circle" style="margin-right: 6px; color: #ffffff;"></i> Add Swap
</button>

 </form>



<h3><i class="fas fa-filter" style="color:#43a047; margin-right: 8px;"></i> Filter Swaps</h3>
<!-- ✅ Horizontal Compact Filter Box with Black Labels -->
<div style="border: 2px solid #c8e6c9; background: #f1f8e9; padding: 12px; border-radius: 10px; margin-bottom: 16px; max-width: 1000px; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;">

  <!-- Category -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select id="filterCategory"
      style="width: 160px; background-color: #e0f7fa; border: 2px solid #26a69a; padding: 4px; border-radius: 6px; font-weight: bold;">
      <option value="">All</option>
      <option value="Primary School">Primary School</option>
      <option value="Junior Secondary">Junior Secondary</option>
      <option value="Senior Secondary">Senior Secondary</option>
    </select>
    <label for="filterCategory" style="margin-top: 2px; font-size: 13px; color: black; font-weight: 500;">Category</label>
  </div>

  <!-- Swap County -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select id="filterSwapCounty" onchange="handleCountyChange('filterSwapCounty', 'filterSwapSubCounty')"
      style="width: 160px; background-color: #e1f5fe; border: 2px solid #039be5; padding: 4px; border-radius: 6px; font-weight: bold;">
    </select>
    <label for="filterSwapCounty" style="margin-top: 2px; font-size: 13px; color: black; font-weight: 500;">Swap County</label>
  </div>

  <!-- Swap Sub-county -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select id="filterSwapSubCounty"
      style="width: 160px; background-color: #f3e5f5; border: 2px solid #9c27b0; padding: 4px; border-radius: 6px; font-weight: bold;">
      <option value="">All Sub-counties</option>
    </select>
    <label for="filterSwapSubCounty" style="margin-top: 2px; font-size: 13px; color: black; font-weight: 500;">Swap Sub-county</label>
  </div>

  <!-- Hardship -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select id="filterHardship"
      style="width: 160px; background-color: #fff3e0; border: 2px solid #fb8c00; padding: 4px; border-radius: 6px; font-weight: bold;">
      <option value="">All</option>
      <option value="With Hardship">With Hardship</option>
      <option value="Without Hardship">Without Hardship</option>
    </select>
    <label for="filterHardship" style="margin-top: 2px; font-size: 13px; color: black; font-weight: 500;">Hardship</label>
  </div>

  <!-- Subject -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <input type="text" id="filterSubjectCombination" placeholder="e.g. Math/Physics"
      style="width: 160px; background-color: #f1f8e9; border: 2px solid #8bc34a; padding: 4px; border-radius: 6px; font-weight: bold;" />
    <label for="filterSubjectCombination" style="margin-top: 2px; font-size: 13px; color: black; font-weight: 500;">Subject</label>
  </div>

  <!-- 🔘 Horizontal Buttons -->
  <div style="display: flex; flex-direction: row; align-items: center; gap: 10px; margin-top: 10px;">
    <button onclick="filterSwaps()" style="padding: 6px 12px; background: #43a047; color: white; border: none; border-radius: 6px; cursor: pointer;">
      <i class="fas fa-filter" style="margin-right: 6px;"></i> Filter Swaps
    </button>

    <button onclick="resetSwapFilters()" style="padding: 6px 12px; background: #c62828; color: white; border: none; border-radius: 6px; cursor: pointer;">
      <i class="fas fa-times-circle" style="margin-right: 6px;"></i> Reset
    </button>
  </div>
</div>

<!-- ✅ Active Filters Display -->
<div id="activeFilters" style="margin: 10px auto 20px auto; max-width: 900px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;"></div>

<!-- ✅ End Vertical Action Box -->

<!-- ✅ Compact Action Box Wrapper End -->

<!-- ✅ Action Box Wrapper End -->

<h3>
  <i class="fas fa-people-arrows" style="color:#ff9800; margin-right: 8px;"></i>
  Registered Swaps
</h3>
<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>
<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>
<!-- 🔥 VIP Swaps Modal -->
<div id="vipSwapsModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; max-height:80%; overflow:auto; background:white; padding:20px; border:2px solid crimson; border-radius:10px; z-index:9999; box-shadow:0 0 12px rgba(0,0,0,0.3);">
  <h3 style="color:crimson;">🔥 Available VIP Swaps</h3>
  <div id="vipSwapsList"></div>
  <div style="text-align:right; margin-top:15px;">
    <button onclick="document.getElementById('vipSwapsModal').style.display='none'" style="padding:6px 12px; background:#ccc; border:none; border-radius:5px;">Close</button>
  </div>
</div>
<div id="swapCardContainer" style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; margin-top: 16px;">
  <!-- Swap cards will be dynamically injected here by loadSwaps() -->
</div>
</div>


<div id="bomJobs" class="page" style="display:none;">
<h2>
  <i class="fas fa-briefcase" style="color:#6f42c1; margin-right: 8px;"></i>
  Post Any Job Opportunity Here
</h2>
<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>
<!-- 🔁 Flex container -->
<div class="form-wrapper">
  
  <!-- Left Image -->
  <div class="side-image">
 <img src="https://i.imgur.com/5bWHfIX.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/2YaRtCe.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/y4n1NSY.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/kKIs8rW.jpeg " alt="Left Side" class="side-image" />

  </div>

  <!-- The Form -->
  <form id="bomJobForm">
    <label for="bomOrg">Organization Name:</label>
    <input type="text" id="bomOrg" placeholder="e.g. Nyakemincha High School" required />

    <label for="bomJobType">Type of Job Opportunity:</label>
    <input type="text" id="bomJobType" placeholder="e.g. Teaching, Security, Cook" required />

    <label for="bomPhone">Contact (Phone Number):</label>
    <input type="tel" id="bomPhone" placeholder="e.g. 0712345678" required />

    <label for="bomSubCounty">Sub-county:</label>
    <select id="bomSubCounty" required>
      <option value="">Select Sub-county</option>
    </select>

    <label for="bomCounty">County:</label>
    <select id="bomCounty" required>
      <option value="">Select County</option>
    </select>

    <label for="bomSalaryRange">Expected Salary Range (Ksh):</label>
    <input type="text" id="bomSalaryRange" placeholder="e.g. 15000 - 25000" required />

    <label for="bomDate">Date Posted:</label>
    <input type="text" id="bomDate" readonly />

    <label for="bomPostedBy">Posted By (Name or Email):</label>
    <input type="text" id="bomPostedBy" placeholder="e.g. sironga@example.com" readonly />

    <button type="submit">
      <i class="fas fa-briefcase" style="margin-right: 6px; color: #ffffff;"></i>
      Post Job
    </button>
  </form>

  <!-- Right Image -->
  <div class="side-image">
   <img src="https://i.imgur.com/lIZ1IQi.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/XRks66A.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/KdsEBmH.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/rXTm8kr.jpeg " alt="Left Side" class="side-image" />

  </div>

</div>


<!-- 📦 BOM Filter Action Box -->
<div style="border: 2px solid #c8e6c9; background: #f1f8e9; padding: 12px; border-radius: 10px; margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-start;">

  <!-- County Filter -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select
      id="filterCounty"
      onchange="handleCountyChange('filterCounty', 'filterSubCounty')"
      style="width: 160px; background-color: #e3f2fd; border: 2px solid #42a5f5; padding: 6px; border-radius: 6px; font-weight: bold;"
    >
      <option value="">All Counties</option>
    </select>
    <label for="filterCounty" style="margin-top: 2px; font-size: 13px; color: #1565c0;">County</label>
  </div>

  <!-- Sub-county Filter -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select
      id="filterSubCounty"
      style="width: 160px; background-color: #ede7f6; border: 2px solid #7e57c2; padding: 6px; border-radius: 6px; font-weight: bold;"
    >
      <option value="">All Sub-counties</option>
    </select>
    <label for="filterSubCounty" style="margin-top: 2px; font-size: 13px; color: #512da8;">Sub-county</label>
  </div>

  <!-- Salary Filter -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <input
      type="number"
      id="filterSalary"
      placeholder="Min Salary (Ksh)"
      style="width: 160px; background-color: #fffde7; border: 2px solid #fbc02d; padding: 6px; border-radius: 6px; font-weight: bold;"
    />
    <label for="filterSalary" style="margin-top: 2px; font-size: 13px; color: #f57f17;">Min Salary</label>
  </div>

  <!-- Apply Filters Button -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <button
      onclick="applyBOMFilters()"
      style="width: 160px; padding: 8px; background-color: #43a047; color: white; font-weight: bold;
             border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
      <i class="fas fa-filter"></i> Apply Filters
    </button>
    <label style="visibility: hidden;">&nbsp;</label>
  </div>

</div>

<!-- Confirm Delete Modal -->
<div id="confirmDeleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999;">
  <div style="background:white; padding:20px; border-radius:8px; text-align:center;">
    <p>Are you sure you want to delete this  job?</p>
    <button id="confirmDeleteBtn" style="margin: 5px;">Yes, Delete</button>
    <button onclick="closeDeleteModal()" style="margin: 5px;">Cancel</button>
  </div>
</div>
<h3>
  <i class="fas fa-clipboard-list" style="color:#6f42c1; margin-right: 8px;"></i>
  Available Job Opportunities
</h3>
<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>
<div id="jobContainer" style="
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  width: 100%;               /* Fill full width of screen */
  padding: 10px 20px;        /* Optional horizontal padding */
  margin-top: 20px;
  overflow-y: auto;
  max-height: 600px;         /* Increase height to show more rows */
  scroll-snap-type: y mandatory;
  box-sizing: border-box;
">
  <!-- Example job cards -->
  <div style="background: #f1f1f1; padding: 15px; border-radius: 8px;">Job 1</div>
  <div style="background: #f1f1f1; padding: 15px; border-radius: 8px;">Job 2</div>
  <div style="background: #f1f1f1; padding: 15px; border-radius: 8px;">Job 3</div>
  <div style="background: #f1f1f1; padding: 15px; border-radius: 8px;">Job 4</div>
  <div style="background: #f1f1f1; padding: 15px; border-radius: 8px;">Job 5</div>
</div>


</div>
<div id="resources" class="page" style="display:none;">
<h2>
  <i class="fas fa-upload" style="color:#4CAF50; margin-right: 8px;"></i>
  Upload Teaching Resources
</h2>

 <div class="form-container">
  <img src="  https://i.imgur.com/x9v3Czl.jpeg" alt="Left Side" class="side-image" />

  <form id="resourceForm">
    <label for="resourceTitle">Title:</label>
    <input type="text" id="resourceTitle" required />

    <label for="resourcePrice">Price (Ksh):</label>
    <input type="number" id="resourcePrice" required />

    <label for="resourceFile">Upload File:</label>
    <input type="file" id="resourceFile" accept=".pdf,.doc,.docx,.ppt,.pptx" required />

    <button type="submit">
      <i class="fas fa-upload"></i> Upload Resource
    </button>
  </form>

  <img src="   https://i.imgur.com/ytrul2r.jpeg" alt="Right Side" class="side-image" />
</div>

 <h3>
  <i class="fas fa-book-open" style="color:#3f51b5; margin-right: 8px;"></i>
  Available Resources
</h3>

  <table id="resourcesTable">
    <thead>
      <tr>
        <th>Title</th>
        <th>Price (Ksh)</th>
        <th>Download</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<div id="soulmates" class="page" style="display:none;">
<h3>
  <i class="fas fa-venus-mars" style="color:#e91e63; margin-right: 8px;"></i>
Register To Connect With  Available Soulmates
</h3>
<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>
<div class="form-container">
  <img src="   https://i.imgur.com/pfeMjzi.jpeg " alt="Left Side" class="side-image" />
<img src="   https://i.imgur.com/WKwJ73A.jpeg" alt="Left Side" class="side-image" />
<img src="   https://i.imgur.com/kngaoSj.jpeg" alt="Left Side" class="side-image" />
<img src="   https://i.imgur.com/dlbQbGo.jpeg" alt="Left Side" class="side-image" />
  <form id="soulmateForm">
    <label for="smName">Your Name:</label>
    <input type="text" id="smName" required />

    <label for="smCounty">Home County:</label>
    <select id="smCounty" required></select>

    <label for="smSubCounty">Home Sub-county:</label>
    <select id="smSubCounty" required>
      <option value="">Select Sub-county</option>
    </select>

    <label for="smAge">Age:</label>
    <input type="number" id="smAge" required />

    <label for="smTribe">Tribe:</label>
    <input type="text" id="smTribe" required />

    <label for="smSex">Sex:</label>
    <select id="smSex" required>
      <option value="">Select Sex</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>

    <label for="smOccupation">Occupation:</label>
    <input type="text" id="smOccupation" required />

    <label for="smWorkCounty">Work County:</label>
    <select id="smWorkCounty" required></select>

    <label for="smPhone">Phone Number:</label>
    <input type="tel" id="smPhone" required />

    <label for="smStatus">Marital Status:</label>
    <select id="smStatus" required>
      <option value="">Select Status</option>
      <option value="Single">Single</option>
      <option value="Divorced">Divorced</option>
      <option value="Widowed">Widowed</option>
    </select>

    <label for="smKids">Do you have kids?</label>
    <select id="smKids" required>
      <option value="">Select</option>
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>

 <label for="smPhoto">Upload Photo (optional):</label>
<input type="file" id="smPhoto" accept="image/*" />


    <button type="submit">
      <i class="fas fa-heart"></i> Submit Profile
    </button>
  </form>
   <img src="https://i.imgur.com/mUvDPiM.jpeg " alt="Right Side" class="side-image" />
  <img src="https://i.imgur.com/4pi7IZ6.jpeg " alt="Right Side" class="side-image" />
 <img src="https://i.imgur.com/R0QCWyv.jpeg " alt="Right Side" class="side-image" />
<img src="https://i.imgur.com/dYvavhy.jpeg " alt="Right Side" class="side-image" />


</div>

<!-- ─── FILTER UI ─────────────────────────────────────────────────────────────────── -->
<!-- ─── ACTION BOX ─────────────────────────────────────────────────────────────── -->
<div 
  class="action-box" 
  style="
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 8px;
    background-color: #fafafa;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
  "
>
  <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
    <!-- Age Filter -->
    <label for="ageFilter" style="width: 150px; font-weight: bold; color: #4caf50;">
      Filter by Age:
    </label>
    <select
      id="ageFilter"
      style="width: 150px; background-color: #f0f8ff; border: 1px solid #ccc; padding: 5px; border-radius: 4px;"
    >
      <option value="">All</option>
      <option value="20-29">20–29</option>
      <option value="30-39">30–39</option>
      <option value="40-49">40–49</option>
      <option value="50+">50+</option>
    </select>

    <!-- Tribe Filter -->
    <label for="filterTribe" style="width: 100px; font-weight: bold; color: #4caf50;">
      Tribe:
    </label>
    <input
      type="text"
      id="filterTribe"
      placeholder="e.g. Kikuyu"
      style="width: 120px; background:#f0f8ff; border:1px solid #ccc; padding:5px; border-radius:4px;"
    />

    <!-- Gender Filter -->
    <label for="filterSex" style="width: 100px; font-weight: bold; color: #4caf50;">
      Gender:
    </label>
    <select
      id="filterSex"
      style="width: 120px; background-color: #f0f8ff; border: 1px solid #ccc; padding: 5px; border-radius: 4px;"
    >
      <option value="">All</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>
<select id="sortByLikes" onchange="loadSoulmates()" style="padding:6px;margin:10px 0;">
  <option value="recent">Sort: Most Recent</option>
  <option value="likes">Sort: Most Liked</option>
</select>

    <!-- Actions -->
    <button 
      onclick="loadSoulmates()" 
      style="padding:6px 12px; background:#4caf50; color:#fff; border:none; border-radius:4px; cursor:pointer;"
    >
      Apply Filters
    </button>
    <button 
      onclick="resetSoulmateFilters()" 
      style="padding:6px 12px; background:#f44336; color:#fff; border:none; border-radius:4px; cursor:pointer;"
    >
      Reset
    </button>
  </div>
</div>

<div id="soulmateContainer" style="
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  max-height: 600px;
  overflow-y: auto;
  box-sizing: border-box;
  background: #f9f9f9;
  border-radius: 10px;
">
  <!-- Cards will be dynamically added here -->
</div>

<div id="endOfListMessage" style="
  display: none;
  text-align: center;
  margin-top: 15px;
  font-weight: bold;
  color: #555;
  font-size: 16px;
">
  That's all for now!
</div>

  </div>


<div id="soulmateModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeSoulmateModal()">&times;</span>
    <h3>Soulmate Profile</h3>
    <div id="soulmateDetails">
      <!-- Details will be injected here -->
    </div>
  </div>
</div>

<div id="notifications" class="page" style="display:none;"> 
  <h2>🔔 My Notifications</h2>
  <ul id="notificationList"></ul>
</div>

<div id="alertsContainer" class="page" style="display: none; padding: 20px;">
  <h2>📢 Market Alerts</h2>
  <ul id="alertsList">
    <!-- Alerts will be dynamically added here -->
  </ul>
</div>


<!-- Seeking Services Section -->
<div id="seekingServices" class="page" style="display:none;">
 
<h2 style="display: flex; align-items: center; color: crimson;">
  <i class="fas fa-concierge-bell" style="color:#009688; margin-right: 8px;"></i>
  Post Your Service
</h2>
<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>

 <div class="form-container">
  <img src="https://i.imgur.com/3Bdn0Dx.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/79Aw5LM.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/yw7eeD6.jpeg " alt="Left Side" class="side-image" />
<img src="https://i.imgur.com/D83bieA.jpeg " alt="Left Side" class="side-image" />

<form id="serviceForm" style="max-width:420px;margin:20px auto;padding:20px;background:#f0f4f8;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
  <h2 style="text-align:center;color:#00796b;margin-bottom:16px;">📋 Post a Service</h2>

  <label for="svcName" style="color:#333;font-weight:bold;">Name:</label>
  <input type="text" id="svcName" required style="width:100%;padding:10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:6px;"/>

  <label for="svcCounty" style="color:#333;font-weight:bold;">County:</label>
  <select id="svcCounty" required style="width:100%;padding:10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:6px;"></select>

  <label for="svcSubCounty" style="color:#333;font-weight:bold;">Sub-county:</label>
  <select id="svcSubCounty" required style="width:100%;padding:10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:6px;">
    <option value="">Select Sub-county</option>
  </select>

  <label for="svcOccupation" style="color:#333;font-weight:bold;">Occupation:</label>
  <input type="text" id="svcOccupation" required style="width:100%;padding:10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:6px;"/>

  <label for="svcExperience" style="color:#333;font-weight:bold;">Experience (in years):</label>
  <input type="number" id="svcExperience" required style="width:100%;padding:10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:6px;"/>

  <label for="svcPhone" style="color:#333;font-weight:bold;">Phone Number:</label>
  <input type="tel" id="svcPhone" required style="width:100%;padding:10px;margin:6px 0 18px;border:1px solid #ccc;border-radius:6px;"/>

  <button type="submit" style="width:100%;background:#00796b;color:white;padding:12px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">
    <i class="fas fa-concierge-bell"></i> Submit Service
  </button>
</form>

 <img src="https://i.imgur.com/qUGmfzC.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/V2t9pgK.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/lPPcTF4.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/GHIpXpv.jpeg " alt="Left Side" class="side-image" />
</div>
<h3>
 
<!-- ✅ Services Filter Action Box -->
<div style="border: 2px solid #c8e6c9; background: #f1f8e9; padding: 12px 16px; border-radius: 10px; margin-bottom: 20px;">

  <h3 style="margin-bottom: 12px; color: #2e7d32;"><i class="fas fa-filter" style="margin-right: 6px;"></i> Filter Services</h3>

  <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-start;">

    <!-- County Dropdown -->
    <div style="display: flex; flex-direction: column; align-items: flex-start;">
      <select id="filterServiceCounty"
        onchange="filterServices()"
        style="width: 180px; background-color: #e8f5e9; border: 2px solid #81c784; padding: 6px; border-radius: 6px; font-weight: bold;">
        <option value="">-- Select County --</option>
        <option value="All Kenya">All Kenya</option>
        <!-- Other counties will be dynamically inserted -->
      </select>
      <label for="filterServiceCounty" style="font-size: 13px; color: #388e3c; margin-top: 4px;">County</label>
    </div>

    <!-- Occupation Input -->
    <div style="display: flex; flex-direction: column; align-items: flex-start;">
      <input type="text" id="filterOccupation" placeholder="Search Occupation..."
        onkeyup="filterServices()"
        style="width: 180px; background-color: #f0f8ff; border: 2px solid #64b5f6; padding: 6px; border-radius: 6px; font-weight: bold;" />
      <label for="filterOccupation" style="font-size: 13px; color: #1976d2; margin-top: 4px;">Occupation</label>
    </div>

  </div>
</div>


<h3>
  <i class="fas fa-users-cog" style="color:#00796b; margin-right: 8px;"></i>
 <h3 style="color: crimson;">Available Service Providers</h3>
<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>

<!-- Services Cards Container -->
<div id="servicesContainer" style="
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 30px; /* ✅ Increased gap between cards */
  width: 100%;
  padding: 20px; /* ✅ Adds spacing inside the container */
  margin-top: 20px;
  overflow-y: auto;
  max-height: 600px;
  scroll-snap-type: y mandatory;
  box-sizing: border-box;
">
  <!-- Service cards will be dynamically added here -->
  <!-- Example cards for testing -->
  <div style="
    background: #e6f7ff;
    padding: 20px;             /* ✅ Spacing inside each card */
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Optional for nicer separation */
  ">
    <h4 style="margin: 0 0 10px;">Service 1</h4>
    <p style="margin: 0;">Description goes here.</p>
  </div>

  <div style="
    background: #e6f7ff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  ">
    <h4 style="margin: 0 0 10px;">Service 2</h4>
    <p style="margin: 0;">Description goes here.</p>
  </div>

  <div style="
    background: #e6f7ff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  ">
    <h4 style="margin: 0 0 10px;">Service 3</h4>
    <p style="margin: 0;">Description goes here.</p>
  </div>
  </div>
  </div>
<div id="market" class="page" style="display:none;">
<h2 style="color: crimson;">🛒 Market place - Post & Browse Items</h2>
<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>
<div class="form-container">
   <img src=" https://i.imgur.com/nxHMHAI.jpeg" class="side-image" />
 <img src="https://i.imgur.com/nYPCM6a.jpeg " class="side-image" />
 <img src="https://i.imgur.com/uyloDlg.jpeg " class="side-image" />
 <img src="https://i.imgur.com/CLnRHF4.jpeg" class="side-image" />
  <form id="marketForm">
   <label for="itemName">Item Name</label>
    <input type="text" id="itemName" placeholder="Item Name" required>

    <label for="itemCategory">Category</label>
    <select id="itemCategory" required>
    <option value="">🔽 Select Category</option>

<optgroup label="🏠 Home & Living">
  <option value="HousesApartments">🏠 Houses & Apartments</option>
  <option value="Furniture">🪑 Furniture</option>
  <option value="HomeAppliances">🔌 Home Appliances</option>
  <option value="InteriorDecor">🖼️ Interior Decor</option>
  <option value="Lighting">💡 Lighting</option>
  <option value="Gardening">🪴 Gardening</option>
  <option value="Cleaning">🧼 Cleaning Supplies</option>
  <option value="Art">🎨 Art & Crafts</option>
</optgroup>

<optgroup label="👕 Fashion & Personal">
  <option value="Clothes">👗 Clothes</option>
  <option value="Shoes">👟 Shoes</option>
  <option value="Bags">👜 Bags</option>
  <option value="Jewelry">💍 Jewelry</option>
  <option value="Watches">⌚ Watches</option>
  <option value="Beauty">💄 Beauty</option>
  <option value="Perfumes">🌸 Perfumes & Fragrances</option>
  <option value="TraditionalWear">🧥 Traditional Wear</option>
  <option value="Accessories">🧢 Fashion Accessories</option>
</optgroup>

<optgroup label="📱 Tech & Electronics">
  <option value="Electronics">💻 Electronics</option>
  <option value="Phones">📱 Phones</option>
  <option value="Tablets">📲 Tablets</option>
  <option value="Cameras">📷 Cameras</option>
  <option value="Drones">🛸 Drones</option>
  <option value="Audio">🎧 Audio & Headphones</option>
  <option value="Gaming">🎮 Gaming</option>
  <option value="Software">🧠 Software</option>
  <option value="SmartHome">🏡 Smart Home Devices</option>
</optgroup>

<optgroup label="🚗 Vehicles">
  <option value="Cars">🚗 Cars</option>
  <option value="Motorbikes">🏍️ Motorbikes</option>
  <option value="Bicycles">🚴 Bicycles</option>
  <option value="Trucks">🚚 Trucks</option>
  <option value="Buses">🚌 Buses</option>
  <option value="Marine">⛴️ Marine & Boats</option>
  <option value="VehicleParts">⚙️ Vehicle Parts & Accessories</option>
  <option value="TyresBatteries">🔋 Tyres & Batteries</option>
</optgroup>

<optgroup label="📚 Education & Work">
  <option value="Books">📚 Books</option>
  <option value="Stationery">🖊️ Stationery</option>
  <option value="OfficeSupplies">🗂️ Office Supplies</option>
  <option value="Tutoring">📖 Tutoring Services</option>
  <option value="OnlineCourses">💻 Online Courses</option>
</optgroup>

<optgroup label="🎤 Events & Services">
  <option value="EventServices">🎤 Event Services</option>
  <option value="WeddingSupplies">💒 Wedding Supplies</option>
  <option value="PhotographyServices">📸 Photography & Video</option>
  <option value="RepairConstruction">🛠️ Repair & Construction</option>
  <option value="Security">🛡️ Security & Safety</option>
  <option value="Energy">⚡ Energy & Solar</option>
  <option value="CourierDelivery">📦 Courier & Delivery</option>
  <option value="PrintingBranding">🖨️ Printing & Branding</option>
</optgroup>

<optgroup label="🧸 Lifestyle & Leisure">
  <option value="Toys">🧸 Toys</option>
  <option value="Sports">🏀 Sports</option>
  <option value="LeisureActivities">🏖️ Leisure & Activities</option>
  <option value="Travel">🧳 Travel</option>
  <option value="MusicalInstruments">🎸 Musical Instruments</option>
  <option value="BooksMagazines">📰 Magazines & Comics</option>
  <option value="Collectibles">🗿 Collectibles</option>
</optgroup>

<optgroup label="🍼 Family & Health">
  <option value="PetSupplies">🐶 Pet Supplies</option>
  <option value="BabyProducts">🍼 Baby Products</option>
  <option value="Food">🍔 Food & Beverages</option>
  <option value="Health">💊 Health</option>
  <option value="MedicalSupplies">🩺 Medical Supplies</option>
  <option value="Fitness">🏋️‍♂️ Fitness & Gym</option>
</optgroup>

<optgroup label="🌾 Industrial & Agriculture">
  <option value="AgricultureFarming">🌾 Agriculture & Farming</option>
  <option value="FarmMachinery">🚜 Farm Machinery</option>
  <option value="IndustrialEquipment">🏭 Industrial Equipment</option>
  <option value="Chemicals">🧪 Chemicals</option>
  <option value="RawMaterials">📦 Raw Materials</option>
</optgroup>

<optgroup label="🌟 Miscellaneous">
  <option value="JobListings">💼 Job Listings</option>
  <option value="LostFound">🔍 Lost & Found</option>
  <option value="Donations">🤝 Donations & Charity</option>
  <option value="Other">🌟 Other</option>
</optgroup>


    </select>

    <label for="itemDescription">Item Description</label>
    <textarea id="itemDescription" placeholder="Describe the item..." required></textarea>

    <label for="itemPrice">Price (KES)</label>
    <input type="number" id="itemPrice" placeholder="e.g. 1500" required>

    <label for="itemCounty">County</label>
    <select id="itemCounty" required>
      <option value="">Select County</option>
    </select>

    <label for="itemSubcounty">Sub-county</label>
    <select id="itemSubcounty" required>
      <option value="">Select Sub-county</option>
    </select>

    <label for="itemPhone">Phone Number</label>
    <input type="text" id="itemPhone" placeholder="e.g. 0712345678" required>

<label for="itemCondition">Condition</label>
<select id="itemCondition" required>
  <option value="New">New</option>
  <option value="Used">Used</option>
</select>

    <label for="itemPhoto">Upload Item Photo</label>
    <input type="file" id="itemPhoto" accept="image/*">

    <button type="submit">
      <i class="fas fa-upload"></i> Post Item
    </button>
  </form>

 <img src="https://i.imgur.com/vwwqSJU.jpeg " class="side-image" />
 <img src="https://i.imgur.com/s4w8sJa.jpeg " class="side-image" />
 <img src="https://i.imgur.com/bpolGgB.jpeg " class="side-image" />
 <img src="https://i.imgur.com/b3gZc2W.jpeg " class="side-image" />
</div>
  <div>
<!-- ✅ Market Filter Action Box -->
<div style="border: 2px solid #cfd8dc; background: #f5f5f5; padding: 12px 16px; border-radius: 10px; margin-bottom: 20px;">

  <h3 style="margin-bottom: 12px; color: #455a64;">
    <i class="fas fa-filter" style="margin-right: 6px;"></i>
    Filter Marketplace Items
  </h3>
<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    🌟 Try Mary's Salon in Kisumu | 📦 Order from Speedy Courier Services | 📱 Fix your phone at TechHub Eldoret | 🍔 Order lunch from Mama John's Kitchen | 📸 Book events with StarPix Photography | 🛠️ Car repairs at QuickFix Nairobi | 💻 Affordable Web Design by PixelStorm | 📷 Wedding shoots by EliteLens Studios
  </div>
</div>
  <div style="display: flex; flex-wrap: wrap; gap: 14px; align-items: flex-start;">

    <!-- Category Filter -->
    <div style="display: flex; flex-direction: column;">
      <label for="filterItemCategory" style="font-size: 13px; color: #607d8b; margin-bottom: 4px;">
        <i class="fas fa-tags" style="margin-right: 6px;"></i>Filter by Category:
      </label>
      <select id="filterItemCategory" onchange="filterMarketItems()"
        style="width: 180px; background-color: #e3f2fd; border: 2px solid #90caf9; padding: 6px; border-radius: 6px; font-weight: bold;">
        <option value="">🔽 Select Category</option>
     
<optgroup label="🏠 Home & Living">
  <option value="HousesApartments">🏠 Houses & Apartments</option>
  <option value="Furniture">🪑 Furniture</option>
  <option value="HomeAppliances">🔌 Home Appliances</option>
  <option value="InteriorDecor">🖼️ Interior Decor</option>
  <option value="Lighting">💡 Lighting</option>
  <option value="Gardening">🪴 Gardening</option>
  <option value="Cleaning">🧼 Cleaning Supplies</option>
  <option value="Art">🎨 Art & Crafts</option>
</optgroup>

<optgroup label="👕 Fashion & Personal">
  <option value="Clothes">👗 Clothes</option>
  <option value="Shoes">👟 Shoes</option>
  <option value="Bags">👜 Bags</option>
  <option value="Jewelry">💍 Jewelry</option>
  <option value="Watches">⌚ Watches</option>
  <option value="Beauty">💄 Beauty</option>
  <option value="Perfumes">🌸 Perfumes & Fragrances</option>
  <option value="TraditionalWear">🧥 Traditional Wear</option>
  <option value="Accessories">🧢 Fashion Accessories</option>
</optgroup>

<optgroup label="📱 Tech & Electronics">
  <option value="Electronics">💻 Electronics</option>
  <option value="Phones">📱 Phones</option>
  <option value="Tablets">📲 Tablets</option>
  <option value="Cameras">📷 Cameras</option>
  <option value="Drones">🛸 Drones</option>
  <option value="Audio">🎧 Audio & Headphones</option>
  <option value="Gaming">🎮 Gaming</option>
  <option value="Software">🧠 Software</option>
  <option value="SmartHome">🏡 Smart Home Devices</option>
</optgroup>

<optgroup label="🚗 Vehicles">
  <option value="Cars">🚗 Cars</option>
  <option value="Motorbikes">🏍️ Motorbikes</option>
  <option value="Bicycles">🚴 Bicycles</option>
  <option value="Trucks">🚚 Trucks</option>
  <option value="Buses">🚌 Buses</option>
  <option value="Marine">⛴️ Marine & Boats</option>
  <option value="VehicleParts">⚙️ Vehicle Parts & Accessories</option>
  <option value="TyresBatteries">🔋 Tyres & Batteries</option>
</optgroup>

<optgroup label="📚 Education & Work">
  <option value="Books">📚 Books</option>
  <option value="Stationery">🖊️ Stationery</option>
  <option value="OfficeSupplies">🗂️ Office Supplies</option>
  <option value="Tutoring">📖 Tutoring Services</option>
  <option value="OnlineCourses">💻 Online Courses</option>
</optgroup>

<optgroup label="🎤 Events & Services">
  <option value="EventServices">🎤 Event Services</option>
  <option value="WeddingSupplies">💒 Wedding Supplies</option>
  <option value="PhotographyServices">📸 Photography & Video</option>
  <option value="RepairConstruction">🛠️ Repair & Construction</option>
  <option value="Security">🛡️ Security & Safety</option>
  <option value="Energy">⚡ Energy & Solar</option>
  <option value="CourierDelivery">📦 Courier & Delivery</option>
  <option value="PrintingBranding">🖨️ Printing & Branding</option>
</optgroup>

<optgroup label="🧸 Lifestyle & Leisure">
  <option value="Toys">🧸 Toys</option>
  <option value="Sports">🏀 Sports</option>
  <option value="LeisureActivities">🏖️ Leisure & Activities</option>
  <option value="Travel">🧳 Travel</option>
  <option value="MusicalInstruments">🎸 Musical Instruments</option>
  <option value="BooksMagazines">📰 Magazines & Comics</option>
  <option value="Collectibles">🗿 Collectibles</option>
</optgroup>

<optgroup label="🍼 Family & Health">
  <option value="PetSupplies">🐶 Pet Supplies</option>
  <option value="BabyProducts">🍼 Baby Products</option>
  <option value="Food">🍔 Food & Beverages</option>
  <option value="Health">💊 Health</option>
  <option value="MedicalSupplies">🩺 Medical Supplies</option>
  <option value="Fitness">🏋️‍♂️ Fitness & Gym</option>
</optgroup>

<optgroup label="🌾 Industrial & Agriculture">
  <option value="AgricultureFarming">🌾 Agriculture & Farming</option>
  <option value="FarmMachinery">🚜 Farm Machinery</option>
  <option value="IndustrialEquipment">🏭 Industrial Equipment</option>
  <option value="Chemicals">🧪 Chemicals</option>
  <option value="RawMaterials">📦 Raw Materials</option>
</optgroup>

<optgroup label="🌟 Miscellaneous">
  <option value="JobListings">💼 Job Listings</option>
  <option value="LostFound">🔍 Lost & Found</option>
  <option value="Donations">🤝 Donations & Charity</option>
  <option value="Other">🌟 Other</option>
</optgroup>
      </select>
    </div>

    <!-- County Filter -->
    <div style="display: flex; flex-direction: column;">
      <label for="filterItemCounty" style="font-size: 13px; color: #37474f; margin-bottom: 4px;">
        <i class="fas fa-map-marker-alt" style="margin-right: 6px;"></i>County:
      </label>
      <select id="filterItemCounty" onchange="filterMarketItems()"
        style="width: 180px; background-color: #ede7f6; border: 2px solid #9575cd; padding: 6px; border-radius: 6px; font-weight: bold;">
        <option value="">All Kenya</option>
        <!-- More county options will be populated dynamically -->
      </select>
    </div>

    <!-- Min Price Filter -->
    <div style="display: flex; flex-direction: column;">
      <label for="filterMinPrice" style="font-size: 13px; color: #388e3c; margin-bottom: 4px;">
        <i class="fas fa-dollar-sign" style="margin-right: 6px;"></i>Min Price:
      </label>
      <input type="number" id="filterMinPrice" placeholder="KES 0" onchange="filterMarketItems()"
        style="width: 120px; background-color: #e8f5e9; border: 2px solid #a5d6a7; padding: 6px; border-radius: 6px; font-weight: bold;" />
    </div>

    <!-- Max Price Filter -->
    <div style="display: flex; flex-direction: column;">
      <label for="filterMaxPrice" style="font-size: 13px; color: #d84315; margin-bottom: 4px;">
        <i class="fas fa-dollar-sign" style="margin-right: 6px;"></i>Max Price:
      </label>
      <input type="number" id="filterMaxPrice" placeholder="KES 10000" onchange="filterMarketItems()"
        style="width: 120px; background-color: #ffebee; border: 2px solid #ef9a9a; padding: 6px; border-radius: 6px; font-weight: bold;" />
    </div>

    <!-- Apply & Reset Buttons -->
    <div style="display: flex; gap: 8px; margin-top: 6px;">
      <button onclick="filterMarketItems()"
        style="padding: 6px 12px; background: #4caf50; color: #fff; border: none; border-radius: 6px; cursor: pointer;">
        Apply Filters
      </button>
      <button onclick="resetMarketFilters()"
        style="padding: 6px 12px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer;">
        Reset
      </button>
    </div>

  </div>
</div>



<!-- ✅ Market Items Container -->
<div id="marketContainer" style="
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 40px;
  width: 100%;
  padding: 40px 30px;
  margin-top: 20px;
  box-sizing: border-box;
  background-color: #f9fbff;
">
  <!-- Market Item Cards -->
  <div style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);">
    <h4 style="margin: 0 0 10px;">Market Item 1</h4>
    <p style="margin: 0;">Description of the item here.</p>
  </div>
  <div style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);">
    <h4 style="margin: 0 0 10px;">Market Item 2</h4>
    <p style="margin: 0;">Description of the item here.</p>
  </div>
  <div style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);">
    <h4 style="margin: 0 0 10px;">Market Item 3</h4>
    <p style="margin: 0;">Description of the item here.</p>
  </div>
</div>

<div id="trendingSection" class="page" style="display: none;">
  <h2>
    <i class="fas fa-fire" style="color: crimson; margin-right: 8px;"></i>
    Trending Boosted Items
  </h2>
  <div class="scrolling-banner">
    <div class="scrolling-banner-content">
      🌟 Hot listings from every corner of Kenya | 💼 Jobs | 🛍️ Market | ❤️ Soulmates | 🛠️ Services – All Boosted & Trending Now!
    </div>
  </div>
  <div id="trendingContainer" style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; padding: 20px;">
    <!-- Boosted cards will be inserted here -->
  </div>
</div>


<!-- ✅ Confirm Delete Modal -->
<div id="confirmDeleteModal" style="display:none; position: fixed; top: 0; left: 0;
  width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
  <div style="background: white; padding: 20px 25px; border-radius: 10px; box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      width: 90%; max-width: 400px; text-align: center;">
    <h3 style="margin-bottom: 10px; color: #dc3545;">Confirm Deletion</h3>
    <p style="font-size: 16px;">Are you sure you want to delete this swap?</p>
    <div style="height: 8px; background: #eee; border-radius: 5px; margin-top: 15px;">
      <div id="confirmProgressBar" style="width: 100%; height: 8px; background-color: #28a745; border-radius: 5px;"></div>
    </div>
    <span style="color: crimson; font-weight: bold;">🔥 VIP</span>
    <div style="margin-top: 20px;">
      <button id="confirmYes" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none;
        border-radius: 6px; margin-right: 10px; cursor: pointer;">Yes, Delete</button>
      <button id="confirmNo" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none;
        border-radius: 6px; cursor: pointer;">Cancel</button>
    </div>
  </div>
</div>

<!-- ✅ Notification Badge -->
<span id="notifBadge" style="display:none; background:red; color:white; border-radius:50%; padding:2px 6px;">0</span>

<!-- ✅ Centered Toast -->
<div id="customToast" style="
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #d32f2f;
  color: #fff;
  padding: 16px 24px;
  border-radius: 10px;
  display: none;
  z-index: 9999;
  font-size: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  max-width: 90%;
  text-align: center;
  opacity: 0;
  transition: opacity 0.4s ease;
">
  <span id="toastMessage">This is a toast message.</span>
  <button onclick="hideCustomToast()" style="
    position: absolute;
    top: 8px;
    right: 12px;
    background: transparent;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;">&times;
  </button>
</div>


<!-- ✅ Toast Container -->
<div id="toastContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>
<!-- ✅ Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>


<script>
  // ✅ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyD7qfXm0hmz4oyvKzICwFQ2xQR1_RkLNYg",
    authDomain: "rowan-494f7.firebaseapp.com",
    databaseURL: "https://rowan-494f7-default-rtdb.firebaseio.com",
    projectId: "rowan-494f7",
    storageBucket: "rowan-494f7.firebasestorage.app",
    messagingSenderId: "158143387761",
    appId: "1:158143387761:web:2606fa93a3c812bddd23d0",
    measurementId: "G-V9Q98Q09F2"
  };

   // ✅ Firebase Init
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
const storage = firebase.storage();  // ✅ This line is missing!
const bomRef = db.collection("bomJobs");
const soulmateRef = db.collection("soulmates");
const resourceRef = db.collection("teachingResources");
const servicesRef = db.collection("seekingServices");
const marketRef = db.collection("marketItems");

 // ✅ Global State
  let isLoggedIn = false;
  let hasPaid = false;
  let hasPaid100 = false;
  let hasPaidVip1000 = false;
  let currentUser = null;
  let isAdmin = false;
  let currentUserId = null;

  // ✅ Load user payment status
  async function loadUserPaymentStatus() {
    if (!currentUserId) return;

    try {
      const userDoc = await db.collection("users").doc(currentUserId).get();
      const data = userDoc.data();

      hasPaid100 = data?.hasPaid100 || false;
      hasPaidVip1000 = data?.hasPaidVip1000 || false;
    } catch (error) {
      console.error("Error loading payment status:", error.message);
    }
  }

  // ✅ Monitor Auth State 
  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;
      isLoggedIn = true;
  

      const adminEmails = [
        "mashabiki@teacherswapskenya.com",
        "sironga@teacherswapskenya.com",
        "sironga1@teacherswapskenya.com",
        "admin@teacherswapskenya.com"
      ];
      isAdmin = adminEmails.includes(user.email);

      await loadUserPaymentStatus(); // ✅ Load payment info immediately after login

      attachMarketFormSubmit();
      loadMarketItems(); // ✅ Load marketplace (without redirect)

      if (isAdmin) {
        loadAdminNotifications();
        updateAdminNotifBadge();
      }

    } else {
      isLoggedIn = false;
      currentUser = null;
      currentUserId = null;
      isAdmin = false;
      hasPaid = false;
      hasPaid100 = false;
      hasPaidVip1000 = false;
      showPage("home");
    }
  });


// ✅ Hot counties for VIP swap prioritization
const vipHotCounties = ["Nairobi", "Kisumu", "Mombasa", "Kisii", "Nakuru"];
// ✅ Counties and Sub-counties Map
const countySubCountyMap = {
"Mombasa": ["Changamwe", "Jomvu", "Kisauni", "Likoni", "Mvita", "Nyali"],
  "Kwale": ["Msambweni", "Lunga Lunga", "Matuga", "Kinango"],
  "Kilifi": ["Kilifi North", "Kilifi South", "Kaloleni", "Rabai", "Ganze", "Malindi", "Magarini"],
 "Tana River": ["Galole", "Garsen", "Bura", "Galedyertu", "Bangal"],
  "Lamu": ["Lamu East", "Lamu West"],
  "Taita–Taveta": ["Mwatate", "Voi", "Taveta", "Wundanyi"],
  "Garissa": ["Balambala", "Dadaab", "Fafi", "Garissa Township", "Hulugho", "Ijara", "Lagdera"],
  "Wajir": ["Eldas", "Tarbaj", "Wajir North", "Wajir East", "Wajir West", "Wajir South", "Buna"],
  "Mandera": ["Banisa", "Mandera West", "Mandera North", "Mandera South", "Mandera East", "Lafey"],
  "Marsabit": ["Moyale", "North Horr", "Saku", "Laisamis"],
  "Isiolo": ["Isiolo Central", "Merti", "Garbatulla"],
  "Meru": ["Imenti North", "Imenti South", "Imenti Central", "Tigania East", "Tigania West", "Buuri", "North Imenti"],
  "Tharaka-Nithi": ["Chuka/Igambang'ombe", "Maara", "Tharaka South", "Tharaka North"],
  "Embu": ["Manyatta", "Runyenjes", "Mbeere North", "Mbeere South"],
  "Kitui": ["Kitui Central", "Mwingi North", "Mwingi West", "Mwingi Central", "Kitui Rural", "Kitui South", "Kitui East", "Migwani"],
  "Machakos": ["Masinga", "Yatta", "Kangundo", "Matungulu", "Kathiani", "Mavoko", "Machakos Town", "Mwaki"],
  "Makueni": ["Mbooni", "Kaiti", "Kilome", "Mukaa", "Makueni", "Kibwezi East", "Kibwezi West"],
  "Nyandarua": ["Ol Joro Orok", "Kinangop", "Kipipiri", "Ndaragwa", "Ol Kalou"],
  "Nyeri": ["Tetu", "Nyeri Town", "Mathira", "Othaya", "Kieni", "Mukurweini"],
  "Kirinyaga": ["Kirinyaga Central", "Kirinyaga West", "Mwea", "Gichugu"],
  "Murang'a": ["Gatanga", "Kiharu", "Kigumo", "Kangema", "Mathioya", "Murang'a South"],
  "Kiambu": [ "Githunguri","Kiambu","Kabete","Kiambaa","Ruiru","Limuru", "Lari", "Juja","Thika Town","Gatundu North","Gatundu South","Kikuyu"],
  "Turkana": ["Turkana North", "Turkana West", "Turkana Central", "Loima", "Turkana South", "Turkana East"],
  "West Pokot": ["West Pokot", "North Pokot", "Central Pokot", "Pokot South", "Kipkomo", "Kacheliba"],
  "Samburu": ["Samburu East", "Samburu North", "Samburu West"],
  "Trans Nzoia": ["Kwanza", "Endebess", "Saboti", "Kiminini", "Cherangany"],
  "Uasin Gishu": ["Ainabkoi", "Kapseret", "Kesses", "Moiben", "Soy", "Turbo"],
  "Elgeyo-Marakwet": ["Keiyo North", "Keiyo South", "Marakwet East", "Marakwet West"],
  "Nandi": ["Aldai", "Chesumei", "Emgwen", "Mosop", "Nandi Hills", "Tinderet"],
  "Baringo": ["Baringo Central", "Baringo North", "Baringo South", "Eldama Ravine", "Mogotio", "Tiaty"],
  "Laikipia": ["Laikipia East", "Laikipia North", "Laikipia West"],
  "Nakuru": ["Bahati", "Gilgil", "Kuresoi North", "Kuresoi South", "Molo", "Naivasha", "Nakuru Town East", "Nakuru Town West", "Rongai", "Subukia"],
  "Narok": ["Narok East", "Narok North", "Narok South", "Narok West", "Trans Mara East", "Trans Mara West"],
  "Kajiado": ["Isinya", "Kajiado Central", "Kajiado East", "Kajiado North", "Kajiado South"],
  "Kericho": ["Ainamoi", "Belgut", "Bureti", "Kipkelion East", "Kipkelion West", "Soin/Sigowet"],
  "Bomet": ["Bomet Central", "Bomet East", "Chepalungu", "Konoin", "Sotik"],
  "Kakamega": ["Butere", "Ikolomani", "Khwisero", "Lugari", "Lurambi", "Malava", "Matungu", "Mumias East", "Mumias West", "Navakholo", "Shinyalu"],
  "Vihiga": ["Emuhaya", "Hamisi", "Luanda", "Sabatia", "Vihiga"],
  "Bungoma": ["Bumula", "Kabuchai", "Kanduyi", "Kimilili", "Mt. Elgon", "Sirisia", "Tongaren", "Webuye East", "Webuye West"],
  "Busia": ["Budalangi", "Butula", "Funyula", "Matayos", "Nambale", "Teso North", "Teso South"],
  "Siaya": ["Alego Usonga", "Bondo", "Gem", "Rarieda", "Ugenya", "Ugunja"],
  "Kisumu": ["Kisumu East", "Kisumu West", "Kisumu Central", "Muhoroni", "Nyakach", "Nyando", "Seme"],
  "Homa Bay": ["Homa Bay Town", "Kabondo Kasipul", "Kabondo East", "Mbita", "Ndhiwa", "Rachuonyo East", "Rachuonyo North", "Rachuonyo South", "Rangwe", "Suba North", "Suba South"],
  "Migori": ["Awendo", "Kuria East", "Kuria West", "Nyatike", "Rongo", "Suna East", "Suna West", "Uriri"],
  "Kisii": ["Bobasi", "Bomachoge Borabu", "Bomachoge Chache", "Bonchari", "Kitutu Chache North", "Kitutu Chache South", "Nyaribari Chache", "Nyaribari Masaba", "South Mugirango"],
  "Nyamira": ["Borabu", "Manga", "Masaba North", "Nyamira North", "Nyamira South"],
  "Nairobi City": ["Dagoretti North", "Dagoretti South", "Embakasi Central", "Embakasi East", "Embakasi North", "Embakasi South", "Embakasi West", "Kamukunji", "Kasarani", "Lang'ata", "Makadara", "Mathare", "Roysambu", "Ruaraka", "Starehe", "Westlands"]
};

// ✅ Populate Counties
function populateCounties(id, subCountyId = null) {
  const el = document.getElementById(id);
  el.innerHTML = `<option value="">Select County</option>`;
  
  // Populate county options
  Object.keys(countySubCountyMap).forEach(county => {
    const option = document.createElement("option");
    option.value = county;
    option.textContent = county;
    el.appendChild(option);
  });

  // If sub-county dropdown is provided, handle its population
  if (subCountyId) {
    const subCountyEl = document.getElementById(subCountyId);
    el.addEventListener("change", () => {
      const selectedCounty = el.value;
      subCountyEl.innerHTML = `<option value="">Select Sub-county</option>`;
      if (countySubCountyMap[selectedCounty]) {
        countySubCountyMap[selectedCounty].forEach(subCounty => {
          const option = document.createElement("option");
          option.value = subCounty;
          option.textContent = subCounty;
          subCountyEl.appendChild(option);
        });
      }
    });
  }
}

// ✅ Apply to county-subcounty pairs only (with event binding)
const countySubCountyPairs = [
  { county: "county", subCounty: "subCounty" },
  { county: "swapCounty", subCounty: "swapSubCounty" },
  { county: "filterSwapCounty", subCounty: "filterSwapSubCounty" },
  { county: "bomCounty", subCounty: "bomSubCounty" },
  { county: "svcCounty", subCounty: "svcSubCounty" },
  { county: "itemCounty", subCounty: "itemSubCounty" },
  { county: "filterItemCounty", subCounty: "filterItemSubCounty" },
  { county: "filterCounty", subCounty: "filterSubCounty" },
  { county: "filterServiceCounty", subCounty: "filterServiceSubCounty" },
  { county: "smCounty", subCounty: "smSubCounty" }
];
countySubCountyPairs.forEach(pair => populateCounties(pair.county, pair.subCounty));


// ✅ Initialize all county-subcounty dropdowns
countySubCountyPairs.forEach(pair => populateCounties(pair.county, pair.subCounty));



async function showPage(pageId) {
  if (pageId === "swaps" && !isLoggedIn) {
    showCustomAlert("You must be logged in to view swaps.", "error");
    showPage("login");
    return;
  }

  if (pageId === "resources" && !isLoggedIn) {
    showCustomAlert("Please login to view resources.", "error");
    showPage("login");
    return;
  }

  if (pageId === "messages" && !isLoggedIn) {
    showCustomAlert("Please login to access your messages.", "error");
    showPage("login");
    return;
  }

  if (pageId === "soulmates" && !isLoggedIn) {
    showCustomAlert("Please login to view or post soulmate profiles.", "error");
    showPage("login");
    return;
  }

  if (pageId === "seekingServices" && !isLoggedIn) {
    showCustomAlert("Please login to view or post services.", "error");
    showPage("login");
    return;
  }

  // Hide all pages
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");

  // Show requested page
  const page = document.getElementById(pageId);
  if (page) page.style.display = "block";

  // Page-specific logic
  if (pageId === "swaps" && isLoggedIn) loadSwaps();
  if (pageId === "bomJobs") loadBOMJobs();
  if (pageId === "resources") {
    await checkPaymentStatus();
    loadResources();
  }
  if (pageId === "soulmates") loadSoulmates();
  if (pageId === "seekingServices") loadServices();

  // ✅ If admin is viewing notifications, load them
  if (pageId === "notifications" && isAdmin) {
    loadAdminNotifications();
    updateAdminNotifBadge();
  }

if (pageId === "market") {
  populateCounties("itemCounty", "itemSubcounty"); // ✅ exact match for element ID
  loadMarketItems();
}

}



// ✅ Register
document.getElementById("registerForm").addEventListener("submit", async e => {
  e.preventDefault();
  
  // Show the loading spinner
  document.getElementById("loadingSpinner").style.display = "block";
  
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  try {
    const userCred = await auth.createUserWithEmailAndPassword(email, password);
    currentUser = userCred.user;
    await currentUser.updateProfile({ displayName: name });

    // Send admin notification on new user registration
    await sendRegistrationAdminNotification(currentUser);

    // Hide the loading spinner after successful registration
    document.getElementById("loadingSpinner").style.display = "none";

    showCustomAlert("Registration successful! Please login.", "success");
    showPage("login");
    e.target.reset();
  } catch (err) {
    // Hide the loading spinner if an error occurs
    document.getElementById("loadingSpinner").style.display = "none";

    showCustomAlert("Error: " + err.message, "error");
  }
});

// Function to send admin notification on user registration
async function sendRegistrationAdminNotification(user) {
  const notifRef = db.collection("adminNotifications").doc();

  await notifRef.set({
    type: "New User Registration",
    userId: user.uid,
    userEmail: user.email,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `🔔 New user ${user.email} has registered successfully.`
  });

  console.log("Admin notification sent for new user registration.");
}

// ✅ Login with Firebase
document.getElementById("loginForm").addEventListener("submit", async e => {
  e.preventDefault();
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;

  try {
    const userCred = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCred.user;
    isLoggedIn = true;

    // Save to localStorage
    localStorage.setItem("loggedInUser", currentUser.displayName || currentUser.email);

    const welcome = `Welcome ${currentUser.displayName || currentUser.email}!`;
    showCustomAlert(isAdmin ? `Admin Access: ${welcome}` : welcome, "success");

    // Show swap page
    showPage("swaps");

    // Update displayed logged-in user
    displayLoggedInUser();

    e.target.reset();
  } catch (err) {
    showCustomAlert("Login failed: " + err.message, "error");
  }
});


// ✅ Display logged-in user
function displayLoggedInUser() {
  const user = localStorage.getItem("loggedInUser");
  const userDiv = document.getElementById("loggedInUser");
  if (user) {
    userDiv.innerHTML = `
      <i class="fas fa-user-circle"></i> ${user}
      <button onclick="logoutUser()" style="margin-left:10px; padding:4px 8px; border:none; border-radius:5px; background:red; color:white;">
        Logout
      </button>
    `;
  } else {
    userDiv.innerHTML = "";
  }
}

function logoutUser() {
  // Show the loading spinner when logging out
  document.getElementById("loadingSpinner").style.display = "flex";

  auth.signOut().then(() => {
    localStorage.removeItem("loggedInUser");

    // Show the toast message
    const toast = document.getElementById("logoutToast");
    toast.style.display = "block";
    toast.textContent = "You have logged out successfully!";

    // Hide the spinner and toast after 2.5 seconds, then reload the page
    setTimeout(() => {
      document.getElementById("loadingSpinner").style.display = "none";
      toast.style.display = "none";
      location.reload();
    }, 2500);
  }).catch((error) => {
    // In case of an error, hide the spinner and show an error toast
    document.getElementById("loadingSpinner").style.display = "none";
    const errorToast = document.getElementById("logoutToast");
    errorToast.textContent = "Error logging out: " + error.message;
    errorToast.style.backgroundColor = "red"; // To highlight the error
    errorToast.style.display = "block";

    setTimeout(() => {
      errorToast.style.display = "none";
    }, 2500);
  });
}



// ✅ Display user on page load (if logged in)
window.onload = function () {
  displayLoggedInUser();
};


// ✅ Swap Form Submit Handler
document.getElementById("swapForm").addEventListener("submit", e => {
  e.preventDefault();

  if (!isLoggedIn || !currentUser) {
    showPage("login");
    return alert("You must be logged in.");
  }

  const data = {
    teacherName: document.getElementById("teacherName").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    subjectCombination: document.getElementById("subjectCombination").value.trim(),
    county: document.getElementById("county").value,
    subCounty: document.getElementById("subCounty").value,
    swapCounty: document.getElementById("swapCounty").value,
    swapSubCounty: document.getElementById("swapSubCounty")?.value || "", // Optional
    category: document.getElementById("category").value,
    hardship: document.getElementById("hardship").value
  };

  // Validate only required fields
  const requiredFields = ['teacherName', 'phone', 'subjectCombination', 'county', 'subCounty', 'swapCounty', 'category', 'hardship'];
  const missing = requiredFields.some(key => !data[key]);

  if (missing) {
    return alert("Please fill all required fields.");
  }

  saveSwap(data);
});


// ✅ Save Swap and Notify
async function saveSwap(swap) {
  // Show the loading spinner while the swap is being saved
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    // Save the swap to the 'teacherSwaps' collection
    const swapDoc = await db.collection("teacherSwaps").add({
      ...swap,
      userId: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Show confirmation alert for user
    showCustomAlert("Swap added successfully!", "success");

    // 🔔 Admin notification
    const notification = {
      type: "Swap Added",
      message: `A new swap has been posted by ${swap.teacherName} for ${swap.subjectCombination}.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false,
      itemId: swapDoc.id,
    };

    await db.collection("adminNotifications").add(notification);

    // 🔔 Global alert to all users
    await db.collection("alerts").add({
      title: "🔁 New Swap Posted",
      message: `${swap.teacherName} just posted a swap for ${swap.subjectCombination}.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null  // public
    });

    // Reset form and reload swaps
    document.getElementById("swapForm").reset();
    loadSwaps();

  } catch (err) {
    showCustomAlert("Error saving swap: " + err.message, "error");
  } finally {
    // Hide the spinner once the process is done (success or error)
    document.getElementById("loadingSpinner").style.display = "none";
  }
}

async function loadSwaps() {
  const container = document.querySelector("#swapCardContainer");
  container.innerHTML = "";
  trendingBoostedSwaps = [];

  try {
    const swapRef = db.collection("teacherSwaps").orderBy("timestamp", "desc");

    swapRef.onSnapshot(snapshot => {
      if (snapshot.empty) {
        container.innerHTML = `<div style="text-align:center;padding:20px;color:#999;">💔 No swap requests found</div>`;
        return;
      }

      const now = new Date();
      const boostedSwaps = [];
      const normalSwaps = [];
      const hasPaid = localStorage.getItem("paidForSwaps") === "yes";

      snapshot.docs.forEach(doc => {
        const s = doc.data();
        const id = doc.id;
        const boostExpiry = s.boostExpiry?.toDate?.();
        const isBoosted = s.boosted && boostExpiry && boostExpiry > now;

        if (s.boosted && (!boostExpiry || boostExpiry <= now)) {
          db.collection("teacherSwaps").doc(id).update({ boosted: false, boostExpiry: null });
        }

        const swap = { id, ...s, isBoosted, boostExpiry };
        (isBoosted ? boostedSwaps : normalSwaps).push(swap);

        if (isBoosted) {
          trendingBoostedSwaps.push({
            title: s.teacherName,
            description: `${s.county} ➡️ ${s.swapCounty} (${s.subjectCombination})`,
            phone: s.phone,
            type: "swap"
          });
        }
      });

      const orderedSwaps = [...boostedSwaps, ...normalSwaps];

      orderedSwaps.forEach(s => {
        const isPoster = currentUser && s.userId === currentUser.uid;
        const isAdminUser = isAdmin === true;
        const blur = !hasPaid && !isPoster && !isAdminUser;
        const isHotCounty = vipHotCounties.includes(s.county) || vipHotCounties.includes(s.swapCounty);

        const closedStatusBadge = s.isClosed
          ? `<span style="color:red; font-weight:bold; margin-left:6px;">(Closed)</span>`
          : "";

        const vipBtn = isAdminUser && isHotCounty && !s.isVIP
          ? `<button onclick="markAsVIPSwap('${s.id}')" style="background:#6a1b9a;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">🔥 Sell VIP</button>`
          : s.isVIP ? `<span style="color:crimson;font-weight:bold;font-size:13px;">🔥 VIP</span>` : "-";

        const showVerifiedBadge = s.verified
          ? `<span class="verified-badge"><i class="fas fa-check-circle"></i></span>`
          : "";

        let verifyBtnHTML = "";
        if (!s.verified) {
          if (isPoster && !isAdminUser) {
            verifyBtnHTML = `
              <button onclick="showPaymentModalFor('swapVerification', 250, '${s.id}', '${s.teacherName || ''}')"
                style="margin-left:6px;background:#4CAF50;color:white;padding:4px 8px;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                ✅ Get Verified – Ksh 250
              </button>`;
          } else if (isAdminUser) {
            verifyBtnHTML = `
              <button onclick="adminVerifyItem('swap', '${s.id}')"
                style="margin-left:6px;background:#2196F3;color:white;padding:4px 8px;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                🛡️ Verify Now (Admin)
              </button>`;
          }
        }

        const showVIPBadge = s.isVIP ? `<span class="vip-badge">🔥 VIP</span>` : "";
        const showBoostedBadge = s.isBoosted && s.boostExpiry
          ? `<span class="boosted-badge">🚀 Boosted (${Math.ceil((s.boostExpiry - now) / (1000 * 60 * 60 * 24))} day${Math.ceil((s.boostExpiry - now) / (1000 * 60 * 60 * 24)) !== 1 ? 's' : ''} left)</span>`
          : "";

        const contactHTML = `
          <div style="margin:4px 0;">
            📞 <a href="tel:${s.phone}" style="color:green;">${s.phone}</a><br>
            💬 <a href="https://wa.me/254${s.phone.replace(/^0/, '')}" target="_blank" style="color:#25D366;">WhatsApp</a>
          </div>`;

        const blurredContactHTML = `
          <div style="margin:6px 0; text-align:left;">
            <span style="color:crimson; font-size:13px; font-weight:bold;">
              🔒 Contacts locked. Pay Ksh 250 to unlock
            </span><br>
            <button onclick="showPaymentModalFor('swap', 250, '${s.id}', 'Unlock VIP Swaps')"
                    style="margin-top:4px;background:crimson;color:white;border:none;padding:5px 10px;border-radius:4px;">
              💳 Pay Now
            </button>
          </div>`;

        const closedContactHTML = `
          <div style="margin:6px 0; text-align:left; color:red; font-weight:bold;">
            🚫 This swap is closed
          </div>`;

        const card = document.createElement("div");
        card.className = "swap-card";
        card.style = `
          background: #f9f9f9;
          border-radius: 8px;
          padding: 12px;
          box-shadow: 0 1px 4px rgba(0,0,0,0.1);
          margin: 8px;
          width: 280px;
          display: inline-block;
          vertical-align: top;
          position: relative;
        `;
        card.setAttribute("data-category", s.category || "-");
        card.setAttribute("data-swapcounty", s.swapCounty || "-");
        card.setAttribute("data-swapsubcounty", s.swapSubCounty || "-");
        card.setAttribute("data-hardship", s.hardship || "-");
        card.setAttribute("data-subject", (s.subjectCombination || "-").toLowerCase());

        const boostButton = (isPoster || isAdminUser) ? `
          <div style="margin-top:10px;">
            <button id="boostSwapBtn-${s.id}" onclick="boostSwap('${s.id}')"
              style="background:#ff9800;color:white;border:none;border-radius:6px;padding:6px 12px;font-size:13px;cursor:pointer;">
              🚀 Boost Swap ${isAdminUser ? "(Free)" : "(Ksh 250)"}
            </button>
          </div>` : "";

        const closedButton = (isPoster || isAdminUser) ? `
          <div style="margin-top:10px;">
            <button id="closeSwapBtn-${s.id}" onclick="toggleSwapStatus('${s.id}')"
              style="background:${s.isClosed ? '#4caf50' : '#9e9e9e'};color:white;border:none;border-radius:6px;padding:6px 12px;font-size:13px;cursor:pointer;">
              ${s.isClosed ? "♻️ Reopen Swap" : "🚫 Mark as Closed"}
            </button>
          </div>` : "";

        const deleteButton = isAdminUser ? `
          <button onclick="deleteSwap('${s.id}')"
            style="background:#f44336;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">
            🗑️ Delete
          </button>` : "";

        const interestButton = (!s.isClosed || isPoster || isAdminUser) ? `
          <button onclick="sendSwapInterest('${s.id}', '${s.teacherName}')"
            style="background:#2196f3;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">
            💌 Show Interest
          </button>` : "";

        const followButton = (!s.isClosed || isPoster || isAdminUser) ? `
          <button onclick="followSwap('${s.id}')"
            style="background:#e91e63;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">
            🧑🤝🧑 Follow Swap
          </button>` : "";

        const followerCount = s.followers ? s.followers.length : 0;

        card.innerHTML = `
          <h3 style="margin:0; color:#1a237e;">${s.teacherName} ${showVerifiedBadge} ${verifyBtnHTML} ${closedStatusBadge}</h3>
          <div style="margin:4px 0;">${showVIPBadge} ${showBoostedBadge}</div>
          <p style="margin:4px 0;color:#3f51b5;"><strong>From:</strong> ${s.county} / ${s.subCounty || "-"}</p>
          <p style="margin:4px 0;color:#ef6c00;"><strong>Wants:</strong> ${s.swapCounty} / ${s.swapSubCounty || "-"}</p>
          <p style="margin:4px 0;color:#6a1b9a;"><strong>Subjects:</strong> ${s.subjectCombination || '-'}</p>
          <p style="margin:4px 0;color:#3e2723;"><strong>Category:</strong> ${s.category || '-'}</p>
          <p style="margin:4px 0;color:#d81b60;"><strong>Hardship:</strong> ${s.hardship || '-'}</p>

          <div style="margin-top:6px;">
            ${s.isClosed && !isPoster && !isAdminUser ? closedContactHTML : (blur ? blurredContactHTML : contactHTML)}
          </div>

          <div class="rating" data-id="${s.id}">
            <span class="avg-rating" id="avgRating-${s.id}">Loading...</span><br>
            ${[1, 2, 3, 4, 5].map(star => `
              <i class="fas fa-star" onclick="rateService('${s.id}', ${star})"
                 style="cursor:pointer; color:#ccc;" id="star-${s.id}-${star}"></i>
            `).join('')}
          </div>

          <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;">
            ${deleteButton}
            ${vipBtn}
            ${interestButton}
            ${followButton}
          </div>

          <p id="follower-count-${s.id}" style="font-size: 0.9em; color: #ff4081;" onclick="showFollowers('${s.id}')">
            ${followerCount} people following
          </p>

          ${closedButton}
          ${boostButton}
        `;

        container.appendChild(card);
        updateAverageRating(s.id);
      });

      renderTrendingSectionFromSwapsOnly();
    });

  } catch (err) {
    console.error("Error loading swaps:", err);
    showCustomAlert("Error loading swaps: " + err.message, "error");
  }
}

async function deleteSwap(swapId) {
  // Show spinner when the deletion process starts
  document.getElementById('loadingSpinner').style.display = 'flex';

  // Show confirmation box
  const existingBox = document.getElementById("inlineSwapConfirmBox");
  if (existingBox) existingBox.remove();

  const box = document.createElement("div");
  box.id = "inlineSwapConfirmBox";
  box.style.cssText = `
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    padding: 18px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    z-index: 9999;
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    max-width: 90%;
    width: 320px;
    animation: fadeIn 0.3s ease;
  `;

  box.innerHTML = `
    <p style="margin: 0 0 16px; font-size: 15px; color: #333;">
      Are you sure you want to delete this swap?
    </p>
    <div style="display: flex; justify-content: center; gap: 10px;">
      <button id="swapConfirmYesBtn" style="background: #d32f2f; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">🗑️ Yes</button>
      <button id="swapConfirmNoBtn" style="background: #607d8b; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">Cancel</button>
    </div>
  `;

  document.body.appendChild(box);

  // Handle button actions
  document.getElementById("swapConfirmYesBtn").onclick = async () => {
    // Start deleting the swap
    box.remove();
    try {
      // Wait for the deletion to complete
      await db.collection("teacherSwaps").doc(swapId).delete();
      showCustomAlert("✅ Swap deleted successfully.", "success");

      // Reload swaps after deletion
      loadSwaps();
    } catch (err) {
      console.error("Error deleting swap:", err);
      showCustomAlert("❌ Failed to delete swap: " + err.message, "error");
    } finally {
      // Hide the spinner after operation completes
      document.getElementById('loadingSpinner').style.display = 'none';
    }
  };

  document.getElementById("swapConfirmNoBtn").onclick = () => {
    box.remove(); // Close the confirmation box if canceled
    showCustomAlert("❎ Deletion canceled.", "info");
    // Hide the spinner if user cancels
    document.getElementById('loadingSpinner').style.display = 'none';
  };
}

// ✅ Admin instant verification handler 
function adminVerifyItem(type, itemId) {
  if (type === "swap") {
    db.collection("teacherSwaps").doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("✅ Swap verified by Admin!", "success");
    loadSwaps();
  } 
  else if (type === "soulmate") {
    soulmateRef.doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("✅ Soulmate verified by Admin!", "success");
    loadSoulmates();
  } 
  else if (type === "service") {
    servicesRef.doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("✅ Service verified by Admin!", "success");
    loadServices();
  } 
  else if (type === "market") {
    marketRef.doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("✅ Market item verified by Admin!", "success");
    loadMarketItems();
  }
  else if (type === "job") { // ✅ Added BOM job verification
    db.collection("bomJobs").doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("✅ Job verified by Admin!", "success");
    if (typeof loadBOMJobs === "function") {
      loadBOMJobs();
    }
  }
}

async function showFollowers(swapId) {
  const swapRef = db.collection("teacherSwaps").doc(swapId);
  const swapDoc = await swapRef.get();

  if (!swapDoc.exists) {
    console.log("No such swap!");
    return;
  }

  const followers = swapDoc.data().followers || [];
  const followersList = document.getElementById('followersList');

  if (followers.length === 0) {
    // If no followers, display a message
    followersList.innerHTML = "<li>No followers for now.</li>";
  } else {
    // If there are followers, list their names
    const followerNames = followers.map(f => {
      const firstName = f.email ? f.email.split('@')[0] : 'Anonymous';
      return `<li style="padding: 5px; border-bottom: 1px solid #eee;">${firstName}</li>`;
    }).join("");
    followersList.innerHTML = followerNames;
  }

  // Show the modal
  document.getElementById('followersModal').style.display = 'flex';
}

// Function to close the modal
function closeFollowersModal() {
  document.getElementById('followersModal').style.display = 'none';
}


// Function to close the modal
function closeFollowersModal() {
  document.getElementById('followersModal').style.display = 'none';
}


// Function to follow a swap
async function followSwap(swapId) {
  const currentUser = firebase.auth().currentUser;
  if (!currentUser) {
    showCustomAlert("Please log in to follow this swap.", "error");
    return;
  }

  // Show the loading spinner while following the swap
  document.getElementById("loadingSpinner").style.display = "flex";

  const swapRef = db.collection("teacherSwaps").doc(swapId);
  const swapDoc = await swapRef.get();
  if (!swapDoc.exists) {
    showCustomAlert("Swap not found.", "error");
    document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner
    return;
  }

  const swapData = swapDoc.data();
  const followers = swapData.followers || [];

  // Check if the user is already following
  if (!followers.some(f => f.uid === currentUser.uid)) {
    const user = {
      uid: currentUser.uid,
      email: currentUser.email,
    };

    try {
      // Add user to followers list
      await swapRef.update({
        followers: firebase.firestore.FieldValue.arrayUnion(user)
      });

      // Update follower count in UI
      const followerCount = followers.length + 1;
      const countEl = document.getElementById(`follower-count-${swapId}`);
      if (countEl) {
        countEl.innerText = `${followerCount} people following`;
      }

      // Send admin notification
      await sendFollowAdminNotification(swapId, currentUser);

      // ✅ Notify the swap poster (if not same user)
      const posterId = swapData.postedBy;
      if (posterId && posterId !== currentUser.uid) {
        await db.collection("alerts").add({
          title: "👀 New Follower",
          message: `${currentUser.email || "Someone"} followed your swap: ${swapData.name || "Unnamed Swap"}`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          targetUserId: posterId
        });
      }

      // ✅ Show center screen success alert to the follower
      showCustomAlert("✅ You are now following this swap.", "success");

    } catch (error) {
      console.error("Error following swap:", error);
      showCustomAlert("❌ Failed to follow swap: " + error.message, "error");
    }
  } else {
    showCustomAlert("⚠ You are already following this swap.", "warning");
  }

  // Hide the loading spinner once the operation is complete
  document.getElementById("loadingSpinner").style.display = "none";
}



// Function to send an admin notification when a user follows a swap
async function sendFollowAdminNotification(swapId, currentUser) {
  const swapRef = db.collection("teacherSwaps").doc(swapId);
  const swapDoc = await swapRef.get();

  if (!swapDoc.exists) {
    console.error("Swap not found!");
    return;
  }

  const swapData = swapDoc.data();
  const swapName = swapData.name || "Swap";

  const notifRef = db.collection("adminNotifications").doc();
  await notifRef.set({
    type: "Swap Follow",
    swapId: swapId,
    swapName: swapName,
    userId: currentUser.uid,
    userEmail: currentUser.email,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `📍 User ${currentUser.email} has followed swap "${swapName}".`,
  });

  console.log("Admin notification sent for swap follow.");
}

async function toggleSwapStatus(swapId) {
  const spinner = document.getElementById('loadingSpinner'); // Assuming you have a spinner element with this ID
  spinner.style.display = 'block'; // Show spinner
  
  try {
    const swapDoc = await db.collection("teacherSwaps").doc(swapId).get();
    const swapData = swapDoc.data();

    if (!swapData) {
      showCustomAlert("❌ Swap not found.", "error");
      spinner.style.display = 'none'; // Hide spinner
      return;
    }

    const newStatus = !swapData.isClosed;

    await db.collection("teacherSwaps").doc(swapId).update({
      isClosed: newStatus
    });

    if (newStatus) {
      showCustomAlert("✅ Swap marked as closed.", "success");
      sendAdminNotification(
        "Swap Closed",
        swapData.teacherName,
        `Swap request for ${swapData.teacherName} has been closed.`
      );
    } else {
      showCustomAlert("♻️ Swap reopened successfully.", "success");
      sendAdminNotification(
        "Swap Reopened",
        swapData.teacherName,
        `Swap request for ${swapData.teacherName} has been reopened.`
      );
    }

    loadSwaps(); // Refresh view
  } catch (error) {
    console.error("❌ Error updating swap status:", error);
    showCustomAlert("❌ Failed to update swap: " + error.message, "error");
  } finally {
    spinner.style.display = 'none'; // Hide spinner in case of success or error
  }
}



// Function to send an admin notification when a swap is closed
async function sendSwapClosedAdminNotification(swapId) {
  const swapRef = db.collection("teacherSwaps").doc(swapId);
  const swapDoc = await swapRef.get();

  if (!swapDoc.exists) {
    console.error("Swap not found!");
    return;
  }

  const swapData = swapDoc.data();
  const swapName = swapData.name || "Swap";

  const notifRef = db.collection("adminNotifications").doc();
  await notifRef.set({
    type: "Swap Closure",
    swapId: swapId,
    swapName: swapName,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `🔒 Swap "${swapName}" (ID: ${swapId}) has been closed.`,
  });

  console.log("Admin notification sent for swap closure.");
}


// Function to boost the swap 
async function boostSwap(swapId) {
  const currentUser = firebase.auth().currentUser;

  if (!currentUser) {
    showCustomAlert("You must be logged in to boost swaps.", "error");
    return;
  }

  // Check if the current user is an admin
  const isAdminUser = isAdmin === true;

  // Show the loading spinner while processing the boost action
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    if (isAdminUser) {
      // Admins boost the swap for free
      await updateSwapBoostStatus(swapId, true);
      showCustomAlert("✅ The swap has been boosted for free!", "success");

      // Send an admin notification
      await sendBoostAdminNotification(swapId, currentUser.uid, "admin");

    } else {
      // Show the payment modal for boosting (non-admin)
      showPaymentModalFor('boost', 250, swapId, 'Boost Swap');

      // Send an admin notification (non-admin boosting)
      await sendBoostAdminNotification(swapId, currentUser.uid, "user");
    }
  } catch (error) {
    console.error("❌ Error boosting swap:", error);
    showCustomAlert("❌ Failed to boost swap: " + error.message, "error");
  } finally {
    // Hide the loading spinner once the process is complete (whether successful or failed)
    document.getElementById("loadingSpinner").style.display = "none";
  }
}


// Function to update the swap boost status in Firestore
async function updateSwapBoostStatus(swapId, boostStatus) {
  const swapRef = firebase.firestore().doc(`teacherSwaps/${swapId}`);
  await swapRef.update({
    boosted: boostStatus,
    boostTimestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
}

// Function to send an admin notification when a swap is boosted
async function sendBoostAdminNotification(swapId, userId, userType) {
  const swapRef = firebase.firestore().doc(`teacherSwaps/${swapId}`);
  const swapDoc = await swapRef.get();

  if (!swapDoc.exists) {
    console.error("Swap not found!");
    return;
  }

  const swapData = swapDoc.data();
  const swapName = swapData.name || "Swap";

  const notifRef = firebase.firestore().collection("adminNotifications").doc();
  await notifRef.set({
    type: "Swap Boost",
    swapId: swapId,
    userId: userId,
    swapName: swapName,
    userType: userType, // either 'admin' or 'user'
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `🚀 ${userType === "admin" ? "Admin" : "User"} boosted the swap "${swapName}" (ID: ${swapId}).`,
  });

  console.log("Admin notification sent for swap boost.");
}

// ✅ Dummy fallback so you never get "sendAdminNotification is not defined"
function sendAdminNotification(message) {
  console.log("Admin notification:", message);
}


// Helper function to update the swap boost status in Firestore
async function updateSwapBoostStatus(swapId, isBoosted) {
  const swapRef = db.collection("teacherSwaps").doc(swapId);
  await swapRef.update({
    boosted: isBoosted,
    boostExpiry: isBoosted ? firebase.firestore.Timestamp.fromDate(new Date()) : null
  });

  // Optionally, update UI or notify user of success
  const boostButton = document.getElementById(`boostSwapBtn-${swapId}`);
  if (boostButton) {
    boostButton.innerText = "🚀 Boosted (Free)";
    boostButton.disabled = true;
  }
}

// ✅ Trending section renderer (add below loadSwaps)
function renderTrendingSectionFromSwapsOnly() {
  const container = document.getElementById("trendingContainer");
  if (!container) return;

  container.innerHTML = "";

  if (trendingBoostedSwaps.length === 0) {
    container.innerHTML = "<p style='text-align:center;'>No trending swaps at the moment.</p>";
    return;
  }
}

async function sendSwapInterest(swapId, teacherName) {
  try {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      showCustomAlert("You must be logged in to express interest.", "error");
      return;
    }

    // Show the loading spinner while the interest is being sent
    document.getElementById("loadingSpinner").style.display = "flex";

    // Save the interest
    await db.collection("swapInterests").add({
      swapId,
      teacherName,
      interestedBy: currentUser.uid,
      interestedByName: currentUser.displayName || currentUser.email,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Send admin notification
    await sendAdminNotification(swapId, teacherName, currentUser.displayName || currentUser.email);

    // 🔔 Notify swap poster
    const swapDoc = await db.collection("teacherSwaps").doc(swapId).get();
    if (swapDoc.exists) {
      const swapData = swapDoc.data();
      const posterId = swapData.userId;

      // Only notify if not the same user
      if (posterId && posterId !== currentUser.uid) {
        await db.collection("alerts").add({
          title: "📬 Swap Interest",
          message: `${currentUser.displayName || "Someone"} is interested in your swap for ${swapData.subjectCombination}.`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          targetUserId: posterId
        });
      }
    }

    // ✅ Always show success if everything worked
    showCustomAlert(`✅ Your interest in ${teacherName}'s swap has been sent!`, "success");

  } catch (error) {
    console.error("Error sending interest:", error);
    showCustomAlert("❌ Failed to send interest: " + error.message, "error");
  } finally {
    // ✅ Hide the spinner once the process is complete
    document.getElementById("loadingSpinner").style.display = "none";
  }
}

// ✅ BOM Job Submit (with Public & Admin Notifications)
document.getElementById("bomJobForm").addEventListener("submit", async e => {
  e.preventDefault();

  if (!currentUser) {
    return showCustomAlert("Please login to post a job.", "error");
  }

  const now = new Date();
  const fullDate = now.toLocaleString();
  const email = currentUser.email || "unknown@user.com";
  const firstName = email.split("@")[0].split(/[._]/)[0];

  document.getElementById("bomDate").value = fullDate;
  document.getElementById("bomPostedBy").value = capitalize(firstName);

  const job = {
    organization: document.getElementById("bomOrg").value.trim(),
    jobType: document.getElementById("bomJobType").value.trim(),
    phone: document.getElementById("bomPhone").value.trim(),
    subCounty: document.getElementById("bomSubCounty").value,
    county: document.getElementById("bomCounty").value,
    salaryRange: document.getElementById("bomSalaryRange").value.trim(),
    datePosted: fullDate,
    postedBy: capitalize(firstName),
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  // Show the loading spinner while posting the job
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    // ✅ Save job to Firestore
    await bomRef.add(job);

    // ✅ Show success message
    showCustomAlert("✅ Job posted successfully!", "success");

    // ✅ Reset the form and reload job listings
    document.getElementById("bomJobForm").reset();
    loadBOMJobs();

    // ✅ Optional: Notify relevant users (matching services logic)
    notifyMatchingServiceProviders(job);

    // ✅ Admin Notification
    await db.collection("adminNotifications").add({
      type: "BOM Job Post",
      message: `New job posted: ${job.jobType} by ${job.organization}, Salary: ${job.salaryRange}, Phone: ${job.phone}, County: ${job.county}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });

    // ✅ Public Alert (visible to all users)
    const alertDoc = await db.collection("alerts").add({
      title: "📢 New Job",
      message: `${job.organization} just posted a ${job.jobType} job in ${job.county}, ${job.subCounty}. 💰 Salary: ${job.salaryRange}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null,
      category: "bom",  // helpful for filtering by type
      county: job.county
    });

    console.log("✅ BOM alert created with ID:", alertDoc.id);

  } catch (err) {
    // ✅ Show error message
    showCustomAlert("❌ Error posting job: " + err.message, "error");
  } finally {
    // ✅ Hide the loading spinner once the job is posted or an error occurs
    document.getElementById("loadingSpinner").style.display = "none";
  }
});



// ✅ Notify Matching Service Providers
function notifyMatchingServiceProviders(job) {
  servicesRef.get().then(snapshot => {
    snapshot.forEach(doc => {
      const service = doc.data();
      const occupationMatch = service.svcOccupation?.toLowerCase() === job.jobType.toLowerCase();
      const countyMatch = service.svcCounty === job.county;

      if (occupationMatch && countyMatch) {
        const message = `🛎 Job Opportunity Matching Your Services!\nJob: ${job.jobType}\nPosted by: ${job.postedBy}\nPhone: ${job.phone}\nCounty: ${job.county}`;

        db.collection("notifications").add({
          userId: doc.id, // Or svcPhone as unique key
          message,
          timestamp: new Date()
        });
      }
    });
  });
}

// ✅ Utility to capitalize first letter
function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}
let bomJobsCache = [];
let jobToDeleteId = null;
let trendingBoostedItems = []; // Combined trending (jobs, swaps, etc.)

// ✅ Load BOM Jobs with Boost Logic (No Trending Integration)
async function loadBOMJobs() {
  const container = document.getElementById("jobContainer");
  container.innerHTML = "";

  try {
    const snapshot = await bomRef.orderBy("timestamp", "desc").get();
    const now = new Date();
    bomJobsCache = [];

    for (const doc of snapshot.docs) {
      const data = doc.data();
      const boostExpiry = data.boostExpiry?.toDate?.();
      const isBoosted = data.boosted && boostExpiry && boostExpiry > now;

      if (data.boosted && (!boostExpiry || boostExpiry <= now)) {
        await bomRef.doc(doc.id).update({ boosted: false, boostExpiry: null });
      }

      const job = { id: doc.id, ...data, isBoosted, boostExpiry };
      bomJobsCache.push(job);
    }

    console.log("✅ Loaded BOM Jobs:", bomJobsCache);
    renderBOMJobs(bomJobsCache); // ✅ Render only BOM Jobs (without trending section)

  } catch (err) {
    showCustomAlert("❌ Failed to load jobs: " + err.message, "error");
  }
}
function renderBOMJobs(jobs) {
  const container = document.getElementById("jobContainer");
  container.innerHTML = "";

  if (!jobs.length) {
    container.innerHTML = `<p>🌝🌝🌝🌝Oops, no jobs found🌝🌝🌝</p>`;
    return;
  }

  const hasAccess = hasBomJobAccess();

  // ✅ Sort: Boosted first, then by timestamp
  jobs.sort((a, b) => {
    const now = new Date();
    const aBoosted = a.isBoosted && a.boostExpiry?.toDate?.() > now;
    const bBoosted = b.isBoosted && b.boostExpiry?.toDate?.() > now;

    if (aBoosted && bBoosted) {
      return (b.boostExpiry?.toDate?.() || 0) - (a.boostExpiry?.toDate?.() || 0);
    }
    if (aBoosted && !bBoosted) return -1;
    if (!aBoosted && bBoosted) return 1;

    return (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0);
  });

  jobs.forEach(job => {
    const card = document.createElement("div");
    card.className = "job-card";
    card.style.cssText = `
      position: relative;
      border: 1px solid #ddd;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      background: #fff;
      text-align: center;
    `;

    const isPoster = currentUser && (job.postedBy === currentUser.email || job.postedBy === currentUser.displayName);
    const isVerified = !!job.verified;

    const badge = isVerified
      ? `<div class="verified-badge"><i class="fas fa-check-circle"></i> Verified</div>` 
      : "";

    // ✅ Show "Verify Now" button for Admin if not verified
    const verifyButton = (!isVerified && isAdmin)
      ? `<button onclick="adminVerifyItem('job', '${job.id}')"
          style="background:#4CAF50; color:white; border:none; border-radius:5px; padding:6px 12px; cursor:pointer; margin-top:6px;">
          ✅ Verify Now (Admin)
        </button>`
      : "";

    const salaryIcon = '<i class="fas fa-dollar-sign" style="margin-right: 8px;"></i>';
    const locationIcon = '<i class="fas fa-map-marker-alt" style="margin-right: 8px;"></i>';
    const phoneIcon = '<i class="fas fa-phone-alt" style="margin-right: 8px;"></i>';
    const dateIcon = '<i class="fas fa-calendar-day" style="margin-right: 8px;"></i>';

    let boostBadge = "";
    let topCornerTag = "";

    if (job.isBoosted && job.boostExpiry) {
      const daysLeft = Math.ceil((job.boostExpiry - new Date()) / (1000 * 60 * 60 * 24));
      boostBadge = `
        <span style="background: orange; color: white; font-size: 0.75em; padding: 2px 6px; border-radius: 6px;">
          🔥 Trending Now
        </span>
        <span style="color: gray; font-size: 0.75em;">(${daysLeft} day${daysLeft !== 1 ? "s" : ""} left)</span>
      `;
      topCornerTag = `
        <div style="
          position: absolute;
          top: 8px;
          right: 8px;
          background: #f44336;
          color: white;
          font-size: 0.75em;
          padding: 4px 8px;
          border-radius: 6px;
          font-weight: bold;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        ">
          🔥 TRENDING
        </div>
      `;
    }

    const jobType = job.jobType?.toLowerCase() || "";
    let iconClass = "fa-user-tie";
    let bgColor = "#607d8b";

    if (jobType.includes("teacher")) iconClass = "fa-chalkboard-teacher", bgColor = "#42a5f5";
    else if (jobType.includes("developer")) iconClass = "fa-laptop-code", bgColor = "#42a5f5";
    else if (jobType.includes("designer")) iconClass = "fa-paint-brush", bgColor = "#9c27b0";
if (jobType.includes("teacher")) iconClass = "fa-chalkboard-teacher", bgColor = "#42a5f5";
else if (jobType.includes("developer")) iconClass = "fa-laptop-code", bgColor = "#42a5f5";
else if (jobType.includes("designer")) iconClass = "fa-paint-brush", bgColor = "#9c27b0";
else if (jobType.includes("chef")) iconClass = "fa-utensils", bgColor = "#8d6e63";

else if (jobType.includes("nurse")) iconClass = "fa-user-nurse", bgColor = "#e91e63";
else if (jobType.includes("doctor")) iconClass = "fa-user-md", bgColor = "#f44336";
else if (jobType.includes("driver")) iconClass = "fa-truck", bgColor = "#3f51b5";
else if (jobType.includes("pilot")) iconClass = "fa-plane", bgColor = "#2196f3";
else if (jobType.includes("mechanic")) iconClass = "fa-tools", bgColor = "#795548";
else if (jobType.includes("plumber")) iconClass = "fa-wrench", bgColor = "#607d8b";
else if (jobType.includes("electrician")) iconClass = "fa-bolt", bgColor = "#ff9800";
else if (jobType.includes("farmer")) iconClass = "fa-tractor", bgColor = "#4caf50";
else if (jobType.includes("engineer")) iconClass = "fa-cogs", bgColor = "#607d8b";
else if (jobType.includes("architect")) iconClass = "fa-drafting-compass", bgColor = "#9e9d24";
else if (jobType.includes("lawyer")) iconClass = "fa-balance-scale", bgColor = "#673ab7";
else if (jobType.includes("judge")) iconClass = "fa-gavel", bgColor = "#3e2723";
else if (jobType.includes("police")) iconClass = "fa-shield-alt", bgColor = "#1a237e";
else if (jobType.includes("security")) iconClass = "fa-user-shield", bgColor = "#000000";
else if (jobType.includes("firefighter")) iconClass = "fa-fire-extinguisher", bgColor = "#d32f2f";
else if (jobType.includes("scientist")) iconClass = "fa-flask", bgColor = "#00bcd4";
else if (jobType.includes("pharmacist")) iconClass = "fa-pills", bgColor = "#8e24aa";
else if (jobType.includes("dentist")) iconClass = "fa-tooth", bgColor = "#fbc02d";
else if (jobType.includes("veterinarian")) iconClass = "fa-paw", bgColor = "#8d6e63";
else if (jobType.includes("waiter")) iconClass = "fa-concierge-bell", bgColor = "#ff9800";
else if (jobType.includes("receptionist")) iconClass = "fa-phone", bgColor = "#4caf50";
else if (jobType.includes("sales")) iconClass = "fa-cash-register", bgColor = "#009688";
else if (jobType.includes("accountant")) iconClass = "fa-calculator", bgColor = "#3f51b5";
else if (jobType.includes("banker")) iconClass = "fa-university", bgColor = "#0d47a1";
else if (jobType.includes("marketer")) iconClass = "fa-bullhorn", bgColor = "#ff5722";
else if (jobType.includes("photographer")) iconClass = "fa-camera", bgColor = "#6a1b9a";
else if (jobType.includes("videographer")) iconClass = "fa-video", bgColor = "#c2185b";
else if (jobType.includes("model")) iconClass = "fa-user", bgColor = "#f48fb1";
else if (jobType.includes("actor")) iconClass = "fa-theater-masks", bgColor = "#ff9800";
else if (jobType.includes("musician")) iconClass = "fa-music", bgColor = "#5e35b1";
else if (jobType.includes("dj")) iconClass = "fa-headphones", bgColor = "#512da8";
else if (jobType.includes("tailor")) iconClass = "fa-cut", bgColor = "#ff7043";
else if (jobType.includes("cleaner")) iconClass = "fa-broom", bgColor = "#66bb6a";
else if (jobType.includes("translator")) iconClass = "fa-language", bgColor = "#0097a7";
else if (jobType.includes("tour guide")) iconClass = "fa-map-marked-alt", bgColor = "#43a047";
else if (jobType.includes("chef assistant")) iconClass = "fa-hamburger", bgColor = "#ff9800";
else if (jobType.includes("barista")) iconClass = "fa-coffee", bgColor = "#6d4c41";
else if (jobType.includes("butcher")) iconClass = "fa-drumstick-bite", bgColor = "#d84315";
else if (jobType.includes("baker")) iconClass = "fa-bread-slice", bgColor = "#f57c00";
else if (jobType.includes("fisherman")) iconClass = "fa-fish", bgColor = "#0288d1";
else if (jobType.includes("construction worker")) iconClass = "fa-hard-hat", bgColor = "#ffa000";
else if (jobType.includes("miner")) iconClass = "fa-gem", bgColor = "#616161";
else if (jobType.includes("scientist assistant")) iconClass = "fa-vials", bgColor = "#00897b";
else if (jobType.includes("social worker")) iconClass = "fa-hands-helping", bgColor = "#ff7043";
else if (jobType.includes("delivery")) iconClass = "fa-shipping-fast", bgColor = "#ef6c00";
else if (jobType.includes("call center")) iconClass = "fa-headset", bgColor = "#3949ab";
else if (jobType.includes("it support")) iconClass = "fa-server", bgColor = "#1e88e5";
else if (jobType.includes("hr manager")) iconClass = "fa-user-tie", bgColor = "#6d4c41";
else if (jobType.includes("seo specialist")) iconClass = "fa-search", bgColor = "#00acc1";
else if (jobType.includes("content writer")) iconClass = "fa-pen-nib", bgColor = "#ab47bc";
else if (jobType.includes("blogger")) iconClass = "fa-blog", bgColor = "#7b1fa2";
else if (jobType.includes("youtuber")) iconClass = "fa-video", bgColor = "#e53935";
else if (jobType.includes("data analyst")) iconClass = "fa-chart-line", bgColor = "#2e7d32";
else if (jobType.includes("data scientist")) iconClass = "fa-database", bgColor = "#1565c0";
else if (jobType.includes("ai engineer")) iconClass = "fa-robot", bgColor = "#00bcd4";
else if (jobType.includes("cyber security")) iconClass = "fa-user-secret", bgColor = "#263238";
else if (jobType.includes("blockchain")) iconClass = "fa-link", bgColor = "#ff6f00";
else if (jobType.includes("crypto trader")) iconClass = "fa-coins", bgColor = "#ffb300";
else if (jobType.includes("real estate")) iconClass = "fa-building", bgColor = "#8d6e63";
else if (jobType.includes("insurance agent")) iconClass = "fa-file-contract", bgColor = "#455a64";
else if (jobType.includes("loan officer")) iconClass = "fa-hand-holding-usd", bgColor = "#558b2f";
else if (jobType.includes("event planner")) iconClass = "fa-calendar-check", bgColor = "#9c27b0";
else if (jobType.includes("wedding planner")) iconClass = "fa-ring", bgColor = "#ff4081";
else if (jobType.includes("makeup artist")) iconClass = "fa-magic", bgColor = "#ec407a";
else if (jobType.includes("hair stylist")) iconClass = "fa-cut", bgColor = "#f06292";
else if (jobType.includes("barber")) iconClass = "fa-user", bgColor = "#8d6e63";
else if (jobType.includes("painter")) iconClass = "fa-paint-roller", bgColor = "#5d4037";
else if (jobType.includes("sculptor")) iconClass = "fa-sculpture", bgColor = "#6d4c41"; // Custom icon from FA Pro if available
else if (jobType.includes("carpenter")) iconClass = "fa-hammer", bgColor = "#795548";
else if (jobType.includes("tile setter")) iconClass = "fa-border-style", bgColor = "#9e9e9e";
else if (jobType.includes("welder")) iconClass = "fa-tools", bgColor = "#ff7043";
else if (jobType.includes("glass installer")) iconClass = "fa-glass-whiskey", bgColor = "#90a4ae";
else if (jobType.includes("roofer")) iconClass = "fa-home", bgColor = "#ff7043";
else if (jobType.includes("interior designer")) iconClass = "fa-couch", bgColor = "#6a1b9a";
else if (jobType.includes("landscaper")) iconClass = "fa-tree", bgColor = "#4caf50";
else if (jobType.includes("logger")) iconClass = "fa-tree", bgColor = "#2e7d32";
else if (jobType.includes("truck driver")) iconClass = "fa-truck-moving", bgColor = "#4e342e";
else if (jobType.includes("taxi driver")) iconClass = "fa-taxi", bgColor = "#fbc02d";
else if (jobType.includes("bus driver")) iconClass = "fa-bus", bgColor = "#f57c00";
else if (jobType.includes("train conductor")) iconClass = "fa-train", bgColor = "#3f51b5";
else if (jobType.includes("ship captain")) iconClass = "fa-anchor", bgColor = "#0d47a1";
else if (jobType.includes("flight attendant")) iconClass = "fa-plane-departure", bgColor = "#03a9f4";
else if (jobType.includes("airport staff")) iconClass = "fa-plane-arrival", bgColor = "#0288d1";
else if (jobType.includes("warehouse worker")) iconClass = "fa-boxes", bgColor = "#8d6e63";
else if (jobType.includes("packer")) iconClass = "fa-box", bgColor = "#a1887f";
else if (jobType.includes("logistics")) iconClass = "fa-shipping-fast", bgColor = "#009688";
else if (jobType.includes("supply chain")) iconClass = "fa-truck-loading", bgColor = "#ff9800";
else if (jobType.includes("quality inspector")) iconClass = "fa-clipboard-check", bgColor = "#388e3c";
else if (jobType.includes("project manager")) iconClass = "fa-tasks", bgColor = "#607d8b";
else if (jobType.includes("supervisor")) iconClass = "fa-user-tie", bgColor = "#455a64";
else if (jobType.includes("foreman")) iconClass = "fa-hard-hat", bgColor = "#ffa000";
else if (jobType.includes("researcher")) iconClass = "fa-microscope", bgColor = "#1e88e5";
else if (jobType.includes("teacher assistant")) iconClass = "fa-chalkboard", bgColor = "#64b5f6";
else if (jobType.includes("lecturer")) iconClass = "fa-user-graduate", bgColor = "#3949ab";
else if (jobType.includes("professor")) iconClass = "fa-graduation-cap", bgColor = "#283593";
else if (jobType.includes("coach")) iconClass = "fa-dumbbell", bgColor = "#f44336";
else if (jobType.includes("personal trainer")) iconClass = "fa-running", bgColor = "#ff7043";
else if (jobType.includes("lifeguard")) iconClass = "fa-life-ring", bgColor = "#0288d1";
else if (jobType.includes("swimming instructor")) iconClass = "fa-swimmer", bgColor = "#039be5";
else if (jobType.includes("pilot trainee")) iconClass = "fa-plane", bgColor = "#03a9f4";
else if (jobType.includes("intern")) iconClass = "fa-user-graduate", bgColor = "#8e24aa";
else if (jobType.includes("volunteer")) iconClass = "fa-hands-helping", bgColor = "#43a047";
    else if (jobType.includes("chef")) iconClass = "fa-utensils", bgColor = "#8d6e63";

    const iconHTML = `
      <div style="padding: 18px; background: ${bgColor};">
        <i class="fas ${iconClass}" style="font-size: 50px; color: #fff;"></i>
      </div>
    `;

    const contactSection = (isPoster || hasAccess || isAdmin)
      ? ` 
        <p style="color:#009688;">
          <strong>${phoneIcon}Phone:</strong><br>
          <a href="tel:${job.phone}" style="color:green;">📞 Call</a><br>
          <a href="https://wa.me/254${job.phone.replace(/^0/, '')}" target="_blank" style="color:#25D366;">💬 WhatsApp</a>
        </p>
        <button onclick="openChatModal('${job.phone}', '${job.organization}')"
          style="background:#673ab7; color:white; border:none; border-radius:5px; padding:6px 12px; cursor:pointer;">
          💬 Chat
        </button>` 
      : ` 
        <div class="blurred">
          <p style="color:gray;">🔒 Contacts Locked – Pay Ksh 350 to Unlock Contact</p>
        </div>
        <button onclick="unlockBomJobs()"
          style="background:crimson; color:white; padding:6px 12px; border:none; border-radius:6px;">
          💳 Pay Ksh 350
        </button>
      `;

    const actionButtons = `
      <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">

        ${(isPoster || isAdmin) ? ` 
          <button onclick="confirmDeleteBOMJob('${job.id}')"
            style="background:#dc3545; color:white; border:none; border-radius:5px; padding:6px 12px; cursor:pointer;">
            🗑️ Delete
          </button>` : ''} 

        ${isAdmin ? ` 
          <button onclick="boostJobFree('${job.id}')"
            style="background:#4caf50; color:white; border:none; border-radius:5px; padding:6px 12px; cursor:pointer;">
            🚀 Boost (Free)
          </button>` : ''}

        ${verifyButton}

 ${(isPoster || isAdmin) ? `
  <button onclick="closeJob('${job.id}')"
    style="background:#6c757d; color:white; border:none; border-radius:5px; padding:6px 12px; cursor:pointer;">
    ${job.isClosed ? '♻️ Reopen Job' : '🚫 Mark as Closed'}
  </button>` : ''}


        <button onclick="showInterest('${job.id}')"
          style="background:#ff9800; color:white; border:none; border-radius:5px; padding:6px 12px; cursor:pointer;">
          💼 Show Interest
        </button>

        <button onclick="followJob('${job.id}')"
          style="background:#2196f3; color:white; border:none; border-radius:5px; padding:6px 12px; cursor:pointer;">
          👀 Follow Job
        </button>

      </div>

      <p id="interest-count-${job.id}" style="font-size:0.8em; color: #8e24aa; margin-top:6px;">
        ${job.interestCount || 0} people interested
      </p>

      <p id="followed-count-${job.id}" style="font-size:0.8em; color: #2196f3; margin-top:4px;">
        0 people following
      </p>
    `;

    card.innerHTML = `
      ${topCornerTag}
      ${iconHTML}
      <div style="padding: 14px; text-align:left;">
        ${badge}
        <h3 style="color:#2e7d32;">${job.jobType} ${boostBadge} ${job.isClosed ? '<span style="color:red;">(Closed)</span>' : ''}</h3>

        <p style="color:#3f51b5;"><strong>Organization:</strong> ${job.organization}</p>
        ${contactSection}
        <p style="color:#e91e63;"><strong>${locationIcon}Location:</strong> ${job.county}, ${job.subCounty}</p>
        <p style="color:#ff9800;"><strong>${salaryIcon}Salary Range:</strong> KES ${parseInt(job.salaryRange).toLocaleString()}</p>
        <p style="color:#6a1b9a;"><strong>${dateIcon}Date Posted:</strong> ${job.datePosted}</p>
        <p style="color:#795548;"><strong>Posted By:</strong> ${job.postedBy || "Unknown"}</p>

        <div style="margin-top: 10px;">${actionButtons}</div>

        <div class="rating" data-id="${job.id}" style="margin-top: 10px;">
          <span class="avg-rating" id="avgRating-${job.id}">Loading...</span><br>
          ${[1, 2, 3, 4, 5].map(star => `
            <i class="fas fa-star" onclick="rateService('${job.id}', ${star})"
              style="cursor:pointer; color:#ccc;" id="star-${job.id}-${star}"></i>
          `).join('')}
        </div>
      </div>
    `;

    container.appendChild(card);
    updateFollowedCount(job.id);
    updateInterestCount(job.id);
  });
}

// Function to handle following a job 
function followJob(jobId) {
  const followButton = document.querySelector(`button[onclick="followJob('${jobId}')"]`);
  const followedCountElement = document.getElementById(`followed-count-${jobId}`);
  const user = firebase.auth().currentUser;

  if (!user) {
    showCustomAlert("Please log in to follow this job.", "error");
    return;
  }

  // Show the loading spinner while processing the follow/unfollow action
  document.getElementById("loadingSpinner").style.display = "flex";

  const userId = user.uid;
  const jobRef = firebase.firestore().doc(`bomJobs/${jobId}`);

  jobRef.get().then(async docSnapshot => {
    if (!docSnapshot.exists) {
      showCustomAlert("Job not found.", "error");
      document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner
      return;
    }

    const jobData = docSnapshot.data();
    const alreadyFollowing = jobData.followedUsers && jobData.followedUsers.includes(userId);

    try {
      if (alreadyFollowing) {
        // 👎 Unfollow
        followButton.innerText = "👀 Follow Job";
        followButton.classList.remove('followed');

        await jobRef.update({
          followedUsers: firebase.firestore.FieldValue.arrayRemove(userId),
          followedCount: firebase.firestore.FieldValue.increment(-1)
        });

        if (followedCountElement) {
          let currentCount = parseInt(followedCountElement.textContent) || 1;
          followedCountElement.textContent = `${currentCount - 1} following`;
        }

        showCustomAlert("❌ You unfollowed this job.", "warning");
        console.log("Unfollowed the job successfully.");

      } else {
        // 👍 Follow
        followButton.innerText = "👀 Following Job";
        followButton.classList.add('followed');

        await jobRef.update({
          followedUsers: firebase.firestore.FieldValue.arrayUnion(userId),
          followedCount: firebase.firestore.FieldValue.increment(1)
        });

        if (followedCountElement) {
          let currentCount = parseInt(followedCountElement.textContent) || 0;
          followedCountElement.textContent = `${currentCount + 1} following`;
        }

        showCustomAlert("✅ You are now following this job.", "success");
        console.log("Followed the job successfully.");

        // ✅ Notify the poster if not self
        const posterName = jobData.postedBy || "Poster";
        const posterId = jobData.userId || null;

        if (posterId && posterId !== userId) {
          await db.collection("alerts").add({
            title: "👥 Job Followed",
            message: `${user.displayName || user.email || "Someone"} followed your BOM job for ${jobData.jobType} at ${jobData.organization}.`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            targetUserId: posterId
          });
        }
      }
    } catch (error) {
      console.error("Error handling job follow/unfollow: ", error);
      showCustomAlert("❌ Failed to follow/unfollow job: " + error.message, "error");
    } finally {
      // Hide the loading spinner once the operation is complete
      document.getElementById("loadingSpinner").style.display = "none";
    }
  }).catch((error) => {
    console.error("Error handling job follow: ", error);
    showCustomAlert("❌ Failed to follow/unfollow job: " + error.message, "error");
    document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner
  });
}




// Function to update the followed count on page load (in case of page refresh)
function updateFollowedCount(jobId) {
  const followedCountElement = document.getElementById(`followed-count-${jobId}`);

  // Reference to the Firestore document for the job
  const jobRef = firebase.firestore().doc(`bomJobs/${jobId}`);

  // Listen for real-time updates to the job document
  jobRef.onSnapshot(docSnapshot => {
    if (docSnapshot.exists) {
      const jobData = docSnapshot.data();
      const followedCount = jobData.followedCount || 0;

      // Update the UI with the current followed count from Firestore
      followedCountElement.innerText = `${followedCount} people following`;
    }
  });
}

// Function to handle showing interest and updating followed count
function showInterest(jobId) {
  const user = firebase.auth().currentUser;
  const userId = user?.uid;

  if (!userId) {
    showCustomAlert("Please log in to show interest.", "error");
    return;
  }

  const followedCountElement = document.getElementById(`followed-count-${jobId}`);
  const jobRef = firebase.firestore().doc(`bomJobs/${jobId}`);

  // Show the loading spinner while processing the interest
  document.getElementById("loadingSpinner").style.display = "flex";

  jobRef.get().then(async docSnapshot => {
    if (!docSnapshot.exists) {
      showCustomAlert("Job not found.", "error");
      document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner
      return;
    }

    const jobData = docSnapshot.data();
    const alreadyFollowed = jobData.followedUsers && jobData.followedUsers.includes(userId);

    if (alreadyFollowed) {
      showCustomAlert("⚠️ You’ve already shown interest in this job!", "warning");
      document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner
      return;
    }

    try {
      // Add interest
      const followedCount = (jobData.followedCount || 0) + 1;
      const updatedFollowedUsers = jobData.followedUsers || [];
      updatedFollowedUsers.push(userId);

      await jobRef.update({
        followedCount: followedCount,
        followedUsers: updatedFollowedUsers
      });

      // Update UI
      if (followedCountElement) {
        followedCountElement.innerText = `${followedCount} people following`;
      }

      console.log("Followed count updated successfully.");
      showCustomAlert("✅ You’ve shown interest in this job.", "success");

      // ✅ Notify Admin
      await firebase.firestore().collection("adminNotifications").add({
        type: "Job Interest",
        jobId: jobId,
        userId: userId,
        message: `📌 User with ID ${userId} has shown interest in job ${jobId}.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });

      // ✅ Notify Poster
      const posterId = jobData.userId;
      const jobTitle = jobData.jobType || "a job";
      const organization = jobData.organization || "an organization";

      if (posterId && posterId !== userId) {
        await firebase.firestore().collection("alerts").add({
          title: "📌 New Job Interest",
          message: `${user.displayName || user.email || "Someone"} is interested in your job: ${jobTitle} at ${organization}.`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          targetUserId: posterId
        });
      }

      console.log("Admin and poster notified.");
    } catch (error) {
      console.error("Error updating followed count:", error);
      showCustomAlert("❌ Failed to register interest: " + error.message, "error");
    } finally {
      // Hide the spinner once the operation is complete
      document.getElementById("loadingSpinner").style.display = "none";
    }

  }).catch((error) => {
    console.error("Error fetching job data: ", error);
    showCustomAlert("❌ Failed to register interest: " + error.message, "error");
    document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner
  });
}



// Function to update the interest count on page load (in case of page refresh)
function updateInterestCount(jobId) {
  const interestCountElement = document.getElementById(`interest-count-${jobId}`);

  // Reference to the Firestore document for the job
  const jobRef = firebase.firestore().doc(`bomJobs/${jobId}`);

  // Listen for real-time updates to the job document
  jobRef.onSnapshot(docSnapshot => {
    if (docSnapshot.exists) {
      const jobData = docSnapshot.data();
      const interestCount = jobData.interestCount || 0;

      // Update the UI with the current interest count from Firestore
      interestCountElement.innerText = `${interestCount} people interested`;
    }
  });
}

// Call this function when the page is loaded or refreshed to sync the interest count
function onPageLoad(jobId) {
  updateInterestCount(jobId);
}

async function closeJob(jobId) {
  try {
    // Show the loading spinner while the operation is being processed
    document.getElementById("loadingSpinner").style.display = "flex";

    const jobRef = db.collection("bomJobs").doc(jobId);
    const jobSnap = await jobRef.get();

    if (!jobSnap.exists) {
      showCustomAlert("❌ Job not found.", "error");
      document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner
      return;
    }

    const currentStatus = jobSnap.data().isClosed || false;
    const newStatus = !currentStatus;

    await jobRef.update({
      isClosed: newStatus
    });

    if (newStatus) {
      showCustomAlert("✅ Job marked as closed.", "success");

      // Send admin notification about the job closure
      await db.collection("adminNotifications").add({
        type: "Job Closed",
        jobId: jobId,
        message: `🔒 A BOM Job with ID ${jobId} has been marked as closed.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });
    } else {
      showCustomAlert("♻️ Job reopened successfully.", "success");

      // Send admin notification about the job reopening
      await db.collection("adminNotifications").add({
        type: "Job Reopened",
        jobId: jobId,
        message: `✅ A BOM Job with ID ${jobId} has been reopened.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });
    }

    loadBOMJobs(); // Refresh job list

  } catch (error) {
    console.error("❌ Error updating job status:", error);
    showCustomAlert("❌ Failed to update job status: " + error.message, "error");
  } finally {
    // Hide the spinner once the operation is complete
    document.getElementById("loadingSpinner").style.display = "none";
  }
}



async function boostJobFree(jobId) {
  const boostExpiry = new Date();
  boostExpiry.setDate(boostExpiry.getDate() + 7); // 7-day boost

  try {
    // Show the loading spinner while the operation is being processed
    document.getElementById("loadingSpinner").style.display = "flex";

    // Update the job status with boosted details
    await db.collection("bomJobs").doc(jobId).update({
      isBoosted: true,
      boostExpiry: boostExpiry,
      timestamp: new Date()  // ✅ Important: force it to go top
    });

    showCustomAlert("✅ Job boosted for FREE by Admin", "success");
    loadBOMJobs(); // Refresh the list

    // Send admin notification about the free boost
    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: "Job Boosted Free",
      jobId: jobId,
      message: `💥 A BOM Job with ID ${jobId} has been boosted for FREE by Admin.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    });

    console.log("Admin notification sent for job boost.");

  } catch (error) {
    console.error("❌ Error boosting job:", error);
    showCustomAlert("❌ Failed to boost job: " + error.message, "error");
  } finally {
    // Hide the spinner once the operation is complete
    document.getElementById("loadingSpinner").style.display = "none";
  }
}



function hasBomJobAccess() {
  const paidAt = localStorage.getItem("paidForBomJobs");
  if (!paidAt) return false;

  const paidDate = new Date(paidAt);
  const now = new Date();
  const diffDays = (now - paidDate) / (1000 * 60 * 60 * 24);

  return diffDays <= 14; // valid for 2 weeks
}

// Function to unlock BOM Job contacts and send admin notification
async function unlockBomJobs() {
  if (!currentUser || !currentUser.uid) {
    showCustomAlert("Please login to unlock job contacts.", "error");
    return;
  }

  showPaymentModalFor("bomjobs", 350, currentUser.uid, "Job Contacts");

  const checkPaid = setInterval(async () => {
    if (localStorage.getItem("paidForBomJobs") === "yes") {
      clearInterval(checkPaid);
      showCustomAlert("Job contacts unlocked ", "success");
      closeUniversalModal();
      loadBOMJobs(); // re-render if function exists

      // Send admin notification for unlocked BOM job contacts
      try {
        const notifRef = db.collection("adminNotifications").doc();
        await notifRef.set({
          type: "BOM Job Contact Unlock",
          userId: currentUser.uid,
          message: `🔓 ${currentUser.email} has unlocked BOM Job contacts for 2 weeks.`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        });

        console.log("Admin notification sent for unlocked BOM job contacts.");
      } catch (error) {
        console.error("Failed to send admin notification:", error);
      }
    }
  }, 3000);
}
// ✅ Update Average Rating
async function updateAverageRating(jobId) {
  const ratingRef = db.collection("ratings").where("jobId", "==", jobId);
  const snapshot = await ratingRef.get();

  let totalRating = 0;
  let totalReviews = snapshot.size;

  snapshot.forEach(doc => {
    totalRating += doc.data().rating;
  });

  const avgRating = totalReviews ? (totalRating / totalReviews).toFixed(1) : 0;
  const avgRatingElement = document.getElementById(`avgRating-${jobId}`);

  avgRatingElement.textContent = `⭐ ${avgRating} (${totalReviews} Reviews)`;
}



function applyBOMFilters() {
  const jobType = document.getElementById("filterJobType")?.value.toLowerCase() || "";
  const county = document.getElementById("filterCounty")?.value || "";
  const subcounty = document.getElementById("filterSubCounty")?.value || "";
  const minSalary = parseInt(document.getElementById("filterSalary")?.value) || 0;

  const filtered = bomJobsCache.filter(job => {
    return (
      (!jobType || job.jobType.toLowerCase().includes(jobType)) &&
      (!county || job.county === county) &&
      (!subcounty || job.subCounty === subcounty) &&
      (!minSalary || parseInt(job.salaryRange) >= minSalary)
    );
  });

  renderBOMJobs(filtered);

  if (filtered.length === 0) {
    showCustomAlert("🚫 No matching BOM jobs found.", "warning");
  }
}

// ✅ Populate Sub-county Based on County
function handleCountyChange(countyId, subCountyId) {
  const county = document.getElementById(countyId).value;
  const subCountyEl = document.getElementById(subCountyId);
  subCountyEl.innerHTML = `<option value="">All Sub-counties</option>`;
  if (countySubCountyMap[county]) {
    countySubCountyMap[county].forEach(sub => {
      const option = document.createElement("option");
      option.value = sub;
      option.textContent = sub;
      subCountyEl.appendChild(option);
    });
  }
}

// ✅ Delete BOM Job and send admin notification
async function confirmDeleteBOMJob(jobId) {
  if (confirm("Are you sure you want to delete this job posting?")) {
    // Show loading spinner while the deletion is processing
    document.getElementById("loadingSpinner").style.display = "flex";

    try {
      const jobRef = bomRef.doc(jobId);
      const jobSnap = await jobRef.get();
      if (!jobSnap.exists) {
        showCustomAlert("❌ Job not found.", "error");
        return;
      }

      const jobData = jobSnap.data();
      const jobTitle = jobData.title || "Unknown Job";

      // Delete the job posting
      await jobRef.delete();
      showCustomAlert("✅ Job deleted successfully!", "success");

      // Send an admin notification
      const notifRef = db.collection("adminNotifications").doc();
      await notifRef.set({
        type: "Job Deletion",
        itemId: jobId,
        itemTitle: jobTitle,
        message: `🚨 BOM job titled "${jobTitle}" was deleted.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Refresh the job listings
      loadBOMJobs(); 

    } catch (err) {
      showCustomAlert("❌ Failed to delete job: " + err.message, "error");
    } finally {
      // Hide the spinner once the operation is complete
      document.getElementById("loadingSpinner").style.display = "none";
    }
  }
}


  // ✅ Alert Helper
  function showCustomAlert(msg, type = "info") {
    const el = document.createElement("div");
    el.className = "alert";
    el.style.backgroundColor = type === "error" ? "#f44336" : "#4CAF50";
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }

  // ✅ Load home page first
  attachServiceFormSubmit();  // ✅ Call this ONCE
showPage("home");

 // ✅ Alert Utility
  function showCustomAlert(msg, type = "info") {
    const el = document.createElement("div");
    el.className = "alert";
    el.style.backgroundColor = type === "error" ? "#f44336" : "#4CAF50";
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }
document.getElementById("resourceForm").addEventListener("submit", async e => {
  e.preventDefault();
  if (!isLoggedIn) return showCustomAlert("Please login to upload resources.", "error");

  const file = document.getElementById("resourceFile").files[0];
  const title = document.getElementById("resourceTitle").value.trim();
  const price = document.getElementById("resourcePrice").value.trim();

  if (!file || !title || !price) return showCustomAlert("All fields required.", "error");

  const filePath = `resources/${Date.now()}_${file.name}`;
  const uploadTask = await storage.ref(filePath).put(file);
  const downloadURL = await uploadTask.ref.getDownloadURL();

  await resourceRef.add({
    title,
    price,
    downloadURL,
    filePath,
    uploadedBy: currentUser.uid,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  showCustomAlert("✅ Resource uploaded!", "success");
  document.getElementById("resourceForm").reset();
  loadResources();
});
async function loadResources() {
  const tbody = document.querySelector("#resourcesTable tbody");
  tbody.innerHTML = "";

  const snapshot = await resourceRef.orderBy("timestamp", "desc").get();
  if (snapshot.empty) {
    tbody.innerHTML = `<tr><td colspan="3">No resources yet.</td></tr>`;
    return;
  }

  snapshot.forEach(doc => {
    const data = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.title}</td>
      <td>${data.price}</td>
 <td>
  ${isAdmin ? `<a href="${data.downloadURL}" target="_blank">Download</a>` :
    hasPaid ? `<a href="${data.downloadURL}" target="_blank">Download</a>` :
    `<button onclick="showPaymentModal()">Pay to Download</button>`}
</td>
`;
    tbody.appendChild(tr);
  });
}
// ✅ Populate counties for soulmate form
["smCounty", "smWorkCounty"].forEach(populateCounties);
document.getElementById("soulmateForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!currentUser) {
    showCustomAlert("Please login to post your profile.", "error");
    return;
  }

  const age = parseInt(document.getElementById("smAge").value.trim());
  if (isNaN(age) || age < 18) {
    showCustomAlert("⚠️ Age must be 18 or above to post a profile.", "error");
    return;
  }

  const phone = document.getElementById("smPhone").value.trim();

  // ✅ Kenyan phone validation
  if (!/^07\d{8}$/.test(phone) && !/^2547\d{8}$/.test(phone)) {
    showCustomAlert("⚠️ Enter a valid Kenyan phone number (e.g. 0712345678 or 254712345678).", "error");
    return;
  }

  // ✅ Prevent duplicate phone use
  try {
    const existing = await soulmateRef.where("phone", "==", phone).get();
    if (!existing.empty) {
      showCustomAlert("⚠️ This phone number is already used in another profile.", "error");
      return;
    }
  } catch (err) {
    showCustomAlert("❌ Failed to check existing phone numbers.", "error");
    return;
  }

  const photoFile = document.getElementById("smPhoto").files[0];
  let photoURL = "";

  // Show the loading spinner while processing
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    // ✅ Upload photo if available
    if (photoFile) {
      const photoPath = `soulmatePhotos/${Date.now()}_${photoFile.name}`;
      const photoSnap = await storage.ref(photoPath).put(photoFile);
      photoURL = await photoSnap.ref.getDownloadURL();
    }

    const data = {
      name: document.getElementById("smName").value.trim(),
      county: document.getElementById("smCounty").value,
      subCounty: document.getElementById("smSubCounty").value,
      age,
      tribe: document.getElementById("smTribe").value.trim(),
      sex: document.getElementById("smSex").value,
      occupation: document.getElementById("smOccupation").value.trim(),
      workCounty: document.getElementById("smWorkCounty").value,
      phone,
      status: document.getElementById("smStatus").value,
      kids: document.getElementById("smKids").value,
      photoURL,
      postedBy: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    await soulmateRef.add(data);
    showCustomAlert("✅ Profile submitted!", "success");
    document.getElementById("soulmateForm").reset();
    loadSoulmates();

    // ✅ Notify Admin
    await db.collection("adminNotifications").add({
      type: "Soulmate Profile",
      message: `New soulmate profile posted: ${data.name}, Age: ${data.age}, Phone: ${data.phone}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });

    // ✅ Notify All Users via Global Alert
    await db.collection("alerts").add({
      title: "💘 New Soulmate Profile",
      message: `${data.name} (${data.sex}, ${data.age} yrs) just posted a profile.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null // public to all users
    });

  } catch (err) {
    console.error("Error saving profile:", err);
    showCustomAlert("❌ Error saving profile: " + err.message, "error");
  } finally {
    // Hide the spinner once the process completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
});

// Real-time listener for like changes on the profile
function listenForLikeChanges(profileId) {
  soulmateRef.doc(profileId).collection("likes").onSnapshot(snapshot => {
    const count = snapshot.size; // The number of likes for this profile
    const likeCountSpan = document.getElementById(`likeCount-${profileId}`);
    
    if (likeCountSpan) {
      likeCountSpan.textContent = `${count} Like${count !== 1 ? 's' : ''}`;
    }
  });
}

// Function to toggle like (like/unlike)
async function toggleLike(profileId) {
  const user = firebase.auth().currentUser;
  if (!user) {
    alert("Please login to like profiles.");
    return;
  }

  const likeRef = soulmateRef.doc(profileId).collection("likes").doc(user.uid);
  const likeDoc = await likeRef.get();

  const profileDoc = await soulmateRef.doc(profileId).get();
  const profileData = profileDoc.data();
  const theirUid = profileData?.postedBy;

  if (likeDoc.exists) {
    // 👎 Unlike
    await likeRef.delete();
  } else {
    // 👍 Like
    await likeRef.set({
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      user: user.displayName || user.email || user.uid
    });

    // ✅ Match check
    if (theirUid && theirUid !== user.uid) {
      const reverseLikeDoc = await soulmateRef.doc(profileId).collection("likes").doc(theirUid).get();
      if (reverseLikeDoc.exists) {
        showMatchCelebration(); // 🎉 trigger match effect
      }
    }

    // ✅ Send Alert to Profile Owner
    if (theirUid && theirUid !== user.uid) {
      await db.collection("alerts").add({
        title: "💖 New Like",
        message: `${user.displayName || "Someone"} liked your soulmate profile.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        targetUserId: theirUid
      });
    }
  }

  updateLikeUI(profileId); // Update the UI after liking/unliking
}


// Function to update like count and button status
async function updateLikeUI(profileId) {
  const user = firebase.auth().currentUser;
  const likeSnap = await soulmateRef.doc(profileId).collection("likes").get();
  const count = likeSnap.size; // The number of likes for this profile

  const likeCountSpan = document.getElementById(`likeCount-${profileId}`);
  const likeBtn = document.getElementById(`likeBtn-${profileId}`);

  if (likeCountSpan) likeCountSpan.textContent = `${count} Like${count !== 1 ? 's' : ''}`;

  if (user && likeBtn) {
    const liked = await soulmateRef.doc(profileId).collection("likes").doc(user.uid).get();
    likeBtn.innerHTML = liked.exists ? "❤️ Liked" : "🤍 Like";
  }
}

async function showLikes(profileId) {
  const likesRef = soulmateRef.doc(profileId).collection("likes");
  const snapshot = await likesRef.get();

  if (snapshot.empty) {
    alert("No likes yet.");
    return;
  }

  const likesList = document.getElementById("likesList");
  likesList.innerHTML = ""; // Clear previous entries

  for (const doc of snapshot.docs) {
    const userName = doc.data().user || `User ID: ${doc.id}`;
    const listItem = document.createElement("li");
    listItem.textContent = userName;
    likesList.appendChild(listItem);
  }

  // Show modal
  document.getElementById("likesModal").style.display = "flex";

  // Notify admin
  sendAdminNotification(
    "Soulmate Profile Likes Viewed",
    currentUser.uid,
    `The likes for soulmate profile ID ${profileId} were viewed.`
  );
}
function closeLikesModal() {
  document.getElementById("likesModal").style.display = "none";
}

function handleBackdropClick(event) {
  const modalContent = document.querySelector(".likes-modal-content");
  if (!modalContent.contains(event.target)) {
    closeLikesModal();
  }
}


// Helper function to send admin notification
async function sendAdminNotification(type, userId, message) {
  try {
    // Get user details (name/email) based on the userId
    const userSnap = await db.collection("users").doc(userId).get();
    const user = userSnap.data();

    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: type,
      userId: userId,
      userName: user ? user.displayName || user.email : "Unknown User",
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: message
    });

    console.log("Admin notification created: " + message);
  } catch (error) {
    console.error("Error sending admin notification:", error);
  }
}
async function loadSoulmates() {
  const container = document.querySelector("#soulmateContainer");
  const trendingContainer = document.querySelector("#trendingContainer");
  container.innerHTML = "";
  if (trendingContainer) trendingContainer.innerHTML = "";

  const minAge = parseInt(document.getElementById("filterMinAge")?.value || 0);
  const maxAge = parseInt(document.getElementById("filterMaxAge")?.value || 100);
  const tribeFilter = document.getElementById("filterTribe")?.value.toLowerCase().trim() || "";
  const sexFilter = document.getElementById("filterSex")?.value || "";
  const sortBy = document.getElementById("sortByLikes")?.value || "recent";

  const hasPaid = localStorage.getItem("paidForSoulmates") === "yes";
  const now = new Date();

  const snapshot = await soulmateRef.get();
  if (snapshot.empty) {
    container.innerHTML = `<div style="text-align:center;padding:20px;color:#999;">💔 No soulmate profiles found</div>`;
    return;
  }

  let boosted = [], normal = [];

  for (const doc of snapshot.docs) {
    const d = doc.data();
    const id = doc.id;
    const age = parseInt(d.age) || 0;
    if (age < minAge || age > maxAge) continue;
    if (tribeFilter && (!d.tribe || !d.tribe.toLowerCase().includes(tribeFilter))) continue;
    if (sexFilter && d.sex !== sexFilter) continue;

    const boostExpiry = d.boostExpiry?.toDate?.();
    const isBoosted = d.boosted && boostExpiry && boostExpiry > now;

    if (d.boosted && (!boostExpiry || boostExpiry <= now)) {
      await soulmateRef.doc(id).update({ boosted: false, boostExpiry: null });
    }

    const profile = { id, ...d, isBoosted };
    if (isBoosted) {
      boosted.push(profile);
      trendingBoostedItems.push({ id, ...d, type: 'soulmate' });
    } else {
      normal.push(profile);
    }
  }

  const sortedProfiles = [...boosted, ...normal].sort((a, b) => {
    const now = new Date();
    const aBoosted = a.isBoosted && a.boostExpiry > now;
    const bBoosted = b.isBoosted && b.boostExpiry > now;
    if (aBoosted && bBoosted) return (b.boostExpiry || 0) - (a.boostExpiry || 0);
    if (aBoosted && !bBoosted) return -1;
    if (!aBoosted && bBoosted) return 1;
    return (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0);
  });

  if (sortedProfiles.length === 0) {
    container.innerHTML = `<div style="text-align:center;padding:20px;color:#999;">💔 No soulmate profiles found</div>`;
    return;
  }

  sortedProfiles.forEach(d => {
    const id = d.id;
    const isPoster = currentUser && (d.postedBy === currentUser.uid);
    const isAdminUser = isAdmin === true;
    const totalLikes = d.likes || 0;

    const card = document.createElement("div");
    card.className = "soulmate-card";
    card.id = `soulmate-${id}`;
    card.style = `
      background: #e6f7ff;
      padding: 14px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      text-align: left;
      position: relative;
      min-width: 220px;
      max-width: 240px;
      box-sizing: border-box;
    `;

    const contactHTML = `
      <div style="margin:4px 0;">
        📞 <a href="tel:${d.phone}" style="color:green;">${d.phone}</a><br>
        💬 <a href="https://wa.me/254${d.phone.replace(/^0/, '')}" target="_blank" style="color:#25D366;">WhatsApp</a>
      </div>`;

    const blurredContactHTML = `
      <div style="margin:4px 0;">
        📞 <span style="filter:blur(4px);">0700000000</span><br>
        💬 <span style="filter:blur(4px);">WhatsApp</span>
        <div style="margin-top:6px;color:crimson;font-size:13px;">🔒 Pay Ksh 200 to Unlock</div>
        <button onclick="unlockSoulmateContacts()" style="margin-top:5px;background:crimson;color:white;border:none;padding:4px 10px;border-radius:4px;">💳 Pay</button>
      </div>`;

 card.innerHTML = `
  ${d.verified ? `<div class="verified-badge" style="
    position: absolute;
    top: 8px;
    right: 8px;
    background-color: #1DA1F2;  /* Twitter blue */
    color: white;
    border-radius: 25%;
    width: 13px;
    height: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 6px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease-in-out;
    cursor: pointer;
  ">
    <i class="fas fa-check" style="transform: scale(1.2);"></i>
  </div>` : ""}

      ${!d.verified && isPoster && !isAdminUser ? `
        <button onclick="showPaymentModalFor('soulmateVerification', 200, '${id}', '${d.name || ''}')"
          style="position:absolute;top:8px;right:8px;background:#4CAF50;color:white;border:none;padding:4px 8px;border-radius:6px;font-size:12px;cursor:pointer;">
          ✅ Get Verified – Ksh 200
        </button>` : ""}

      ${!d.verified && isAdminUser ? `
        <button onclick="adminVerifyItem('soulmate', '${id}')"
          style="position:absolute;top:8px;right:8px;background:#2196F3;color:white;border:none;padding:4px 8px;border-radius:6px;font-size:12px;cursor:pointer;">
          🛡️ Verify Now (Admin)
        </button>` : ""}

      ${d.isBoosted ? `<div style="position:absolute;top:8px;left:8px;background:#ff9800;color:white;border-radius:4px;padding:2px 8px;font-size:12px;">🔥 Boosted</div>` : ""}
      ${d.isClosed ? `<div style="position:absolute;bottom:8px;left:8px;background:#f44336;color:white;border-radius:4px;padding:2px 8px;font-size:12px;">🚫 Closed</div>` : ""}

      <div style="margin-top:24px;">
        <i class="fas ${d.sex === 'Male' ? 'fa-user-tie' : 'fa-user-nurse'}" style="font-size:46px; color:${d.sex === 'Male' ? '#3f51b5' : '#e91e63'};"></i>
      </div>
      <h4 style="margin:0 0 6px;font-size:16px;"><strong>Name:</strong> ${d.name}</h4>
      <p style="margin:0;color:#ff5722;"><strong>Sex:</strong> ${d.sex ? `${d.sex === 'Male' ? '♂️' : '♀️'} ${d.sex}` : '—'}</p>
      <p style="margin:0;"><strong>Location:</strong> <span style="color:#009688;">${d.county || '—'}</span>${d.subCounty ? ` / <span style="color:#6a1b9a;">${d.subCounty}</span>` : ''}</p>
      <p style="margin:0;color:#6a1b9a;"><strong>Tribe:</strong> ${d.tribe || '—'}</p>
      <p style="margin:0;color:#ff5722;"><strong>Age:</strong> ${d.age}</p>
      <p style="margin:0;color:#795548;"><strong>Status:</strong> ${d.status || '—'} ${d.status === "Single" ? "💔" : d.status === "Married" ? "💍" : ""}</p>
      <p style="margin:0;color:#607d8b;"><strong>Occupation:</strong> ${d.occupation}</p>

      <div style="margin-top:6px;">
        ${hasPaid || isPoster || isAdminUser ? contactHTML : blurredContactHTML}
      </div>

      <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
        <button id="likeBtn-${id}" onclick="toggleLike('${id}')" 
          style="background:#e91e63; color:white; border:none; padding:5px 12px; border-radius:50px; cursor:pointer;">
          🤍 Like
        </button>
        <span id="likeCount-${id}" style="font-weight:bold; cursor:pointer;" onclick="showLikes('${id}')">
          ${totalLikes} Likes
        </span>
      </div>

      ${(isPoster || isAdminUser) ? `
        <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;">
          <button onclick="deleteSoulmate('${id}')" 
            style="background:#dc3545; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer;">
            🗑️ Delete
          </button>
          <button onclick="boostSoulmate('${id}')" 
            style="background:#ff9800; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer;">
            🚀 Boost
          </button>
          <button onclick="toggleSoulmateStatus('${id}', ${d.isClosed})" 
            style="background:${d.isClosed ? '#28a745' : '#6c757d'}; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer;">
            ${d.isClosed ? '♻️ Reopen' : '🚫 Mark as Closed'}
          </button>
        </div>` : ''}
    `;

    container.appendChild(card);
    updateLikeUI(id);
    listenForLikeChanges(id);
  });
}



async function verifySoulmateDirectly(soulmateId) {
  try {
    await soulmateRef.doc(soulmateId).set({
      verified: true
    }, { merge: true });

    showCustomAlert("✅ Soulmate profile verified successfully!", "success");
    loadSoulmates(); // Refresh list immediately
  } catch (err) {
    console.error("❌ Error verifying soulmate:", err);
    showCustomAlert("❌ Failed to verify soulmate: " + err.message, "error");
  }
}

async function boostSoulmate(id) {
  const userEmail = currentUser?.email || "";
  const adminEmails = [
    "mashabiki@teacherswapskenya.com",
    "sironga1@teacherswapskenya.com",
    "admin1@teacherswapskenya.com"
  ];

  const isAdminUser = adminEmails.includes(userEmail);

  // Show the spinner while processing
  document.getElementById("loadingSpinner").style.display = "flex";

  if (isAdminUser) {
    const boostExpiry = new Date();
    boostExpiry.setDate(boostExpiry.getDate() + 7); // 7 days

    try {
      // Update the soulmate profile as boosted
      await soulmateRef.doc(id).update({
        boosted: true,
        boostExpiry: boostExpiry
      });

      // Admin boost success message
      showCustomAlert("✅ Profile boosted for FREE by Admin", "success");

      // Send admin notification for boosting the profile
      const soulmateDoc = await soulmateRef.doc(id).get();
      const soulmateData = soulmateDoc.data();
      sendAdminNotification(
        "Soulmate Profile Boosted (Admin)", 
        soulmateData.postedBy, 
        `The soulmate profile "${soulmateData.name}" was boosted for FREE by Admin. Boost expires in 7 days.`
      );

      loadSoulmates(); // Refresh the list
    } catch (error) {
      console.error("❌ Error boosting soulmate:", error);
      showCustomAlert("❌ Failed to boost profile: " + error.message, "error");
    }
  } else {
    // Prompt user to pay before boosting
    const boostAmount = 250;
    showPaymentModalFor("soulmate", boostAmount, id, "Your Soulmate Profile");
  }

  // Hide the spinner once the process is complete
  document.getElementById("loadingSpinner").style.display = "none";
}

// Helper function to send an admin notification
async function sendAdminNotification(type, userId, message) {
  try {
    // Get user details (name/email) based on the userId
    const userSnap = await db.collection("users").doc(userId).get();
    const user = userSnap.data();

    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: type,
      userId: userId,
      userName: user ? user.displayName || user.email : "Unknown User",
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: message
    });

    console.log("Admin notification created: " + message);
  } catch (error) {
    console.error("Error sending admin notification:", error);
  }
}

async function toggleSoulmateStatus(id, currentStatus) {
  // Show the spinner while processing
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    const newStatus = !currentStatus;

    await db.collection("soulmates").doc(id).update({
      isClosed: newStatus
    });

    if (newStatus) {
      showCustomAlert("✅ Soulmate marked as closed.", "success");
    } else {
      showCustomAlert("♻️ Soulmate reopened successfully.", "success");
    }

    loadSoulmates(); // Refresh list

    // Optional: Send admin notification
    await db.collection("adminNotifications").add({
      type: newStatus ? "Soulmate Closed" : "Soulmate Reopened",
      soulmateId: id,
      message: `${newStatus ? "🔒" : "✅"} Soulmate with ID ${id} has been ${newStatus ? "closed" : "reopened"}.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    });

  } catch (error) {
    console.error("❌ Error updating soulmate status:", error);
    showCustomAlert("❌ Failed to update status: " + error.message, "error");
  } finally {
    // Hide the spinner once the process is complete
    document.getElementById("loadingSpinner").style.display = "none";
  }
}


// Helper function to send an admin notification
async function sendAdminNotification(type, userId, message) {
  try {
    // Get user details (name/email) based on the userId
    const userSnap = await db.collection("users").doc(userId).get();
    const user = userSnap.data();

    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: type,
      userId: userId,
      userName: user ? user.displayName || user.email : "Unknown User",
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: message
    });

    console.log("Admin notification created: " + message);
  } catch (error) {
    console.error("Error sending admin notification:", error);
  }
}


function showCustomAlert(message, type = "info") {
  const alertBox = document.createElement("div");
  alertBox.textContent = message;
  alertBox.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === "success" ? "#4caf50" : type === "error" ? "#f44336" : "#2196f3"};
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    z-index: 9999;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    font-size: 14px;
  `;
  document.body.appendChild(alertBox);
  setTimeout(() => alertBox.remove(), 3000);
}

function showMatchCelebration() {
  // 🎊 Confetti (if available)
  if (typeof confetti !== "undefined") {
    confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
  }

  // 💖 Falling Emojis
  const emojis = ["💘", "❤️", "💖", "🎉", "😍"];
  for (let i = 0; i < 20; i++) {
    const emoji = document.createElement("div");
    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    emoji.style.position = "fixed";
    emoji.style.left = `${Math.random() * 100}vw`;
    emoji.style.top = "100vh";
    emoji.style.fontSize = "32px";
    emoji.style.zIndex = "9999";
    emoji.style.animation = `floatUp ${3 + Math.random() * 2}s ease-out forwards`;
    document.body.appendChild(emoji);
    setTimeout(() => emoji.remove(), 5000);
  }

  // ✅ Custom celebration popup
  const popup = document.createElement("div");
  popup.innerHTML = `<strong>🎉 It's a Match!</strong><br>You both liked each other!`;
  popup.style.position = "fixed";
  popup.style.top = "50%";
  popup.style.left = "50%";
  popup.style.transform = "translate(-50%, -50%)";
  popup.style.background = "#d32f2f";
  popup.style.color = "#fff";
  popup.style.padding = "20px 30px";
  popup.style.borderRadius = "12px";
  popup.style.fontSize = "18px";
  popup.style.textAlign = "center";
  popup.style.boxShadow = "0 4px 15px rgba(0,0,0,0.2)";
  popup.style.zIndex = "10000";
  document.body.appendChild(popup);

  // Auto-dismiss after 4.5s
  setTimeout(() => popup.remove(), 4500);
}


function resetSoulmateFilters() {
  document.getElementById("filterMinAge").value = "";
  document.getElementById("filterMaxAge").value = "";
  document.getElementById("filterTribe").value = "";
  document.getElementById("filterSex").value = "";

  showCustomAlert("✅ Filters cleared. Showing all soulmates.", "info");

  loadSoulmates();
}


function unlockSoulmateContacts() {
  if (!currentUser || !currentUser.uid) {
    showCustomAlert("Please login to unlock contacts.", "error");
    return;
  }

  // Show the spinner while the process is happening
  document.getElementById("loadingSpinner").style.display = "flex";

  // Show the payment modal for unlocking soulmate contacts
  showPaymentModalFor("soulmate", 200, currentUser.uid, "Soulmate Contacts");

  const checkPaid = setInterval(() => {
    if (localStorage.getItem("paidForSoulmates") === "yes") {
      clearInterval(checkPaid);

      // Show success message
      showCustomAlert("Contacts unlocked! Reloading...", "success");

      // Close any open modal
      closeUniversalModal();

      // Reload soulmates
      loadSoulmates();

      // ✅ Send admin notification about contact unlocking
      sendAdminNotification("Soulmate Contacts Unlocked", currentUser.uid, "Soulmate contacts have been unlocked.");

      // Hide the spinner after completion
      document.getElementById("loadingSpinner").style.display = "none";
    }
  }, 3000);
}


// Helper function to send an admin notification
async function sendAdminNotification(type, userId, message) {
  try {
    // Get user details (name/email) based on the userId
    const userSnap = await db.collection("users").doc(userId).get();
    const user = userSnap.data();

    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: type,
      userId: userId,
      userName: user ? user.displayName || user.email : "Unknown User",
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: message
    });

    console.log("Admin notification created: " + message);
  } catch (error) {
    console.error("Error sending admin notification:", error);
  }
}



function showSoulmateModal(data) {
  const photo = data.photoURL || 'default.jpg';

  // 👀 Conditionally show phone only if paid
  const phoneSection = hasPaid || isAdmin ? `
    <p><strong>Phone:</strong> 
      <a href="tel:${data.phone}" style="color:green;">${data.phone}</a><br>
      <a href="https://wa.me/254${data.phone.replace(/^0/, '')}" target="_blank" style="color:#25D366;">WhatsApp</a>
    </p>
  ` : `
    <p><strong>Phone:</strong> <span style="color:crimson;">Locked — <a href="#" onclick="showPaymentModal()">Unlock Now</a></span></p>
  `;

  const detailHTML = `
    <p style="text-align:center;">
      <img src="${photo}" alt="Photo of ${data.name}" 
           style="max-width:90px; height:90px; border-radius:50%; object-fit:cover; border:4px solid #e91e63; box-shadow: 0 0 8px #e91e63;">
    </p>
    <p><strong>Name:</strong> ${data.name}</p>
    <p><strong>County:</strong> ${data.county}</p>
    <p><strong>Age:</strong> ${data.age}</p>
    <p><strong>Tribe:</strong> ${data.tribe}</p>
    <p><strong>Sex:</strong> ${data.sex}</p>
    <p><strong>Occupation:</strong> ${data.occupation}</p>
    <p><strong>Work County:</strong> ${data.workCounty}</p>
    <p><strong>Marital Status:</strong> ${data.status || 'Not specified'}</p>
    <p><strong>Has Kids:</strong> ${data.kids || 'Not specified'}</p>
    ${phoneSection}
    <div style="text-align:center; margin-top:10px;">
      <button onclick="sendInterest('${data.name}')" style="padding:8px 14px; background:#ff4081; border:none; border-radius:5px; color:#fff; cursor:pointer;">
        ❤️ Send Interest
      </button>
    </div>
  `;

  document.getElementById("soulmateDetails").innerHTML = detailHTML;
  document.getElementById("soulmateModal").style.display = "block";
}
async function sendInterest(toName) {
  if (!isLoggedIn || !currentUser) {
    showCustomAlert("Please login to send interest.", "error");
    return;
  }

  // Show the spinner while the interest is being sent
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    await db.collection("soulmateInterests").add({
      fromUserId: currentUser.uid,
      fromName: currentUser.displayName || currentUser.email,
      toName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    showCustomAlert(`❤️ Interest sent to ${toName}!`, "success");

  } catch (err) {
    showCustomAlert("Error sending interest: " + err.message, "error");
  } finally {
    // Hide the spinner once the process completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
}

async function isMutualMatch(name) {
  const myName = currentUser.displayName || currentUser.email;

  const sent = await db.collection("soulmateInterests")
    .where("fromUserId", "==", currentUser.uid)
    .where("toName", "==", name).get();

  const received = await db.collection("soulmateInterests")
    .where("fromName", "==", name)
    .where("toName", "==", myName).get();

  return !sent.empty && !received.empty;
}
function closeSoulmateModal() {
  document.getElementById("soulmateModal").style.display = "none";
}

  // ✅ Populate counties
  populateCounties("svcCounty");
  populateCounties("filterCounty");
// ✅ Attach Submit Logic Once
function attachServiceFormSubmit() {
  const form = document.getElementById("serviceForm");
  form.addEventListener("submit", submitServiceHandler);
}

async function submitServiceHandler(e) {
  e.preventDefault();

  if (!isLoggedIn || !currentUser) {
    showPage("login");
    return alert("You must be logged in.");
  }

  // Show the spinner while processing
  document.getElementById("loadingSpinner").style.display = "flex";

  // ✅ Check how many services this user has already posted
  const serviceCountSnap = await servicesRef.where("postedBy", "==", currentUser.uid).get();
  const totalServices = serviceCountSnap.size;

  // ✅ If already posted 1 service, require payment — unless admin
  if (totalServices >= 1 && !isAdmin) {
    showPaymentModalFor("service", 200, currentUser.uid, "Post Extra Service");
    document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner if payment modal is shown
    return;
  }

  // ✅ Collect form input values
  const data = {
    name: document.getElementById("svcName").value.trim(),
    county: document.getElementById("svcCounty").value,
    subcounty: document.getElementById("svcSubCounty").value.trim(),
    occupation: document.getElementById("svcOccupation").value.trim(),
    experience: document.getElementById("svcExperience").value,
    phone: document.getElementById("svcPhone").value.trim(),
    postedBy: currentUser.uid,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  // ✅ Validate all fields
  if (Object.values(data).some(v => !v)) {
    document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner if validation fails
    return alert("Please fill all fields.");
  }

  try {
    // ✅ Save to Firestore
    await servicesRef.add(data);
    showCustomAlert("✅ Service posted!", "success");
    document.getElementById("serviceForm").reset();
    loadServices();

    // ✅ Admin Notification
    await db.collection("adminNotifications").add({
      type: "Marketplace Post",
      message: `New service posted: ${data.name} (${data.occupation}), County: ${data.county}, Phone: ${data.phone}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });

    // ✅ Public Alert for All Users
    await db.collection("alerts").add({
      title: "🛠️ New Service",
      message: `${data.name} offers ${data.occupation} services in ${data.county}, ${data.subcounty}.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null,
      category: "service",
      county: data.county
    });

  } catch (err) {
    showCustomAlert("❌ Error: " + err.message, "error");
  } finally {
    // Hide the spinner once the process completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
}

async function loadServices() {
  const container = document.getElementById("servicesContainer");
  const trendingContainer = document.getElementById("trendingContainer");
  container.innerHTML = "";
  if (trendingContainer) trendingContainer.innerHTML = "";

  const snapshot = await servicesRef.orderBy("timestamp", "desc").get();
  if (snapshot.empty) {
    container.innerHTML = `<p>No services posted yet.</p>`;
    return;
  }

  const nowTime = new Date();
  let hasServiceAccess = false;

  const isAdminUser = currentUser?.email && [
    "mashabiki@teacherswapskenya.com",
    "sironga1@teacherswapskenya.com",
    "admin1@teacherswapskenya.com"
  ].includes(currentUser.email);

  if (currentUser?.uid) {
    const doc = await firebase.firestore().collection("users").doc(currentUser.uid).get();
    hasServiceAccess = doc.exists && doc.data()?.paidForService === true;
    if (hasServiceAccess) localStorage.setItem("paidForService", "yes");
  }

  const boosted = [], normal = [];

  for (const doc of snapshot.docs) {
    const d = doc.data();
    d.id = doc.id;

    const boostExpiry = d.boostExpiry?.toDate?.();
    const isBoosted = d.boosted && boostExpiry && boostExpiry > nowTime;

    if (d.boosted && (!boostExpiry || boostExpiry <= nowTime)) {
      await servicesRef.doc(d.id).update({ boosted: false, boostExpiry: null });
    }

    if (isBoosted) boosted.push(d);
    else normal.push(d);
  }

  const finalServices = [...boosted.sort((a, b) => b.boostExpiry?.toDate?.() - a.boostExpiry?.toDate?.()), ...normal];

  for (const d of finalServices) {
    const id = d.id;
    const isPoster = currentUser?.uid === d.postedBy;

    const boostExpiry = d.boostExpiry?.toDate?.();
    const isBoosted = d.boosted && boostExpiry && boostExpiry > nowTime;

    const verifiedBadge = d.verified
      ? `<span class="verified-badge"><i class="fas fa-check-circle"></i> Verified</span>`
      : "";

    let boostBadge = "";
    if (isBoosted) {
      const daysLeft = Math.ceil((boostExpiry - nowTime) / (1000 * 60 * 60 * 24));
      boostBadge = `
        <span style="background: orange; color: white; font-size: 0.75em; padding: 2px 6px; border-radius: 6px; margin-left: 6px;">
          🔥 Boosted (${daysLeft} day${daysLeft !== 1 ? "s" : ""} left)
        </span>`;
    }

    const interestCount = d.interestedUsers ? d.interestedUsers.length : 0;
    const interestCountText = `${interestCount} ${interestCount === 1 ? "person" : "people"} interested`;

const occupation = d.occupation?.toLowerCase?.() || "";
let iconClass = "fa-user-tie", bgColor = "#607d8b";

// --- Original occupations ---
if (occupation.includes("lawyer")) iconClass = "fa-balance-scale", bgColor = "#5c6bc0";
else if (occupation.includes("teacher")) iconClass = "fa-chalkboard-teacher", bgColor = "#42a5f5";
else if (occupation.includes("driver")) iconClass = "fa-car", bgColor = "#26a69a";
else if (occupation.includes("nurse")) iconClass = "fa-user-nurse", bgColor = "#ec407a";
else if (occupation.includes("chef")) iconClass = "fa-utensils", bgColor = "#ffa726";
else if (occupation.includes("plumber")) iconClass = "fa-tools", bgColor = "#7e57c2";

// --- Extended occupations ---
else if (occupation.includes("developer")) iconClass = "fa-laptop-code", bgColor = "#42a5f5";
else if (occupation.includes("designer")) iconClass = "fa-paint-brush", bgColor = "#9c27b0";
else if (occupation.includes("doctor")) iconClass = "fa-user-md", bgColor = "#f44336";
else if (occupation.includes("pilot")) iconClass = "fa-plane", bgColor = "#2196f3";
else if (occupation.includes("mechanic")) iconClass = "fa-tools", bgColor = "#795548";
else if (occupation.includes("electrician")) iconClass = "fa-bolt", bgColor = "#ff9800";
else if (occupation.includes("farmer")) iconClass = "fa-tractor", bgColor = "#4caf50";
else if (occupation.includes("engineer")) iconClass = "fa-cogs", bgColor = "#607d8b";
else if (occupation.includes("architect")) iconClass = "fa-drafting-compass", bgColor = "#9e9d24";
else if (occupation.includes("judge")) iconClass = "fa-gavel", bgColor = "#3e2723";
else if (occupation.includes("police")) iconClass = "fa-shield-alt", bgColor = "#1a237e";
else if (occupation.includes("security")) iconClass = "fa-user-shield", bgColor = "#000000";
else if (occupation.includes("firefighter")) iconClass = "fa-fire-extinguisher", bgColor = "#d32f2f";
else if (occupation.includes("scientist")) iconClass = "fa-flask", bgColor = "#00bcd4";
else if (occupation.includes("pharmacist")) iconClass = "fa-pills", bgColor = "#8e24aa";
else if (occupation.includes("dentist")) iconClass = "fa-tooth", bgColor = "#fbc02d";
else if (occupation.includes("veterinarian")) iconClass = "fa-paw", bgColor = "#8d6e63";
else if (occupation.includes("waiter")) iconClass = "fa-concierge-bell", bgColor = "#ff9800";
else if (occupation.includes("receptionist")) iconClass = "fa-phone", bgColor = "#4caf50";
else if (occupation.includes("sales")) iconClass = "fa-cash-register", bgColor = "#009688";
else if (occupation.includes("accountant")) iconClass = "fa-calculator", bgColor = "#3f51b5";
else if (occupation.includes("banker")) iconClass = "fa-university", bgColor = "#0d47a1";
else if (occupation.includes("marketer")) iconClass = "fa-bullhorn", bgColor = "#ff5722";
else if (occupation.includes("photographer")) iconClass = "fa-camera", bgColor = "#6a1b9a";
else if (occupation.includes("videographer")) iconClass = "fa-video", bgColor = "#c2185b";
else if (occupation.includes("model")) iconClass = "fa-user", bgColor = "#f48fb1";
else if (occupation.includes("actor")) iconClass = "fa-theater-masks", bgColor = "#ff9800";
else if (occupation.includes("musician")) iconClass = "fa-music", bgColor = "#5e35b1";
else if (occupation.includes("dj")) iconClass = "fa-headphones", bgColor = "#512da8";
else if (occupation.includes("tailor")) iconClass = "fa-cut", bgColor = "#ff7043";
else if (occupation.includes("cleaner")) iconClass = "fa-broom", bgColor = "#66bb6a";
else if (occupation.includes("translator")) iconClass = "fa-language", bgColor = "#0097a7";
else if (occupation.includes("tour guide")) iconClass = "fa-map-marked-alt", bgColor = "#43a047";
else if (occupation.includes("barista")) iconClass = "fa-coffee", bgColor = "#6d4c41";
else if (occupation.includes("butcher")) iconClass = "fa-drumstick-bite", bgColor = "#d84315";
else if (occupation.includes("baker")) iconClass = "fa-bread-slice", bgColor = "#f57c00";
else if (occupation.includes("fisherman")) iconClass = "fa-fish", bgColor = "#0288d1";
else if (occupation.includes("construction worker")) iconClass = "fa-hard-hat", bgColor = "#ffa000";
else if (occupation.includes("miner")) iconClass = "fa-gem", bgColor = "#616161";
else if (occupation.includes("social worker")) iconClass = "fa-hands-helping", bgColor = "#ff7043";
else if (occupation.includes("delivery")) iconClass = "fa-shipping-fast", bgColor = "#ef6c00";
else if (occupation.includes("call center")) iconClass = "fa-headset", bgColor = "#3949ab";
else if (occupation.includes("it support")) iconClass = "fa-server", bgColor = "#1e88e5";
else if (occupation.includes("seo specialist")) iconClass = "fa-search", bgColor = "#00acc1";
else if (occupation.includes("content writer")) iconClass = "fa-pen-nib", bgColor = "#ab47bc";
else if (occupation.includes("blogger")) iconClass = "fa-blog", bgColor = "#7b1fa2";
else if (occupation.includes("youtuber")) iconClass = "fa-video", bgColor = "#e53935";
else if (occupation.includes("data analyst")) iconClass = "fa-chart-line", bgColor = "#2e7d32";
else if (occupation.includes("data scientist")) iconClass = "fa-database", bgColor = "#1565c0";
else if (occupation.includes("ai engineer")) iconClass = "fa-robot", bgColor = "#00bcd4";
else if (occupation.includes("cyber security")) iconClass = "fa-user-secret", bgColor = "#263238";
else if (occupation.includes("blockchain")) iconClass = "fa-link", bgColor = "#ff6f00";
else if (occupation.includes("crypto trader")) iconClass = "fa-coins", bgColor = "#ffb300";
else if (occupation.includes("real estate")) iconClass = "fa-building", bgColor = "#8d6e63";
else if (occupation.includes("insurance agent")) iconClass = "fa-file-contract", bgColor = "#455a64";
else if (occupation.includes("loan officer")) iconClass = "fa-hand-holding-usd", bgColor = "#558b2f";
else if (occupation.includes("event planner")) iconClass = "fa-calendar-check", bgColor = "#9c27b0";
else if (occupation.includes("makeup artist")) iconClass = "fa-magic", bgColor = "#ec407a";
else if (occupation.includes("hair stylist")) iconClass = "fa-cut", bgColor = "#f06292";
else if (occupation.includes("barber")) iconClass = "fa-user", bgColor = "#8d6e63";
else if (occupation.includes("painter")) iconClass = "fa-paint-roller", bgColor = "#5d4037";
else if (occupation.includes("carpenter")) iconClass = "fa-hammer", bgColor = "#795548";
else if (occupation.includes("welder")) iconClass = "fa-tools", bgColor = "#ff7043";
else if (occupation.includes("roofer")) iconClass = "fa-home", bgColor = "#ff7043";
else if (occupation.includes("landscaper")) iconClass = "fa-tree", bgColor = "#4caf50";
else if (occupation.includes("truck driver")) iconClass = "fa-truck-moving", bgColor = "#4e342e";
else if (occupation.includes("taxi driver")) iconClass = "fa-taxi", bgColor = "#fbc02d";
else if (occupation.includes("bus driver")) iconClass = "fa-bus", bgColor = "#f57c00";
else if (occupation.includes("train conductor")) iconClass = "fa-train", bgColor = "#3f51b5";
else if (occupation.includes("ship captain")) iconClass = "fa-anchor", bgColor = "#0d47a1";
else if (occupation.includes("flight attendant")) iconClass = "fa-plane-departure", bgColor = "#03a9f4";
else if (occupation.includes("warehouse worker")) iconClass = "fa-boxes", bgColor = "#8d6e63";
else if (occupation.includes("packer")) iconClass = "fa-box", bgColor = "#a1887f";
else if (occupation.includes("logistics")) iconClass = "fa-shipping-fast", bgColor = "#009688";
else if (occupation.includes("quality inspector")) iconClass = "fa-clipboard-check", bgColor = "#388e3c";
else if (occupation.includes("project manager")) iconClass = "fa-tasks", bgColor = "#607d8b";
else if (occupation.includes("foreman")) iconClass = "fa-hard-hat", bgColor = "#ffa000";
else if (occupation.includes("researcher")) iconClass = "fa-microscope", bgColor = "#1e88e5";
else if (occupation.includes("lecturer")) iconClass = "fa-user-graduate", bgColor = "#3949ab";
else if (occupation.includes("professor")) iconClass = "fa-graduation-cap", bgColor = "#283593";
else if (occupation.includes("coach")) iconClass = "fa-dumbbell", bgColor = "#f44336";
else if (occupation.includes("personal trainer")) iconClass = "fa-running", bgColor = "#ff7043";
else if (occupation.includes("lifeguard")) iconClass = "fa-life-ring", bgColor = "#0288d1";
else if (occupation.includes("swimming instructor")) iconClass = "fa-swimmer", bgColor = "#039be5";
else if (occupation.includes("intern")) iconClass = "fa-user-graduate", bgColor = "#8e24aa";
else if (occupation.includes("volunteer")) iconClass = "fa-hands-helping", bgColor = "#43a047";
else if (occupation.includes("house manager")) iconClass = "fa-home", bgColor = "#8d6e63";
else if (occupation.includes("maid")) iconClass = "fa-broom", bgColor = "#f48fb1";
else if (occupation.includes("ict specialist")) iconClass = "fa-network-wired", bgColor = "#1565c0";
else if (occupation.includes("laundry")) iconClass = "fa-soap", bgColor = "#4dd0e1";

    const iconHTML = `
      <div style="padding: 18px; background: ${bgColor};">
        <i class="fas ${iconClass}" style="font-size: 50px; color: #fff;"></i>
      </div>`;

    const phoneIcon = '<i class="fas fa-phone-alt" style="margin-right: 6px;"></i>';
    const whatsappIcon = '<i class="fab fa-whatsapp" style="margin-right: 6px;"></i>';
    const experienceIcon = '<i class="fas fa-briefcase" style="margin-right: 6px;"></i>';
    const locationIcon = '<i class="fas fa-map-marker-alt" style="margin-right: 6px;"></i>';

    const contactHTML = (isPoster || hasServiceAccess || isAdminUser)
      ? `
        <p style="color:#2e7d32;"><strong>${phoneIcon}Phone:</strong> 
          <a href="tel:${d.phone}" style="color:green;">📞 Call</a>
        </p>
        <p style="color:#25D366;"><strong>${whatsappIcon}
          <a href="https://wa.me/254${d.phone.replace(/^0/, '')}" target="_blank">💬 WhatsApp</a></strong></p>`
      : `
        <div class="blurred">
          <p style="color:gray;">🔒 Contacts Locked – Pay Ksh 200 to Unlock</p>
        </div>
 <button onclick="showPaymentModalFor('service', 200, '${id}', 'Unlock Contacts')"
  style="background:crimson; color:white; padding:6px 12px; border:none; border-radius:6px; margin-top:6px;">
  💳 Pay Ksh 200 to Unlock Contacts
</button>
`;

    // ✅ Action buttons: Poster pays, Admin verifies free
    let actionButtonsHTML = `
      ${isPoster || isAdminUser ? `
        <button onclick="${isAdminUser ? `boostServiceDirectly('${id}')` : `showPaymentModalFor('serviceBoost', 300, '${id}', '${d.name}')`}"
          style="background:orange; color:white; border:none; padding:6px 12px; border-radius:6px; margin-top:8px;">
          🔥 Boost This Service
        </button>` : ''}

      ${!d.verified && isPoster && !isAdminUser ? `
        <button onclick="showPaymentModalFor('serviceVerification', 250, '${id}', '${d.name}')"
          style="background:#4CAF50; color:white; padding:6px 12px; border:none; border-radius:6px; margin-top:6px;">
          ✅ Get Verified Badge – Ksh 250
        </button>` : ''}

      ${!d.verified && isAdminUser ? `
        <button onclick="adminVerifyItem('service', '${id}')"
          style="background:#2196F3; color:white; padding:6px 12px; border:none; border-radius:6px; margin-top:6px;">
          🛡️ Verify Now (Admin)
        </button>` : ''}

      <button onclick="editService('${id}')" 
        style="background:#ff9800; color:white; padding:6px 12px; border:none; border-radius:6px; margin-top:6px;">
        ✏️ Edit Service
      </button>

      <button onclick="showReviewModal('${id}')" 
        style="background:#4caf50; color:white; padding:6px 12px; border:none; border-radius:6px; margin-top:6px;">
        📝 Leave a Review
      </button>

      <button onclick="showInterest('${id}')" 
        style="background:#ff5722; color:white; padding:6px 12px; border:none; border-radius:6px; margin-top:6px;">
        ❤️ Show Interest
      </button>

      ${isPoster || isAdminUser ? `
        <button onclick="deleteService('${id}')"
          style="background:#dc3545; color:white; padding:6px 12px; margin-top:6px; border:none; border-radius:6px;">
          🗑️ Delete
        </button>` : ''}

      ${isPoster || isAdminUser ? `
        <button onclick="toggleServiceStatus('${id}')"
          style="background:#2196F3; color:white; padding:6px 12px; border:none; border-radius:6px; margin-top:6px;">
          🔄 Activate/Deactivate Service
        </button>` : ''}`;

    const card = document.createElement("div");
    card.className = "service-card";
    card.id = `service-${id}`;
    card.dataset.county = d.county;
    card.dataset.occupation = occupation;
    card.style.cssText = `
      position: relative;
      border: 2px solid ${isBoosted ? 'orange' : '#ddd'};
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 18px;
      box-shadow: ${isBoosted ? '0 0 12px rgba(255,165,0,0.5)' : '0 2px 6px rgba(0,0,0,0.08)'};
      background: #fff;
      text-align: center;
      transition: all 0.3s ease;
    `;

    card.innerHTML = `
      ${iconHTML}
      <div style="padding: 14px; text-align:left;">
        ${verifiedBadge}
        <h3 style="margin: 6px 0; color:#00796b;">${d.name} ${boostBadge}</h3>
        <p style="color:#3f51b5;"><strong>${locationIcon}County:</strong> ${d.county}</p>
        <p style="color:#d32f2f;"><strong>Occupation:</strong> <span class="highlight-occupation">${d.occupation}</span></p>
        <p style="color:#6a1b9a;"><strong>${experienceIcon}Experience:</strong> ${d.experience} years</p>
        <p style="color: ${d.isActive ? '#4caf50' : '#f44336'}; font-weight: bold;">
          ${d.isActive ? '✅ Service Active' : '❌ Service Inactive'}
        </p>
        <div style="margin-top:10px;">${contactHTML}</div>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:12px;">${actionButtonsHTML}</div>
        <p id="interest-count-${id}" style="color: #f44336; font-size: 1em; margin-top: 10px;">${interestCountText}</p>
        <div style="margin-top:10px;">
          <h4 style="color:#4CAF50;">📢 Customer Reviews</h4>
          <div id="marketReviews-${id}" style="margin-top:10px;font-size:14px;"></div>
          <div style="margin-top:10px;">
            <button onclick="openAllReviewsModal('${id}')" style="background:#03a9f4;color:#fff;border:none;border-radius:5px;padding:6px 12px;">💬 View All Reviews</button>
          </div>
        </div>
        <div id="star-rating-${id}" class="star-rating" style="margin-top:12px;">
          <span data-value="1" class="star">&#9734;</span>
          <span data-value="2" class="star">&#9734;</span>
          <span data-value="3" class="star">&#9734;</span>
          <span data-value="4" class="star">&#9734;</span>
          <span data-value="5" class="star">&#9734;</span>
          <span id="average-rating-${id}" style="margin-left:10px; color:#ffb400; font-weight:bold;"></span>
        </div>
      </div>
    `;

    container.appendChild(card);

    if (isBoosted && trendingContainer) {
      const clonedCard = card.cloneNode(true);
      clonedCard.id = `trending-service-${id}`;
      const interestCountElem = clonedCard.querySelector(`#interest-count-${id}`);
      if (interestCountElem) interestCountElem.id = `interest-count-trending-${id}`;
      trendingContainer.appendChild(clonedCard);
    }

    setupStarRating(id);
    updateAverageRating(id);
  }
}



function payForVerification(category, itemId, itemName) {
  // category: 'service' or 'market'
  // amount: change if needed
  showPaymentModalFor(`${category}Verification`, 200, itemId, itemName);
}

async function showInterest(serviceId) {
  const currentUserUid = currentUser?.uid;
  if (!currentUserUid) {
    showCustomAlert("⚠️ Please log in to show interest.");
    return;
  }

  // Show the loading spinner while processing the request
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    const serviceRef = servicesRef.doc(serviceId);
    const serviceDoc = await serviceRef.get();

    if (!serviceDoc.exists) {
      console.error("Service not found.");
      showCustomAlert("❌ Service not found.");
      return;
    }

    const serviceData = serviceDoc.data();
    const interestedUsers = serviceData.interestedUsers || [];

    if (interestedUsers.includes(currentUserUid)) {
      showCustomAlert("✅ You've already shown interest in this service.");
      return;
    }

    interestedUsers.push(currentUserUid);
    await serviceRef.update({ interestedUsers });

    const posterId = serviceData.postedBy;
    if (posterId && posterId !== currentUserUid) {
      await db.collection("alerts").add({
        title: "📌 New Interest in Your Service",
        message: `${currentUser.displayName || "Someone"} is interested in your service: ${serviceData.name || "Unnamed Service"}`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        targetUserId: posterId,
        section: "services",
        relatedId: serviceId
      });
    }

    const updatedInterestCount = interestedUsers.length;
    const interestCountElement = document.getElementById(`interest-count-${serviceId}`);
    if (interestCountElement) {
      interestCountElement.textContent = `${updatedInterestCount} ${updatedInterestCount === 1 ? "person" : "people"} interested`;
    }

    showCustomAlert("🎉 Your interest has been registered successfully!");

  } catch (error) {
    console.error("❌ Error showing interest:", error.message || error);
    showCustomAlert("Something went wrong. Please try again.");
  } finally {
    // Hide the loading spinner after operation completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
}
async function verifyServiceDirectly(serviceId) {
  // Show the loading spinner while processing
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    await servicesRef.doc(serviceId).set({
      verified: true
    }, { merge: true });

    showCustomAlert("✅ Service verified successfully!", "success");

    // Instant DOM update without reload
    const card = document.getElementById(`service-${serviceId}`);
    if (card && !card.querySelector('.verified-badge')) {
      const badge = document.createElement('span');
      badge.className = 'verified-badge';
      badge.innerHTML = `<i class="fas fa-check-circle"></i> Verified`;
      const titleElem = card.querySelector('h3');
      if (titleElem) {
        titleElem.insertAdjacentElement('beforebegin', badge);
      }
    }

  } catch (err) {
    console.error("❌ Error verifying service:", err);
    showCustomAlert("❌ Failed to verify service: " + err.message, "error");
  } finally {
    // Hide the loading spinner after operation completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
}


function handlePaymentSuccess(paymentType, itemId) {
  if (paymentType === 'serviceVerification') {
    verifyServiceDirectly(itemId);
  }
  else if (paymentType === 'serviceBoost') {
    boostServiceDirectly(itemId);
  }
  else if (paymentType === 'marketVerification') {
    verifyMarketDirectly(itemId);
  }
  else if (paymentType === 'marketBoost') {
    boostMarketDirectly(itemId);
  }
}



// Star Rating Helpers (add these outside loadServices)

function setupStarRating(serviceId) {
  const stars = document.querySelectorAll(`#star-rating-${serviceId} .star`);
  let userRating = 0;

  stars.forEach(star => {
    star.addEventListener("mouseenter", () => {
      highlightStars(serviceId, star.dataset.value);
    });
    star.addEventListener("mouseleave", () => {
      highlightStars(serviceId, userRating);
    });
    star.addEventListener("click", async () => {
      userRating = parseInt(star.dataset.value);
      await saveUserRating(serviceId, userRating);
      highlightStars(serviceId, userRating);
      await updateAverageRating(serviceId);
    });
  });

  loadUserRating(serviceId).then(rating => {
    userRating = rating || 0;
    highlightStars(serviceId, userRating);
  });
}

function highlightStars(serviceId, rating) {
  const stars = document.querySelectorAll(`#star-rating-${serviceId} .star`);
  stars.forEach(star => {
    if (star.dataset.value <= rating) {
      star.classList.add("selected");
    } else {
      star.classList.remove("selected");
    }
  });
}

async function saveUserRating(serviceId, rating) {
  if (!currentUser?.uid) {
    alert("Please log in to rate services.");
    return;
  }
  try {
    const ratingRef = servicesRef.doc(serviceId).collection("ratings").doc(currentUser.uid);
    await ratingRef.set({
      rating,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      userId: currentUser.uid,
      serviceId,
    });
  } catch (error) {
    console.error("Error saving rating:", error);
  }
}

async function loadUserRating(serviceId) {
  if (!currentUser?.uid) return 0;
  try {
    const ratingDoc = await servicesRef.doc(serviceId).collection("ratings").doc(currentUser.uid).get();
    if (ratingDoc.exists) {
      return ratingDoc.data().rating || 0;
    }
  } catch (error) {
    console.error("Error loading user rating:", error);
  }
  return 0;
}

async function updateAverageRating(serviceId) {
  try {
    const ratingsSnapshot = await servicesRef.doc(serviceId).collection("ratings").get();
    let sum = 0, count = 0;
    ratingsSnapshot.forEach(doc => {
      sum += doc.data().rating || 0;
      count++;
    });
    const avg = count ? (sum / count) : 0;
    const avgRounded = avg.toFixed(1);

    const avgElem = document.getElementById(`average-rating-${serviceId}`);
    if (avgElem) {
      avgElem.textContent = `Avg: ${avgRounded} ★ (${count})`;
    }
  } catch (error) {
    console.error("Error calculating average rating:", error);
  }
}


async function toggleServiceStatus(serviceId) {
  // Show the loading spinner
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    const serviceDoc = await servicesRef.doc(serviceId).get();
    const isActive = serviceDoc.data().isActive;

    // Toggle service activation status
    await servicesRef.doc(serviceId).update({
      isActive: !isActive // Toggle between true/false
    });

    // Show a custom toast or notification for all users
    const message = isActive ? "Service Deactivated" : "Service Activated";
    showToast(message, isActive ? "warning" : "info");

    // Optionally, show a message on the card itself to indicate the status change
    const serviceCard = document.getElementById(`service-${serviceId}`);
    const statusElement = serviceCard.querySelector(".service-status");

    if (statusElement) {
      statusElement.textContent = isActive ? "Status: Inactive" : "Status: Active";
      statusElement.style.color = isActive ? "gray" : "green"; // Gray for inactive, Green for active
    }

    loadServices(); // Reload to reflect changes

  } catch (error) {
    console.error("Error toggling service status:", error);
    alert("Error updating service status.");
  } finally {
    // Hide the loading spinner
    document.getElementById("loadingSpinner").style.display = "none";
  }
}


// ✅ Reusable inlined custom alert function
function showCustomAlert(message) {
  const alertBox = document.createElement("div");
  alertBox.textContent = message;
  alertBox.style = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: palegreen;
    color: black;
    padding: 15px 25px;
    font-size: 16px;
    font-weight: bold;
    border: 2px solid green;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 9999;
    text-align: center;
  `;

  document.body.appendChild(alertBox);
  setTimeout(() => {
    alertBox.remove();
  }, 3000);
}





// Show Review Modal
function showReviewModal(serviceId) {
  const reviewModal = document.getElementById("reviewModal");
  reviewModal.style.display = 'block'; // Show the modal

  // Handle review submission
  document.getElementById("reviewForm").onsubmit = async (e) => {
    e.preventDefault();
    const rating = document.getElementById("reviewRating").value;
    const comment = document.getElementById("reviewComment").value;

    // Add review to service document
    const review = {
      rating: parseInt(rating),
      comment,
      user: currentUser.uid, // Store the user ID who posted the review
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      await servicesRef.doc(serviceId).collection("reviews").add(review);
      alert("Review added!");
      reviewModal.style.display = 'none'; // Close the modal
      loadServices(); // Reload to reflect changes
    } catch (error) {
      console.error("Error adding review:", error);
      alert("Error adding review.");
    }
  };
}

// Close Review Modal
function closeReviewModal() {
  const reviewModal = document.getElementById("reviewModal");
  reviewModal.style.display = 'none'; // Close the modal
}

async function boostServiceDirectly(serviceId) {
  // Show the loading spinner
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    const expiry = new Date();
    expiry.setDate(expiry.getDate() + 3); // 3-day boost

    await servicesRef.doc(serviceId).set({
      boosted: true,
      boostExpiry: firebase.firestore.Timestamp.fromDate(expiry)
    }, { merge: true });

    showCustomAlert("✅ Service boosted successfully by Admin!", "success");
    loadServices(); // Refresh list immediately
  } catch (err) {
    console.error("❌ Error boosting service:", err);
    showCustomAlert("❌ Failed to boost service: " + err.message, "error");
  } finally {
    // Hide the loading spinner after completion
    document.getElementById("loadingSpinner").style.display = "none";
  }
}

async function postService() {
  if (!currentUser) {
    showCustomAlert("Please login first.", "error");
    return;
  }

  // Show the loading spinner while processing the request
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    // Check how many services this user has already posted
    const serviceCountSnap = await servicesRef.where("postedBy", "==", currentUser.uid).get();
    const totalServices = serviceCountSnap.size;

    // If already posted 1 service, require payment before proceeding
    if (totalServices >= 1) {
      const confirmPayment = confirm("You have already posted one free service. Pay Ksh 200 to post another. Proceed to payment?");
      if (confirmPayment) {
        processServicePayment();
      }
      return;
    }

    // ✅ Collect service form input values
    const name = document.getElementById("svcName").value.trim();
    const phone = document.getElementById("svcPhone").value.trim();
    const county = document.getElementById("svcCounty").value.trim();
    const occupation = document.getElementById("svcOccupation").value.trim();
    const experience = document.getElementById("svcExperience").value.trim();

    // Validate fields
    if (!name || !phone || !county || !occupation || !experience) {
      showCustomAlert("Please fill in all fields before posting.", "error");
      return;
    }

    // ✅ Post service to Firestore
    const serviceRef = await servicesRef.add({
      name,
      phone,
      county,
      occupation,
      experience,
      postedBy: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      boosted: false,
      boostExpiry: null
    });

    showCustomAlert("Service posted successfully!", "success");

    // ✅ Send admin notification about the new service post
    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: "New Service Posted",
      itemId: serviceRef.id,
      itemName: name,
      postedBy: currentUser.displayName || currentUser.email,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: `${currentUser.displayName || currentUser.email} has posted a new service: "${name}".`
    });

    console.log("Admin notification created for new service");

    // ✅ Notify all users via global alert
    await db.collection("alerts").add({
      title: "🛠️ New Service Available",
      message: `${currentUser.displayName || "Someone"} just posted a service: ${occupation} in ${county}.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null // visible to everyone
    });

    // Clear form fields
    document.getElementById("serviceForm").reset();

    // Reload services display
    loadServices();

  } catch (error) {
    console.error("Error posting service:", error);
    showCustomAlert("Failed to post service. Please try again.", "error");
  } finally {
    // Hide the loading spinner once the process completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
}




async function unlockServiceContacts() {
  if (!currentUser || !currentUser.uid) {
    showCustomAlert("Please login to unlock service contacts.", "error");
    return;
  }

  showPaymentModalFor("service", 200, currentUser.uid, "Service Provider Contacts");

  const checkPaid = setInterval(async () => {
    if (localStorage.getItem("paidForService") === "yes") {
      clearInterval(checkPaid);
      
      // Create Admin Notification when the service contacts are unlocked
      const notifRef = db.collection("adminNotifications").doc();
      await notifRef.set({
        type: "Service Contacts Unlocked",
        userId: currentUser.uid,
        userName: currentUser.displayName || currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        message: `${currentUser.displayName || currentUser.email} has unlocked service provider contacts after making a payment.`
      });

      showCustomAlert("Service provider contacts unlocked!", "success");
      closeUniversalModal();
      loadServices(); // Reload services to show contacts
    }
  }, 3000);
}


// ✅ Show toast message (success or error)
function showToast(message, type = "success") {
  Toastify({
    text: message,
    duration: 3000,
    gravity: "top",
    position: "right",
    backgroundColor: type === "success" ? "#28a745" : "#dc3545",
    close: true,
  }).showToast();
}

function promptToast(message, onConfirm) {
  // Remove any existing prompt
  const oldBox = document.getElementById("customConfirmBox");
  if (oldBox) oldBox.remove();

  const box = document.createElement("div");
  box.id = "customConfirmBox"; // important for duplicate removal
  box.innerHTML = `
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;z-index:9999;">
      <div style="background:#fff;padding:20px 30px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.3);text-align:center;font-family:sans-serif;">
        <p style="margin-bottom:20px;font-size:16px;">${message}</p>
        <button id="promptYesBtn" style="margin-right:10px;padding:8px 16px;background:#28a745;color:#fff;border:none;border-radius:5px;cursor:pointer;">Yes</button>
        <button id="promptNoBtn" style="padding:8px 16px;background:#dc3545;color:#fff;border:none;border-radius:5px;cursor:pointer;">No</button>
      </div>
    </div>
  `;

  document.body.appendChild(box);

  // ✅ Attach event listeners after element is added
  document.getElementById("promptYesBtn").onclick = () => {
    box.remove();
    onConfirm(true);
  };
  document.getElementById("promptNoBtn").onclick = () => {
    box.remove();
    onConfirm(false);
  };
}


async function deleteService(id) {
  // Show the loading spinner when the process begins
  document.getElementById("loadingSpinner").style.display = "flex";

  promptToast("Are you sure you want to delete this service?", async (confirmed) => {
    if (confirmed) {
      try {
        const serviceDoc = await servicesRef.doc(id).get();
        if (!serviceDoc.exists) {
          showToast("Service not found.", "error");
          return;
        }

        const serviceData = serviceDoc.data();
        const serviceName = serviceData.name || "Unknown Service";
        const deletedBy = currentUser.displayName || currentUser.email;

        // Delete the service
        await servicesRef.doc(id).delete();
        showToast("Service deleted successfully.", "success");
        loadServices(); // Refresh the list

        // Create Admin Notification about Service Deletion
        const notifRef = db.collection("adminNotifications").doc();
        await notifRef.set({
          type: "Service Deleted",
          itemId: id,
          itemName: serviceName,
          deletedBy: deletedBy,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          message: `❌ Service "${serviceName}" has been deleted by ${deletedBy}.`
        });

        console.log("Admin notification created for service deletion");

      } catch (err) {
        showToast("Error deleting: " + err.message, "error");
        console.error("Error deleting service:", err);
      }
    } else {
      showToast("Deletion cancelled.", "error");
    }

    // Hide the loading spinner once the process is complete
    document.getElementById("loadingSpinner").style.display = "none";
  });
}

// ✅ Edit service and rebind default submit
function editService(data, id) {
  document.getElementById("svcName").value = data.name;
  document.getElementById("svcCounty").value = data.county;
  document.getElementById("svcSubCounty").value = data.subcounty;
  document.getElementById("svcOccupation").value = data.occupation;
  document.getElementById("svcExperience").value = data.experience;
  document.getElementById("svcPhone").value = data.phone;

  const btn = document.querySelector("#serviceForm button");
  btn.innerHTML = "Update Service";

  // Show loading spinner while updating
  document.getElementById("loadingSpinner").style.display = "flex";

  // Replace the form element to remove previous listeners
  const oldForm = document.getElementById("serviceForm");
  const newForm = oldForm.cloneNode(true);
  oldForm.parentNode.replaceChild(newForm, oldForm);

  // Add update submit handler
  newForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    try {
      const updated = {
        name: document.getElementById("svcName").value,
        county: document.getElementById("svcCounty").value,
        subcounty: document.getElementById("svcSubCounty").value,
        occupation: document.getElementById("svcOccupation").value,
        experience: document.getElementById("svcExperience").value,
        phone: document.getElementById("svcPhone").value,
        postedBy: data.postedBy,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      // Update the service
      await servicesRef.doc(id).update(updated);

      // Show success message
      showCustomAlert("✅ Service updated.");
      newForm.reset();
      loadServices(); // Refresh service list

      // Reset button text to default
      btn.innerHTML = `<i class="fas fa-concierge-bell" style="margin-right:6px;"></i> Submit Service`;

      // Reattach the default form submit handler
      attachServiceFormSubmit(); // 👈 Reattach default

    } catch (err) {
      showCustomAlert("Error updating: " + err.message, "error");
    } finally {
      // Hide the loading spinner once the update is complete
      document.getElementById("loadingSpinner").style.display = "none";
    }
  });
}


function filterServices() {
  const county = document.getElementById("filterServiceCounty").value;
  const occupation = document.getElementById("filterOccupation").value.toLowerCase();

  const cards = document.querySelectorAll(".service-card");
  let matches = 0;

  cards.forEach(card => {
    const matchesCounty = !county || card.dataset.county === county;
    const matchesOccupation = !occupation || card.dataset.occupation.includes(occupation);

    const shouldShow = matchesCounty && matchesOccupation;
    card.style.display = shouldShow ? "" : "none";

    if (shouldShow) matches++;
  });

  if (matches === 0) {
    showCustomAlert("😞 No services match your filters.", "info");
  }
}
// ✅ Global Submit Handler for Market Form
async function submitMarketHandler(e) {
  e.preventDefault();

  if (!isLoggedIn || !currentUser) {
    showPage("login");
    return alert("You must be logged in.");
  }

  const itemName = document.getElementById("itemName").value.trim();
  const itemCategory = document.getElementById("itemCategory").value;
  const itemDescription = document.getElementById("itemDescription").value.trim();
  const itemPrice = document.getElementById("itemPrice").value.trim();
  const itemCounty = document.getElementById("itemCounty").value;
  const itemSubcounty = document.getElementById("itemSubcounty").value.trim();
  const itemPhone = document.getElementById("itemPhone").value.trim();
  const itemPhotoFile = document.getElementById("itemPhoto").files[0];

  // ✅ Optional dropdown for item condition
  const itemConditionInput = document.getElementById("itemCondition");
  const itemCondition = itemConditionInput ? itemConditionInput.value : "New";

  const posterName = currentUser.displayName || currentUser.email || "Anonymous";

  const itemData = {
    name: itemName,
    category: itemCategory,
    description: itemDescription,
    price: itemPrice,
    county: itemCounty,
    subcounty: itemSubcounty,
    phone: itemPhone,
    postedBy: currentUser.uid,
    posterName: posterName,
    condition: itemCondition,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  // Show spinner while uploading
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    // ✅ Upload item photo if available
    if (itemPhotoFile) {
      const photoPath = `marketPhotos/${Date.now()}_${itemPhotoFile.name}`;
      const photoSnap = await storage.ref(photoPath).put(itemPhotoFile);
      itemData.photoURL = await photoSnap.ref.getDownloadURL();
    }

    // ✅ Save item to Firestore
    await marketRef.add(itemData);
    showCustomAlert("✅ Item posted!", "success");
    document.getElementById("marketForm").reset();
    loadMarketItems();

    // ✅ Notify Admin with poster phone
    await db.collection("adminNotifications").add({
      type: "Marketplace Post",
      message: `New item posted: ${itemName} (${itemCategory})\nPrice: ${itemPrice}\n📞 Phone: ${itemPhone}\n📍 County: ${itemCounty}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });

    // ✅ Alert All Users with phone number
    await db.collection("alerts").add({
      title: "🆕 New Market Item",
      message: `${posterName} just posted: ${itemName} (${itemCategory}) @ ${itemPrice}\n📞 Contact: ${itemPhone}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null  // visible to all
    });

  } catch (err) {
    showCustomAlert("❌ Error: " + err.message, "error");
  } finally {
    // Hide the spinner once done
    document.getElementById("loadingSpinner").style.display = "none";
  }
}


// ✅ Attach Market Form Handler (safe and reusable)
function attachMarketFormSubmit() {
  const oldForm = document.getElementById("marketForm");
  if (!oldForm) return;

  const newForm = oldForm.cloneNode(true);
  oldForm.parentNode.replaceChild(newForm, oldForm);
  newForm.addEventListener("submit", submitMarketHandler);
}
async function loadMarketItems() {
  const container = document.getElementById("marketContainer");
  container.innerHTML = "";

  const minPrice = parseInt(document.getElementById("filterMinPrice").value) || 0;
  const maxPrice = parseInt(document.getElementById("filterMaxPrice").value) || Infinity;
  const categoryFilter = document.getElementById("filterCategory").value.toLowerCase().trim();
  const countyFilter = document.getElementById("filterCounty").value.toLowerCase().trim();

  try {
    const snapshot = await marketRef.get();
    if (snapshot.empty) {
      container.innerHTML = "<p>No items posted yet.</p>";
      return;
    }

    const boostedItems = [], normalItems = [], now = new Date();

    snapshot.forEach(doc => {
      const d = doc.data();
      const id = doc.id;

      const price = parseFloat(d.price) || 0;
      if (price < minPrice || price > maxPrice) return;
      if (categoryFilter && (!d.category || !d.category.toLowerCase().includes(categoryFilter))) return;
      if (countyFilter && (!d.county || !d.county.toLowerCase().includes(countyFilter))) return;

      const isBoosted = d.boosted && d.boostExpiry?.toDate?.() > now;
      const isExpired = d.boostExpiry?.toDate?.() <= now;

      if (isBoosted) {
        boostedItems.push({ ...d, id });
      } else {
        normalItems.push({ ...d, id, isExpired });
      }
    });

    if (boostedItems.length + normalItems.length === 0) {
      container.innerHTML = "<p>No items match your filters.</p>";
      return;
    }

    [...boostedItems, ...normalItems].forEach(d => {
      const id = d.id;
      const isPoster = currentUser && currentUser.uid === d.postedBy;
      const isBoosted = d.boosted && d.boostExpiry?.toDate?.() > new Date();
      const isExpired = d.isExpired;
      const canDelete = isPoster || isAdmin;
      const canBoost = isPoster || isAdmin;

      // ✅ Verified badge if marked in DB
      const verifiedBadge = d.verified
        ? `<span class="verified-badge"><i class="fas fa-check-circle"></i> Verified</span>`
        : "";

      // ✅ Verification button (Paid for poster, Free for admin)
      let verifyBtnHTML = "";
      if (!d.verified) {
        if (isPoster && !isAdmin) {
          verifyBtnHTML = `
            <button onclick="payForVerification('marketVerification', '${id}', '${d.name || ''}')"
              style="background:#4CAF50; color:white; border:none; padding:6px 12px; border-radius:6px; margin-top:6px;">
              ✅ Get Verified – Ksh 500
            </button>`;
        }
        if (isAdmin) {
          verifyBtnHTML += `
            <button onclick="adminVerifyItem('market', '${id}')"
              style="background:#2196F3; color:white; border:none; padding:6px 12px; border-radius:6px; margin-top:6px;">
              🛡️ Verify Now (Admin)
            </button>`;
        }
      }

      const boostBadge = isBoosted
        ? `<span style="color:#ff5722; font-weight:bold; font-size:0.85em; margin-left:6px;">🔥 Boosted</span>`
        : "";

      const card = document.createElement("div");
      card.className = "market-card";
      card.id = `market-${id}`;
      card.dataset.category = d.category || "";
      card.dataset.county = d.county || "";
      if (isBoosted) card.dataset.boosted = "true";
      card.style.position = "relative";

      card.innerHTML = `
        <h3 style="margin-bottom:6px; color:#2e7d32;">${d.posterName || "Unknown Seller"} ${verifiedBadge} ${boostBadge}</h3>
        ${d.photoURL ? `<img src="${d.photoURL}" style="width:100%;height:180px;object-fit:cover;border-radius:8px;margin-bottom:8px;">` : ""}
        <p style="color:#4caf50;">📦 <strong>Item name:</strong> ${d.name || "-"}</p>
        <p style="color:#2196f3;">📝 <strong>Status:</strong> ${d.description || "-"}</p>
        <p style="color:#e91e63;">🏷️ <strong>Category:</strong> ${d.category || "-"}</p>
        <p style="color:#ff9800;">💰 <strong>Price:</strong> KES ${d.price ? parseInt(d.price).toLocaleString() : "N/A"}</p>
        <p style="color:#9c27b0;">🧰 <strong>Condition:</strong> ${d.condition || "New"}</p>
        <p style="color:#3f51b5;">📍 <strong>Location:</strong> ${d.county || "Unknown"}, ${d.subcounty || "Unknown"}</p>
        <p style="color:#673ab7;">📞 <strong>Contact:</strong> ${d.phone || "N/A"}</p>
        ${verifyBtnHTML}
        ${(!isPoster && currentUser) ? `
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;">
            <button onclick="showMarketInterest('${id}')" style="background:#f44336;color:#fff;border:none;border-radius:5px;padding:6px 12px;">💬 Interest <span id="marketInterestCount-${id}">0</span></button>
            <button onclick="reportMarketItem('${id}')" style="background:#ff1744;color:#fff;border:none;border-radius:5px;padding:6px 12px;">🚩 Report</button>
<button 
  onclick="openMarketChat('${d.firebaseUid || d.phone}', '${d.posterName || 'Seller'}')" 
  style="background:#673ab7;color:#fff;border:none;border-radius:5px;padding:6px 12px;">
  💬 Chat
</button>

    <button onclick="openReviewModal('${id}')" style="background:#4CAF50;color:#fff;border:none;border-radius:5px;padding:6px 12px;">📝 Review</button>
          </div>
        ` : ""}
        ${isPoster ? `
          <div style="margin-top:10px;">
            <button id="soldOutBtn-${id}" onclick="toggleSoldStatus('${id}')" style="background:#9e9e9e;color:#fff;border:none;border-radius:5px;padding:6px 12px;">
              ${d.isSold ? "❌ Sold Out" : "✅ Mark as Sold"}
            </button>
          </div>
        ` : ""}
        <div style="margin-top:10px;">
          <h4 style="color:#4CAF50;">📢 Customer Reviews</h4>
          <div id="marketReviews-${id}" style="margin-top:10px;font-size:14px;"></div>
          <div style="margin-top:10px;">
            <button onclick="openAllReviewsModal('${id}')" style="background:#03a9f4;color:#fff;border:none;border-radius:5px;padding:6px 12px;">💬 View All Reviews</button>
          </div>
        </div>
        ${(canDelete || canBoost) ? `
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;">
            ${canDelete ? `<button onclick="deleteMarketItem('${id}')" style="background:#dc3545;color:#fff;border:none;border-radius:5px;padding:6px 12px;">🗑️ Delete</button>` : ""}
            ${canBoost && !isBoosted ? `<button onclick="boostMarketItem('${id}')" style="background:#ff9800;color:#fff;border:none;border-radius:5px;padding:6px 12px;">🚀 Boost</button>` : ""}
            ${isPoster && isExpired ? `<button onclick="renewBoost('${id}')" style="background:#ff9800;color:#fff;border:none;border-radius:5px;padding:6px 12px;">🔄 Renew Boost</button>` : ""}
          </div>
        ` : ""}
        ${(isPoster || isAdmin) ? `
          <div style="margin-top:10px;">
            <button onclick="openEditForm('${id}')" style="background:#673ab7;color:#fff;border:none;border-radius:5px;padding:6px 12px;">✏️ Edit Item</button>
          </div>
        ` : ""}
      `;

      container.appendChild(card);
      updateAverageRating(id);
      loadReviews("market", id);
      loadInterestCount(id);
    });

  } catch (err) {
    console.error("❌ Error loading market items:", err);
  }
}
let currentMarketReceiverUid = null;
let unsubscribeMarketMessages = null;

// ✅ Open chat with a market user
function openMarketChat(receiverUid, posterName) {
  currentMarketReceiverUid = receiverUid;
  document.getElementById("marketChatName").innerText = posterName;
  document.getElementById("marketChatModal").style.display = "flex";

  loadMarketMessagesRealtime(receiverUid);

  document.getElementById("marketSendBtn").onclick = sendMarketMessage;
}

// ✅ Close chat
function closeMarketChat() {
  document.getElementById("marketChatModal").style.display = "none";
  if (unsubscribeMarketMessages) unsubscribeMarketMessages();
}

async function sendMarketMessage() {
  const message = document.getElementById("marketChatInput").value.trim();
  if (!message) return alert("Please enter a message!");

  const currentUserId = firebase.auth().currentUser?.uid;
  if (!currentUserId) return alert("Please log in first!");

  // Show instantly in the chat UI
  addMessageToUI({
    senderId: currentUserId,
    message: message
  }, true); // true = temporary until Firestore confirms

  try {
    await db.collection("marketChats").add({
      senderId: currentUserId,
      receiverId: currentMarketReceiverUid,
      message: message,
      participants: [currentUserId, currentMarketReceiverUid],
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    });

    document.getElementById("marketChatInput").value = "";

    showChatAlert("Message sent ✅", "green");
  } catch (error) {
    console.error("Error sending message:", error);
    showChatAlert("Failed to send ❌", "red");
  }
}


// ✅ Quick message
function sendMarketQuick(text) {
  document.getElementById("marketChatInput").value = text;
  sendMarketMessage();
}

// ✅ Real-time message loader (fixed query)
function loadMarketMessagesRealtime(receiverUid) {
  const currentUserId = firebase.auth().currentUser?.uid;
  if (!currentUserId) return;

  const messagesContainer = document.getElementById("marketChatMessages");
  messagesContainer.innerHTML = "<p style='text-align:center; color:gray;'>Loading...</p>";

  if (unsubscribeMarketMessages) unsubscribeMarketMessages();

  // ✅ Use participants array instead of two "in" filters
  unsubscribeMarketMessages = db.collection("marketChats")
    .where("participants", "array-contains", currentUserId)
    .orderBy("timestamp", "asc")
    .onSnapshot(snapshot => {
      messagesContainer.innerHTML = "";
      snapshot.forEach(doc => {
        const msg = doc.data();

        // Only show messages between the two people
        if (
          (msg.senderId === currentUserId && msg.receiverId === receiverUid) ||
          (msg.senderId === receiverUid && msg.receiverId === currentUserId)
        ) {
          const msgDiv = document.createElement("div");
          msgDiv.style.margin = "6px 0";
          msgDiv.style.padding = "8px";
          msgDiv.style.borderRadius = "6px";
          msgDiv.style.maxWidth = "75%";
          msgDiv.style.background = msg.senderId === currentUserId ? "#4CAF50" : "#ccc";
          msgDiv.style.color = msg.senderId === currentUserId ? "#fff" : "#000";
          msgDiv.textContent = msg.message;
          messagesContainer.appendChild(msgDiv);
        }
      });
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
}
function showChatAlert(text, color) {
  let alertBox = document.getElementById("chatAlertBox");
  if (!alertBox) {
    alertBox = document.createElement("div");
    alertBox.id = "chatAlertBox";
    alertBox.style.position = "fixed";
    alertBox.style.bottom = "80px";
    alertBox.style.left = "50%";
    alertBox.style.transform = "translateX(-50%)";
    alertBox.style.padding = "10px 15px";
    alertBox.style.borderRadius = "5px";
    alertBox.style.fontWeight = "bold";
    alertBox.style.zIndex = "9999";
    document.body.appendChild(alertBox);
  }
  alertBox.textContent = text;
  alertBox.style.background = color;
  alertBox.style.color = "#fff";
  alertBox.style.display = "block";
  setTimeout(() => {
    alertBox.style.display = "none";
  }, 2000);
}

function addMessageToUI(msgData, isTemporary = false) {
  const messagesContainer = document.getElementById("marketChatMessages");
  const msgDiv = document.createElement("div");
  msgDiv.style.margin = "6px 0";
  msgDiv.style.padding = "8px";
  msgDiv.style.borderRadius = "6px";
  msgDiv.style.maxWidth = "75%";
  msgDiv.style.background = msgData.senderId === firebase.auth().currentUser?.uid ? "#4CAF50" : "#ccc";
  msgDiv.style.color = msgData.senderId === firebase.auth().currentUser?.uid ? "#fff" : "#000";
  msgDiv.textContent = msgData.message;

  if (isTemporary) {
    msgDiv.style.opacity = "0.5"; // ghost effect until confirmed
  }

  messagesContainer.appendChild(msgDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}


async function verifyMarketDirectly(marketId) {
  try {
    await marketRef.doc(marketId).set({
      verified: true
    }, { merge: true });

    showCustomAlert("✅ Market item verified successfully!", "success");

    // Optional: reload market list, but we can update DOM instantly instead
    // loadMarketItems();

    // Instant DOM update without reload
    const card = document.getElementById(`market-${marketId}`);
    if (card && !card.querySelector('.verified-badge')) {
      const badge = document.createElement('span');
      badge.className = 'verified-badge';
      badge.innerHTML = `<i class="fas fa-check-circle"></i> Verified`;
      const titleElem = card.querySelector('h3');
      if (titleElem) {
        titleElem.insertAdjacentElement('beforebegin', badge);
      }
    }

  } catch (err) {
    console.error("❌ Error verifying market item:", err);
    showCustomAlert("❌ Failed to verify market item: " + err.message, "error");
  }
}
// ✅ Global Alerts Loading Handler
async function loadAlerts() {
  const container = document.getElementById("alertsContainer");
  const badge = document.getElementById("alertsBadge"); // 🔹 Badge element
  const spinner = document.getElementById("loadingSpinner"); // Loading spinner element
  container.style.display = "block";
  container.innerHTML = "<h3>🔔 Alerts</h3><p>Loading...</p>";

  // Show the spinner while loading
  spinner.style.display = "flex";

  // Inject animation styles (only once)
  if (!document.getElementById("alertsBadgeStyles")) {
    const style = document.createElement("style");
    style.id = "alertsBadgeStyles";
    style.textContent = `
      @keyframes pulseBadge {
        0% { transform: scale(1); background-color: #f44336; }
        50% { transform: scale(1.2); background-color: #e53935; }
        100% { transform: scale(1); background-color: #f44336; }
      }
      .pulse {
        animation: pulseBadge 0.6s ease;
      }
    `;
    document.head.appendChild(style);
  }

  const currentUserId = auth.currentUser?.uid || null;
  let previousUnreadCount = 0;

  try {
    const snapshot = await db.collection("alerts")
      .orderBy("timestamp", "desc")
      .limit(50)
      .get();

    // Hide the spinner once data is loaded
    spinner.style.display = "none";

    if (snapshot.empty) {
      container.innerHTML = "<h3>🔔 Alerts</h3><p style='color:#777;'>No alerts yet.</p>";
      if (badge) badge.style.display = "none";
      previousUnreadCount = 0;
      return;
    }

    const alerts = [];
    snapshot.forEach(doc => {
      alerts.push({ id: doc.id, ref: doc.ref, ...doc.data() });
    });

    // Sort unread first
    alerts.sort((a, b) => {
      const aRead = a.readBy?.includes(currentUserId) || false;
      const bRead = b.readBy?.includes(currentUserId) || false;
      if (aRead !== bRead) return aRead ? 1 : -1;
      return (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0);
    });

    const unreadAlerts = alerts.filter(a => !a.readBy?.includes(currentUserId));

    // 🔹 Update badge with animation if new alerts come in
    if (badge) {
      if (unreadAlerts.length > 0) {
        badge.textContent = unreadAlerts.length;
        badge.style.display = "inline-block";

        // Trigger pulse animation only if count increased
        if (unreadAlerts.length > previousUnreadCount) {
          badge.classList.remove("pulse");
          void badge.offsetWidth; // Restart animation
          badge.classList.add("pulse");
        }
      } else {
        badge.style.display = "none";
      }
    }

    previousUnreadCount = unreadAlerts.length;

    let alertsHTML = "<h3>🔔 Alerts</h3>";

    // Top buttons
    alertsHTML += `
      <div style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
        ${unreadAlerts.length > 0 && currentUserId ? `
          <button onclick="confirmMarkAllAlertsAsRead(${unreadAlerts.length})"
            style="background:#4caf50;color:white;border:none;padding:6px 12px;
            border-radius:6px;cursor:pointer;">
            ✅ Mark All as Read (${unreadAlerts.length})
          </button>` : ""}
        <button onclick="confirmDeleteAllAlerts()"
          style="background:#f44336;color:white;border:none;padding:6px 12px;
          border-radius:6px;cursor:pointer;">
          🗑️ Delete All
        </button>
      </div>
    `;

    alerts.forEach(data => {
      const alertId = data.id;
      const timestamp = data.timestamp?.toDate
        ? new Date(data.timestamp.toDate()).toLocaleString()
        : "Unknown date";

      const isRead = data.readBy?.includes(currentUserId);

      const readButton = (!isRead && currentUserId)
        ? `<button onclick="markAlertAsRead('${alertId}')"
              style="background:#4caf50;color:white;border:none;padding:4px 8px;
              border-radius:4px;font-size:12px;cursor:pointer;">
              ✅ Mark as Read
           </button>`
        : `<span style="color:${isRead ? 'green' : 'red'}; font-size:12px;">
            ${isRead ? '✅ Read' : '🆕 Unread'}
           </span>`;

      const deleteButton = (data.userId === currentUserId)
        ? `<button onclick="confirmDeleteAlert('${alertId}')"
            style="background:#f44336;color:white;border:none;padding:4px 8px;
            border-radius:4px;font-size:12px;cursor:pointer;">
            🗑️ Delete
           </button>`
        : "";

      alertsHTML += `
        <div class="alert-card" style="
          border-left:4px solid ${isRead ? '#4caf50' : '#f44336'};
          padding:8px;
          margin-bottom:10px;
          box-shadow:0 1px 4px rgba(0,0,0,0.08);
          border-radius:6px;
          background:${isRead ? '#e0f7fa' : '#fff3e0'};">
          <div class="alert-content">
            <strong>${escapeHTML(data.title)}</strong><br>
            ${escapeHTML(data.message)}<br>
            <small>${timestamp}</small><br>
            <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;">
              ${readButton}
              ${deleteButton}
            </div>
          </div>
        </div>
      `;
    });

    container.innerHTML = alertsHTML;

  } catch (err) {
    console.error("❌ Error loading alerts:", err);
    // Hide the spinner on error as well
    spinner.style.display = "none";
    container.innerHTML = "<h3>🔔 Alerts</h3><p style='color:#777;'>Failed to load alerts. Please try again.</p>";
  }
}



// Escape HTML
function escapeHTML(str) {
  return str ? str.replace(/[&<>"']/g, tag =>
    ({"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[tag] || tag)
  ) : "";
}

// Mark single alert as read
async function markAlertAsRead(alertId) {
  const currentUserId = auth.currentUser?.uid;
  if (!currentUserId) return;
  try {
    await db.collection("alerts").doc(alertId).update({
      readBy: firebase.firestore.FieldValue.arrayUnion(currentUserId)
    });
    showCustomAlert("✅ Alert marked as read", "success");
  } catch (error) {
    showCustomAlert("❌ Failed to mark as read: " + error.message, "error");
  }
}

// Confirm mark all read
function confirmMarkAllAlertsAsRead(unreadCount) {
  showToastConfirm(`Mark all ${unreadCount} alerts as read?`, markAllAlertsAsRead);
}

// ✅ Mark All Alerts as Read
async function markAllAlertsAsRead() {
  const currentUserId = auth.currentUser?.uid;
  if (!currentUserId) return;

  const spinner = document.getElementById("loadingSpinner"); // Spinner element

  // Show spinner while marking alerts as read
  spinner.style.display = "flex";

  try {
    const snapshot = await db.collection("alerts").get();
    const batch = db.batch();

    snapshot.forEach(doc => {
      batch.update(doc.ref, {
        readBy: firebase.firestore.FieldValue.arrayUnion(currentUserId)
      });
    });

    await batch.commit();
    showCustomAlert("✅ All alerts marked as read", "success");
  } catch (error) {
    showCustomAlert("❌ Error marking all as read: " + error.message, "error");
  } finally {
    // Hide spinner once the operation is complete (either success or error)
    spinner.style.display = "none";
  }
}


// Confirm delete single
function confirmDeleteAlert(alertId) {
  showToastConfirm("🗑️ Delete this alert?", () => deleteAlert(alertId));
}

// ✅ Delete Single Alert
async function deleteAlert(alertId) {
  const spinner = document.getElementById("loadingSpinner"); // Spinner element

  // Show spinner while deleting the alert
  spinner.style.display = "flex";

  try {
    await db.collection("alerts").doc(alertId).delete();
    showCustomAlert("🗑️ Alert deleted", "success");
  } catch (error) {
    showCustomAlert("❌ Error deleting alert: " + error.message, "error");
  } finally {
    // Hide spinner once the operation is complete (either success or error)
    spinner.style.display = "none";
  }
}

// Confirm delete all
function confirmDeleteAllAlerts() {
  showToastConfirm("⚠️ Delete ALL alerts?", deleteAllAlerts);
}

// ✅ Delete All Alerts
async function deleteAllAlerts() {
  const spinner = document.getElementById("loadingSpinner"); // Spinner element

  // Show spinner while deleting all alerts
  spinner.style.display = "flex";

  try {
    const snapshot = await db.collection("alerts").get();
    if (snapshot.empty) {
      showCustomAlert("ℹ️ No alerts to delete", "info");
      return;
    }

    const batch = db.batch();
    snapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    showCustomAlert("🗑️ All alerts deleted", "success");
  } catch (error) {
    showCustomAlert("❌ Error deleting all alerts: " + error.message, "error");
  } finally {
    // Hide spinner once the operation is complete (either success or error)
    spinner.style.display = "none";
  }
}


async function loadInterestCount(itemId) {
  try {
    const snapshot = await db.collection("marketItems").doc(itemId).collection("interests").get();
    const count = snapshot.size;
    const el = document.getElementById(`marketInterestCount-${itemId}`);
    if (el) el.innerText = count;
  } catch (err) {
    console.error(`Failed to load interest count for ${itemId}`, err);
  }
}

function openAllReviewsModal(itemId) {
  document.getElementById("allReviewsModal").style.display = "flex";
  loadReviews("market", itemId, true); // ✅ Fixed: use "market" as section name
}

function closeAllReviewsModal() {
  document.getElementById("allReviewsModal").style.display = "none";
  document.getElementById("allReviewsContainer").innerHTML = "";
}

let currentReviewingItemId = null;
let currentReviewingType = "market"; // "market" or "service"

function openReviewModal(itemId, type = "market") {
  currentReviewingItemId = itemId;
  currentReviewingType = type;
  document.getElementById("reviewModal").style.display = "flex";
}

function closeReviewModal() {
  document.getElementById("reviewModal").style.display = "none";
  document.getElementById("reviewEmail").value = "";
  document.getElementById("reviewComment").value = "";
  currentReviewingItemId = null;
  currentReviewingType = "market";
}

// ✅ Submit Review from Modal
async function submitReviewFromModal() {
  const email = document.getElementById("reviewEmail").value.trim();
  const comment = document.getElementById("reviewComment").value.trim();

  if (!email || !comment) {
    alert("Please fill in both email and comment.");
    return;
  }

  const review = {
    email,
    comment,
    timestamp: new Date(),
    userId: currentUser?.uid || null
  };

  const spinner = document.getElementById("loadingSpinner"); // Get the spinner element
  spinner.style.display = "flex"; // Show the spinner before starting the process

  try {
    const ref = (currentReviewingType === "service" ? servicesRef : marketRef)
      .doc(currentReviewingItemId)
      .collection("reviews");

    await ref.add(review); // Add the review

    closeReviewModal(); // Close the modal after submission
    showCustomAlert("✅ Review submitted!", "success");

    // Reload reviews depending on type
    if (currentReviewingType === "service") {
      loadServiceReviews(currentReviewingItemId);
    } else {
      loadReviews("market", currentReviewingItemId); // ✅ fixed call
    }
  } catch (err) {
    console.error("❌ Failed to submit review:", err);
    showCustomAlert("❌ Failed to submit review", "error");
  } finally {
    spinner.style.display = "none"; // Hide the spinner after the process is done
  }
}
async function loadReviews(section, itemId, intoModal = false) {
  let ref;
  if (section === "market") ref = marketRef.doc(itemId);
  else if (section === "service") ref = serviceRef.doc(itemId);
  else return;

  const container = intoModal
    ? document.getElementById("allReviewsContainer")
    : null;

  if (!container) return;

  // Show loading spinner
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show spinner while loading

  container.innerHTML = "";

  try {
    const snapshot = await ref.collection("reviews").orderBy("timestamp", "desc").get();
    if (snapshot.empty) {
      container.innerHTML = "<p style='padding:10px;color:#999;'>No reviews yet.</p>";
      return;
    }

    const currentUser = auth.currentUser;
    const currentEmail = currentUser?.email || "";
    const isAdmin = [
      "mashabiki@teacherswapskenya.com",
      "sironga1@teacherswapskenya.com",
      "admin1@teacherswapskenya.com"
    ].includes(currentEmail);

    snapshot.forEach(doc => {
      const review = doc.data();
      const reviewId = doc.id;
      const isOwner = currentEmail === review.email;

      const div = document.createElement("div");
      div.className = "review";
      div.style.border = "1px solid #ddd";
      div.style.margin = "5px 0";
      div.style.padding = "10px";
      div.style.borderRadius = "5px";

      div.innerHTML = `
        <p style="margin: 5px 0;"><strong>${review.email || "Anonymous"}:</strong></p>
        <p style="margin: 0;">${review.comment}</p>
      `;

      // ✅ Show delete button if admin or owner
      if (isAdmin || isOwner) {
        const delBtn = document.createElement("button");
        delBtn.textContent = "🗑️ Delete";
        delBtn.style.cssText = `
          margin-top: 5px;
          background: red;
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 4px;
          cursor: pointer;
        `;

        delBtn.onclick = () => {
          showDeleteModal(async () => {
            try {
              await ref.collection("reviews").doc(reviewId).delete();
              showCustomAlert("Review deleted successfully.", "success");
              loadReviews(section, itemId, intoModal); // Reload after delete
            } catch (err) {
              console.error("Failed to delete review:", err);
              showCustomAlert("Failed to delete review.", "error");
            }
          });
        };

        div.appendChild(delBtn);
      }

      container.appendChild(div);
    });
  } catch (error) {
    console.error("Error loading reviews:", error);
    container.innerHTML = "<p style='color:red;padding:10px;'>Failed to load reviews.</p>";
  } finally {
    // Hide the spinner once done
    if (spinner) spinner.style.display = "none";
  }
}


function showDeleteModal(onConfirm) {
  const modal = document.createElement("div");
  modal.innerHTML = `
    <div style="
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6); display: flex;
      align-items: center; justify-content: center; z-index: 9999;">
      <div style="
        background: white; padding: 20px; border-radius: 10px;
        max-width: 400px; text-align: center; font-family: sans-serif;">
        <h3 style="margin-bottom: 10px;">⚠️ Confirm Deletion</h3>
        <p style="margin-bottom: 20px;">Are you sure you want to delete this review?</p>
        <button id="confirmDelete" style="
          background: red; color: white; border: none;
          padding: 10px 20px; border-radius: 5px; margin-right: 10px;
          cursor: pointer;">Yes, Delete</button>
        <button id="cancelDelete" style="
          background: gray; color: white; border: none;
          padding: 10px 20px; border-radius: 5px;
          cursor: pointer;">Cancel</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  modal.querySelector("#cancelDelete").onclick = () => modal.remove();
  modal.querySelector("#confirmDelete").onclick = () => {
    onConfirm();
    modal.remove();
  };
}


async function submitReviewReply(section, itemId, reviewId) {
  const input = document.getElementById(`replyInput-${reviewId}`);
  const replyText = input?.value.trim();

  if (!replyText) {
    alert("Please write a reply before submitting.");
    return;
  }

  const reply = {
    comment: replyText,
    timestamp: new Date(),
    userId: currentUser?.uid || null
  };

  // Show the loading spinner
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show spinner during submission

  try {
    let ref;
    if (section === "market" || section === "marketItems") {
      ref = db.collection("marketItems").doc(itemId).collection("reviews").doc(reviewId);
    } else if (section === "service") {
      ref = db.collection("services").doc(itemId).collection("reviews").doc(reviewId);
    } else {
      return;
    }

    await ref.collection("replies").add(reply);
    showCustomAlert("✅ Reply posted!", "success");

    // Reload reviews to reflect the new reply
    loadReviews(section, itemId, true);

  } catch (err) {
    console.error("❌ Failed to submit reply:", err);
    showCustomAlert("❌ Failed to submit reply", "error");
  } finally {
    // Hide the spinner once done
    if (spinner) spinner.style.display = "none";
  }
}


async function reportMarketItem(itemId) {
  showReportConfirmModal(async () => {
    const user = firebase.auth().currentUser;
    if (!user) return showCustomAlert("⚠️ You must be logged in to report an item.", "warning");

    // Show loading spinner while the report is being processed
    const spinner = document.getElementById("loadingSpinner");
    if (spinner) spinner.style.display = "flex"; // Show spinner during the report process

    try {
      const itemSnap = await marketRef.doc(itemId).get();
      const item = itemSnap.data();
      const itemOwnerId = item?.userId;

      if (!item) throw new Error("Item not found");

      // Save the report to Firestore
      await db.collection("marketReports").add({
        itemId,
        reportedBy: user.uid,
        reporterName: user.displayName || user.email,
        itemName: item.name || "Unnamed Item",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Notify Admins
      await db.collection("adminNotifications").add({
        type: "Market Report",
        itemId,
        itemName: item.name || "Unnamed Item",
        reportedBy: user.displayName || user.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        message: `🚩 Market item "${item.name}" was reported by ${user.displayName || user.email}.`
      });

      // Notify Item Owner
      if (itemOwnerId && itemOwnerId !== user.uid) {
        await db
          .collection("userNotifications")
          .doc(itemOwnerId)
          .collection("notifications")
          .add({
            type: "Item Reported",
            itemId,
            itemName: item.name,
            from: user.displayName || user.email,
            message: `⚠️ Your market item "${item.name}" has been reported by a user.`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            read: false
          });
      }

      showCustomAlert("✅ Report submitted. Admin will review it shortly.", "success");
    } catch (error) {
      console.error("❌ Report failed:", error);
      showCustomAlert("❌ Could not report the item. Try again.", "error");
    } finally {
      // Hide the spinner once done
      if (spinner) spinner.style.display = "none";
    }
  });
}

async function loadUserNotifications() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const snapshot = await db
    .collection("userNotifications")
    .doc(user.uid)
    .collection("notifications")
    .orderBy("timestamp", "desc")
    .get();

  snapshot.forEach((doc) => {
    const notif = doc.data();
    // Display in your preferred HTML section
    console.log("🔔", notif.message);
  });
}
async function showMarketInterest(itemId) {
  const user = firebase.auth().currentUser;

  if (!user) {
    showCustomAlert("🔐 You need to be logged in to express interest.", "info");
    return;
  }

  // Show loading spinner while processing
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show spinner during the process

  const itemRef = db.collection("marketItems").doc(itemId);
  const interestRef = itemRef.collection("interests").doc(user.uid);
  const interestDoc = await interestRef.get();

  if (interestDoc.exists) {
    showCustomAlert("❌ You have already expressed interest in this item.", "info");
    if (spinner) spinner.style.display = "none"; // Hide spinner if already interested
    return;
  }

  const interestCountElement = document.getElementById(`marketInterestCount-${itemId}`);
  if (interestCountElement) {
    let interestCount = parseInt(interestCountElement.innerText) || 0;
    interestCount += 1;
    interestCountElement.innerText = interestCount;
  }

  try {
    // Save interest
    await interestRef.set({
      userId: user.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    // ✅ Get item details including phone & location from marketItems
    const itemSnap = await itemRef.get();
    const item = itemSnap.data();
    const posterId = item?.postedBy;
    const itemName = item?.name || "this item";
    const posterPhone = item?.phone || "No phone provided";
    const posterLocation = `${item?.county || ""} ${item?.subcounty || ""}`.trim() || "No location provided";

    const userName = user.displayName || user.email || "Someone";

    // Notify Admin (plain text phone number)
    await sendMarketInterestNotification(itemId, userName, itemName, posterPhone, posterLocation);

    // Notify poster if it's not the same person
    if (posterId && posterId !== user.uid) {
      await db.collection("alerts").add({
        title: "❤️ New Interest",
        message: `${userName} is interested in your item: "${itemName}".\n📞 Phone: ${posterPhone}\n📍 Location: ${posterLocation}`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        targetUserId: posterId
      });
    }

    showCustomAlert("✅ Your interest has been recorded!", "success");

  } catch (err) {
    console.error("Error recording interest:", err);
    showCustomAlert("❌ Failed to record your interest. Please try again later.", "error");
  } finally {
    // Hide the spinner once done
    if (spinner) spinner.style.display = "none";
  }
}


// ✅ Admin notification function
async function sendMarketInterestNotification(itemId, userName, itemName, phone, location) {
  const notificationRef = db.collection("adminNotifications").doc();
  await notificationRef.set({
    type: "Market Interest",
    message: `${userName} (📞 ${phone}, 📍 ${location}) has expressed interest in "${itemName}".`,
    itemId: itemId,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    read: false
  });
}




async function openEditForm(itemId) {
  const itemRef = marketRef.doc(itemId);

  try {
    const doc = await itemRef.get();
    if (!doc.exists) {
      console.error("Item not found");
      return;
    }

    const itemData = doc.data();
    console.log("Item data fetched:", itemData);

    // Populate the form with the current data
    document.getElementById("itemName").value = itemData.name || '';
    document.getElementById("itemPrice").value = itemData.price || '';
    document.getElementById("itemDescription").value = itemData.description || '';
    document.getElementById("itemCategory").value = itemData.category || '';
    document.getElementById("itemLocation").value = itemData.county || '';

    // Change button text to 'Update Item'
    const submitButton = document.querySelector("#captureMarketItemForm button");
    submitButton.innerHTML = "Update Item";

    // Handle form submission
    document.getElementById("captureMarketItemForm").onsubmit = function(event) {
      event.preventDefault(); // Prevent form submission
      saveItemChanges(itemId); // Save the changes
    };

    console.log('Form is ready to be edited.');
  } catch (error) {
    console.error("Error fetching item data:", error);
  }
}

// Save the changes made in the form
async function saveItemChanges(itemId) {
  const updatedItem = {
    name: document.getElementById("itemName").value,
    price: parseFloat(document.getElementById("itemPrice").value),
    description: document.getElementById("itemDescription").value,
    category: document.getElementById("itemCategory").value,
    county: document.getElementById("itemLocation").value,
  };

  console.log("Saving updated item:", updatedItem);

  // Show the loading spinner
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show spinner during the process

  try {
    const itemRef = marketRef.doc(itemId);
    await itemRef.update(updatedItem);

    console.log("Item successfully updated!");
    showCustomAlert("✅ Item updated successfully!", "success");

    loadMarketItems(); // Refresh the market items to reflect changes

  } catch (error) {
    console.error("Error updating item:", error);
    showCustomAlert("❌ Failed to update item. Try again later.", "error");

  } finally {
    // Hide the loading spinner after the operation completes
    if (spinner) spinner.style.display = "none";
  }
}


function showReportConfirmModal(onConfirm) {
  const overlay = document.createElement("div");
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5); z-index: 9998; display: flex;
    align-items: center; justify-content: center;
  `;

  const box = document.createElement("div");
  box.style.cssText = `
    background: white; padding: 20px 30px; border-radius: 12px;
    text-align: center; max-width: 360px; font-size: 1.1em;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  `;
  box.innerHTML = `
    <p style="margin-bottom: 20px;">🚩 Are you sure you want to report this item?</p>
    <button id="reportConfirmYes" style="margin-right: 10px; padding: 8px 16px; border: none; border-radius: 5px; background: #f44336; color: white; cursor: pointer;">Yes, Report</button>
    <button id="reportConfirmCancel" style="padding: 8px 16px; border: none; border-radius: 5px; background: #ccc; color: black; cursor: pointer;">Cancel</button>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById("reportConfirmYes").onclick = () => {
    document.body.removeChild(overlay);
    onConfirm();
  };

  document.getElementById("reportConfirmCancel").onclick = () => {
    document.body.removeChild(overlay);
  };
}

function showCustomAlert(message, type = "info") {
  const colors = {
    success: "#4caf50",
    error: "#f44336",
    warning: "#ff9800",
    info: "#2196f3"
  };

  const alertBox = document.createElement("div");
  alertBox.innerText = message;

  Object.assign(alertBox.style, {
    position: "fixed",
    top: "50%",
    left: "50%",
    transform: "translate(-50%, -50%)",
    backgroundColor: colors[type] || "#333",
    color: "#fff",
    padding: "16px 28px",
    fontSize: "1.1em",
    borderRadius: "10px",
    boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
    zIndex: "9999",
    textAlign: "center",
    opacity: "0",
    whiteSpace: "pre-line",
    transition: "opacity 0.3s ease, transform 0.3s ease",
  });

  document.body.appendChild(alertBox);

  setTimeout(() => {
    alertBox.style.opacity = "1";
    alertBox.style.transform = "translate(-50%, -50%) scale(1.05)";
  }, 10);

  setTimeout(() => {
    alertBox.style.opacity = "0";
    alertBox.style.transform = "translate(-50%, -50%) scale(0.95)";
    setTimeout(() => alertBox.remove(), 400);
  }, 3500);
}

async function boostMarketItem(id) {
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show the spinner before processing

  try {
    const itemRef = marketRef.doc(id);
    const doc = await itemRef.get();
    if (!doc.exists) {
      showCustomAlert("❌ Item not found.", "error");
      return;
    }

    const data = doc.data();
    const postedBy = data.postedBy; // Access postedBy from the Firestore document

    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      showCustomAlert("❌ You need to be logged in to boost an item.", "error");
      return;
    }

    // If the current user is the poster, prompt for payment
    if (currentUser.uid === postedBy) {
      // Show the payment modal for the poster
      showPaymentModalFor('boost', 250, id, data.name);
      return; // Stop the boosting process until payment is completed
    }

    // For admin or others, boost the item directly (free for admin)
    const boostExpiry = new Date();
    boostExpiry.setDate(boostExpiry.getDate() + 7);

    // Update the item to set it as boosted with an expiry date
    await itemRef.update({
      boosted: true,
      boostExpiry: firebase.firestore.Timestamp.fromDate(boostExpiry)
    });

    showCustomAlert("✅ Item boosted successfully (admin).", "success");
    loadMarketItems(); // Refresh the list to reflect the change

    // Create Admin Notification about Boost (Even for Admin boost)
    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: "Item Boosted",
      itemId: id,
      itemName: data.name,
      boostedBy: currentUser.displayName || currentUser.email,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: `🚀 Item "${data.name}" has been boosted by ${currentUser.displayName || currentUser.email} (Admin).`
    });

    console.log("Admin notification created for item boost");

  } catch (err) {
    console.error("❌ Boost error:", err);
    showCustomAlert("❌ Failed to boost: " + err.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none"; // Hide the spinner once done
  }
}

async function toggleSoldStatus(itemId) {
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show the spinner before processing

  try {
    const doc = await marketRef.doc(itemId).get();
    if (!doc.exists) {
      showCustomAlert("❌ Item not found.", "error");
      return;
    }

    const data = doc.data();
    if (!currentUser || currentUser.uid !== data.postedBy) {
      showCustomAlert("❌ You are not authorized to update this item.", "error");
      return;
    }

    const newStatus = !data.isSold;
    await marketRef.doc(itemId).update({ isSold: newStatus });

    showCustomAlert(`✔️ Item marked as ${newStatus ? "Sold Out" : "Available"}`, "success");
    loadMarketItems(); // Refresh the list

    // Create Admin Notification about Sold Out Status
    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: newStatus ? "Item Sold Out" : "Item Available",
      itemId: itemId,
      itemName: data.name,
      postedBy: data.postedBy,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: `🛒 Item "${data.name}" has been marked as ${newStatus ? "Sold Out" : "Available"} by ${data.postedBy}.`
    });

    console.log("Admin notification created for item sold out status");

  } catch (error) {
    console.error("❌ Error updating item status:", error);
    showCustomAlert("❌ Failed to update item status: " + error.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none"; // Hide the spinner once done
  }
}


// Function to update the button state when the item status changes in Firestore
function updateSoldOutButtonState(id) {
  const soldOutButton = document.getElementById(`soldOutBtn-${id}`);
  const itemRef = marketRef.doc(id);

  // Listen for updates to the isSold field in real-time
  itemRef.onSnapshot(doc => {
    const isSold = doc.data().isSold;

    // Update button text and disable accordingly
    if (isSold) {
      soldOutButton.innerText = "❌ Sold Out";
      soldOutButton.style.backgroundColor = "#f44336";
      soldOutButton.disabled = true;
    } else {
      soldOutButton.innerText = "✅ Mark as Sold";
      soldOutButton.style.backgroundColor = "#9e9e9e";
      soldOutButton.disabled = false;
    }
  });
}



// ✅ Ensure this runs after login
document.addEventListener("DOMContentLoaded", () => {
  if (typeof isAdmin === "undefined") isAdmin = false; // Fallback if not defined yet
  loadMarketItems();
});

function showCustomConfirm(message, onConfirm) {
  // Remove existing confirm box if any
  const existing = document.getElementById("customConfirmBox");
  if (existing) existing.remove();

  // Create confirm box wrapper
  const wrapper = document.createElement("div");
  wrapper.id = "customConfirmBox";
  wrapper.style.position = "fixed";
  wrapper.style.top = "0";
  wrapper.style.left = "0";
  wrapper.style.width = "100vw";
  wrapper.style.height = "100vh";
  wrapper.style.background = "rgba(0,0,0,0.5)";
  wrapper.style.display = "flex";
  wrapper.style.alignItems = "center";
  wrapper.style.justifyContent = "center";
  wrapper.style.zIndex = "9999";

  // Create modal box
  const modal = document.createElement("div");
  modal.style.background = "#fff";
  modal.style.padding = "20px 30px";
  modal.style.borderRadius = "10px";
  modal.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
  modal.style.textAlign = "center";

  modal.innerHTML = `
    <p style="margin-bottom:20px;font-size:16px;">${message}</p>
    <button id="confirmYesBtn" style="margin-right:10px;padding:8px 16px;background:#28a745;color:#fff;border:none;border-radius:5px;cursor:pointer;">Yes</button>
    <button id="confirmNoBtn" style="padding:8px 16px;background:#dc3545;color:#fff;border:none;border-radius:5px;cursor:pointer;">No</button>
  `;

  wrapper.appendChild(modal);
  document.body.appendChild(wrapper);

  // Wait until DOM is ready before binding events
  setTimeout(() => {
    document.getElementById("confirmYesBtn").onclick = () => {
      document.body.removeChild(wrapper);
      onConfirm();
    };

    document.getElementById("confirmNoBtn").onclick = () => {
      document.body.removeChild(wrapper);
    };
  }, 0);
}

function filterMarketItems() {
  const category = document.getElementById("filterItemCategory").value;
  const county = document.getElementById("filterItemCounty").value;

  let anyVisible = false;
  const allCards = document.querySelectorAll(".market-card");

  // Start the filtering process
  const filterItems = () => {
    allCards.forEach(card => {
      const matchesCategory = !category || card.dataset.category === category;
      const matchesCounty = !county || card.dataset.county === county;
      const visible = matchesCategory && matchesCounty;

      card.style.display = visible ? "" : "none";

      if (visible) anyVisible = true;
    });

    if (!anyVisible) {
      showCustomAlert("🚫 No matching items found.", "warning");
    }
  };

  // Using requestAnimationFrame for smooth DOM updates
  requestAnimationFrame(filterItems);
}


function showPaymentModalFor(type, amount, itemId, itemName) {
  // ✅ Decide modal title dynamically
  let titleText = "Pay to Unlock  ";

  // Verification payments
  if (type === "serviceVerification" || type === "marketVerification" || type === "soulmateVerification") {
    titleText = "Pay for Verification";
  }
  // Boost payments (auto-detect even if you pass service, market, soulmate, etc.)
  else if (type.toLowerCase().includes("boost") || type === "service" || type === "market" || type === "soulmate") {
    titleText = "Pay to Boost";
  }

  const modalHTML = `
    <div id="universalPayModal" class="modal" style="display:block; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999;">
      <div class="modal-content" style="margin:10% auto; padding:20px; background:#f9f9ff; border:2px solid #4CAF50; width:80%; max-width:400px; border-radius:10px; text-align:center; box-shadow: 0 0 10px rgba(0,0,0,0.3);">
        <h3 style="color:#2c3e50;">${titleText}: <span style="color:#4CAF50;">${itemName}</span></h3>
        <p style="font-size:16px;">Amount: <strong style="color:#388e3c;">Ksh ${amount}</strong></p>
        <input type="tel" id="universalPhone" placeholder="Enter your MPESA number (e.g. 0712345678)"
               style="padding: 10px; width:100%; margin-bottom:10px; border:1px solid #ccc; border-radius:6px;" />
        <button onclick="initiateStkPayment('${type}', ${amount}, '${itemId}', '${itemName}')"
                style="background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:6px; font-weight:bold;">
          📲 Pay with MPESA
        </button>
        <br/>
        <button onclick="closeUniversalModal()" 
                style="margin-top:10px; background:#e53935; color:white; border:none; padding:8px 16px; border-radius:6px;">
          ❌ Cancel
        </button>
        <p id="universalPaymentStatus" style="margin-top:10px; color:#555;"></p>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML("beforeend", modalHTML);
}

function closeUniversalModal() {
  const modal = document.getElementById("universalPayModal");
  if (modal) modal.remove();
}

// ✅ Unified STK Push Handler with unlock + boost + verification logic
async function initiateStkPayment(type, amount, itemId, itemName) {
  const phone = document.getElementById("universalPhone").value.trim();
  const statusEl = document.getElementById("universalPaymentStatus");

  if (!/^07\d{8}$/.test(phone)) {
    statusEl.innerText = "⚠️ Please enter a valid Safaricom number";
    return;
  }

  statusEl.innerText = "⏳ Sending STK Push...";

  try {
    const response = await fetch("http://localhost:3000/stkpush", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        phone,
        amount,
        accountReference: type,
        itemId,
        itemName,
        userId: currentUser?.uid || "anonymous"
      })
    });

    const data = await response.json();

    if (data.success) {
      statusEl.innerText = "✅ STK Push sent. Please complete payment on your phone.";

      const now = new Date();
      const isoNow = now.toISOString();
      const userRef = currentUser?.uid ? firebase.firestore().collection("users").doc(currentUser.uid) : null;

      // === Existing boosts & unlocks ===
      if (type === "soulmate") {
        const boostExpiry = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
        await firebase.firestore().collection("soulmates").doc(itemId).update({
          boosted: true,
          boostExpiry: boostExpiry
        });
        showCustomAlert("✅ Soulmate profile boosted successfully!", "success");
        loadSoulmates();
      }
      if (type === "bomjobs") {
        await userRef.set({ paidForBomJobs: isoNow }, { merge: true });
        localStorage.setItem("paidForBomJobs", isoNow);
      }
      if (type === "market") {
        await userRef.set({ paidToPostMarket: true }, { merge: true });
        localStorage.setItem("paidToPostMarket", "yes");
      }
      if (type === "service") {
        await userRef.set({ paidForService: true }, { merge: true });
        localStorage.setItem("paidForService", "yes");
      }
      if (type === "boost") {
        await firebase.firestore().collection("boostedItems").doc(itemId).set({
          boostedAt: isoNow,
          itemName,
          userId: currentUser?.uid
        }, { merge: true });
        localStorage.setItem(`boosted_${itemId}`, isoNow);
      }

      // === NEW: Verification badge handling ===
      if (type === "serviceVerification") {
        await servicesRef.doc(itemId).set({ verified: true }, { merge: true });
        showCustomAlert("✅ Service verified successfully!", "success");
        loadServices();
      }
      if (type === "marketVerification") {
        await marketRef.doc(itemId).set({ verified: true }, { merge: true });
        showCustomAlert("✅ Market item verified successfully!", "success");
        loadMarketItems();
      }
      if (type === "soulmateVerification") {
        await soulmateRef.doc(itemId).set({ verified: true }, { merge: true });
        showCustomAlert("✅ Soulmate profile verified successfully!", "success");
        loadSoulmates();
      }

      closeUniversalModal();

    } else {
      statusEl.innerText = `❌ Error: ${data.errorMessage || "Unknown failure"}`;
    }

  } catch (err) {
    statusEl.innerText = "❌ Network error: " + err.message;
  }
}

// ✅ Helper to trigger boost modal
function boostItem(itemId, itemName) {
  const amount = 100; 
  showPaymentModalFor("boost", amount, itemId, itemName);
}

function payForVerification(type, itemId, itemName) {
  // ✅ If admin, skip payment and verify instantly
  const adminEmails = [
    "mashabiki@teacherswapskenya.com",
    "sironga1@teacherswapskenya.com",
    "admin1@teacherswapskenya.com"
  ];

  if (currentUser && adminEmails.includes(currentUser.email)) {
    if (type === "serviceVerification") {
      servicesRef.doc(itemId).set({ verified: true }, { merge: true });
      showCustomAlert("✅ Service verified by Admin!", "success");
      loadServices();
    }
    if (type === "marketVerification") {
      marketRef.doc(itemId).set({ verified: true }, { merge: true });
      showCustomAlert("✅ Market item verified by Admin!", "success");
      loadMarketItems();
    }
    if (type === "soulmateVerification") {
      soulmateRef.doc(itemId).set({ verified: true }, { merge: true });
      showCustomAlert("✅ Soulmate profile verified by Admin!", "success");
      loadSoulmates();
    }
    return; // stop here, no payment needed
  }

  // ✅ If not admin, proceed to normal payment
  let amount = 100; // default fallback
  if (type === "serviceVerification") amount = 250;
  if (type === "marketVerification") amount = 500;
  if (type === "soulmateVerification") amount = 200;

  showPaymentModalFor(type, amount, itemId, itemName);
}


async function findMatchingSwaps() {
  if (!isLoggedIn || !currentUser) {
    showCustomAlert("You must be logged in to check swaps.", "error");
    return;
  }

  try {
    const swapsSnapshot = await db.collection("teacherSwaps").get();
    const swaps = [];

    // Collect all swaps
    swapsSnapshot.forEach(doc => {
      swaps.push({ id: doc.id, ...doc.data() });
    });

    // Check for matches
    const matches = [];
    swaps.forEach((swap1, index) => {
      swaps.forEach((swap2, idx) => {
        if (
          index !== idx &&
          swap1.subjectCombination === swap2.subjectCombination &&
          swap1.county === swap2.swapCounty &&
          swap1.swapCounty === swap2.county
        ) {
          matches.push(swap1);
        }
      });
    });

    if (matches.length > 0) {
      populateMatchesModal(matches);
    } else {
      showCustomAlert("No matching swaps found.", "info");
    }
  } catch (error) {
    console.error("Error finding matches:", error);
    showCustomAlert("Error finding matches: " + error.message, "error");
  }
}

function populateMatchesModal(matches) {
  const matchesList = document.getElementById("matchesList");
  matchesList.innerHTML = ""; // Clear previous entries

  matches.forEach(match => {
    const matchDiv = document.createElement("div");
    matchDiv.style.margin = "10px 0";
    matchDiv.innerHTML = `
      <p><strong>Name:</strong> ${match.teacherName}</p>
      <p><strong>Phone:</strong> ${match.phone}</p>
      <p><strong>Subjects:</strong> ${match.subjectCombination}</p>
      <p><strong>County:</strong> ${match.county}</p>
      <p><strong>Wants to Swap to:</strong> ${match.swapCounty}</p>
      <hr>
    `;
    matchesList.appendChild(matchDiv);
  });

  document.getElementById("matchesModal").style.display = "flex";
}

function closeMatchesModal() {
  document.getElementById("matchesModal").style.display = "none";
}
async function findTriangularSwaps() {
  if (!isLoggedIn || !currentUser) {
    showCustomAlert("You must be logged in to check triangular swaps.", "error");
    return;
  }

  try {
    const swapsSnapshot = await db.collection("teacherSwaps").get();
    const swaps = [];

    // Collect all swaps
    swapsSnapshot.forEach(doc => {
      swaps.push({ id: doc.id, ...doc.data() });
    });

    // Find triangular swaps
    const triangularSwaps = [];
    swaps.forEach((swapA, indexA) => {
      swaps.forEach((swapB, indexB) => {
        if (
          indexA !== indexB &&
          swapA.swapCounty === swapB.county &&
          swapA.county !== swapB.swapCounty
        ) {
          swaps.forEach((swapC, indexC) => {
            if (
              indexB !== indexC &&
              swapB.swapCounty === swapC.county &&
              swapC.swapCounty === swapA.county
            ) {
              triangularSwaps.push([swapA, swapB, swapC]);
            }
          });
        }
      });
    });

    if (triangularSwaps.length > 0) {
      populateTriangularSwapsModal(triangularSwaps);
    } else {
      showCustomAlert("No triangular swaps found.", "info");
    }
  } catch (error) {
    console.error("Error finding triangular swaps:", error);
    showCustomAlert("Error finding triangular swaps: " + error.message, "error");
  }
}

function populateTriangularSwapsModal(triangularSwaps) {
  const swapsList = document.getElementById("triangularSwapsList");
  swapsList.innerHTML = ""; // Clear previous entries

  triangularSwaps.forEach(([swapA, swapB, swapC]) => {
    const swapDiv = document.createElement("div");
    swapDiv.style.margin = "10px 0";
    swapDiv.innerHTML = `
      <div>
        <p><strong>Teacher A:</strong> ${swapA.teacherName} (${swapA.county} ? ${swapA.swapCounty})</p>
        <p><strong>Teacher B:</strong> ${swapB.teacherName} (${swapB.county} ? ${swapB.swapCounty})</p>
        <p><strong>Teacher C:</strong> ${swapC.teacherName} (${swapC.county} ? ${swapC.swapCounty})</p>
      </div>
      <hr>
    `;
    swapsList.appendChild(swapDiv);
  });

  document.getElementById("triangularSwapsModal").style.display = "flex";
}

// Close modal functionality
document.getElementById("closeTriangularSwapsModal").addEventListener("click", () => {
  document.getElementById("triangularSwapsModal").style.display = "none";
});

function showToast(message, type = "info") {
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.padding = "12px 18px";
  toast.style.marginTop = "10px";
  toast.style.borderRadius = "6px";
  toast.style.fontSize = "15px";
  toast.style.color = "white";
  toast.style.boxShadow = "0 4px 8px rgba(0,0,0,0.1)";
  toast.style.opacity = "0.95";
  toast.style.transition = "transform 0.3s ease, opacity 0.3s ease";

  // Color based on type
  switch (type) {
    case "success":
      toast.style.backgroundColor = "#28a745"; // Green
      break;
    case "error":
      toast.style.backgroundColor = "#dc3545"; // Red
      break;
    case "warning":
      toast.style.backgroundColor = "#ffc107"; // Yellow
      toast.style.color = "#000";
      break;
    default:
      toast.style.backgroundColor = "#007bff"; // Blue
  }

  // Add to container
  const container = document.getElementById("toastContainer");
  container.appendChild(toast);

  // Auto remove
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateX(100%)";
    setTimeout(() => container.removeChild(toast), 400);
  }, 3000);
}

function confirmDeleteSwap(callback) {
  const modal = document.getElementById("confirmDeleteModal");
  const progressBar = document.getElementById("confirmProgressBar");
  modal.style.display = "flex";

  let duration = 5; // seconds
  let width = 100;
  let interval;

  function startCountdown() {
    interval = setInterval(() => {
      width -= 100 / (duration * 10);
      progressBar.style.width = width + "%";

      if (width <= 0) {
        clearInterval(interval);
        modal.style.display = "none";
        callback(false);
        showToast(" Deletion timed out.", "warning");
      }
    }, 100);
  }

  // Confirm click
  document.getElementById("confirmYes").onclick = () => {
    clearInterval(interval);
    modal.style.display = "none";
    callback(true);
  };

  // Cancel click
  document.getElementById("confirmNo").onclick = () => {
    clearInterval(interval);
    modal.style.display = "none";
    callback(false);
    showToast(" Deletion cancelled.", "warning");
  };

  // Reset bar and start
  progressBar.style.width = "100%";
  startCountdown();
}

function showCustomAlert(message, type = "info") {
  const alertBox = document.createElement("div");
  alertBox.innerText = message;

  alertBox.style.position = "fixed";
  alertBox.style.top = "50%";
  alertBox.style.left = "50%";
  alertBox.style.transform = "translate(-50%, -50%)";
  alertBox.style.padding = "20px";
  alertBox.style.borderRadius = "8px";
  alertBox.style.color = "white";
  alertBox.style.zIndex = "1000";
  alertBox.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
  alertBox.style.fontSize = "16px";
  alertBox.style.textAlign = "center";

  if (type === "success") {
    alertBox.style.backgroundColor = "#4caf50";
  } else if (type === "error") {
    alertBox.style.backgroundColor = "#f44336";
  } else {
    alertBox.style.backgroundColor = "#007bff";
  }

  document.body.appendChild(alertBox);
  setTimeout(() => {
    alertBox.remove();
  }, 3000);
}

async function loadNotifications() {
  const myName = currentUser.displayName || currentUser.email;
  const ul = document.getElementById("notificationList");
  ul.innerHTML = "<li>Loading...</li>"; // Initial loading message

  if (!myName) {
    ul.innerHTML = "<li>Error: User name not available.</li>";
    return;
  }

  try {
    const snapshot = await db.collection("soulmateInterests")
      .where("toName", "==", myName)
      .orderBy("timestamp", "desc")
      .get();

    if (snapshot.empty) {
      ul.innerHTML = "<li>No notifications yet.</li>";
      return;
    }

    // Building the list items as a single string
    let notificationsHTML = "";
    snapshot.forEach(doc => {
      const d = doc.data();
      notificationsHTML += `<li>💌 <strong>${d.fromName}</strong> liked you!</li>`;
    });

    ul.innerHTML = notificationsHTML;
  } catch (err) {
    ul.innerHTML = `<li>Error loading notifications: ${err.message}</li>`;
  }
}

function filterSwaps() {
  // Show the spinner before processing the filter
  const container = document.getElementById("swapCardContainer");
  const spinner = document.getElementById("loadingSpinner");  // Make sure to add a spinner element in your HTML
  if (spinner) spinner.style.display = "flex";  // Show spinner

  const category = document.getElementById("filterCategory").value.toLowerCase();
  const swapCounty = document.getElementById("filterSwapCounty").value.toLowerCase();
  const swapSubCounty = document.getElementById("filterSwapSubCounty").value.toLowerCase();
  const hardship = document.getElementById("filterHardship").value.toLowerCase();
  const subject = document.getElementById("filterSubjectCombination").value.toLowerCase();

  const swapCards = document.querySelectorAll("#swapCardContainer .swap-card");
  let visibleCount = 0;

  swapCards.forEach(card => {
    const cardCategory = card.getAttribute("data-category").toLowerCase();
    const cardSwapCounty = card.getAttribute("data-swapcounty").toLowerCase();
    const cardSwapSubCounty = card.getAttribute("data-swapsubcounty").toLowerCase();
    const cardHardship = card.getAttribute("data-hardship").toLowerCase();
    const cardSubject = card.getAttribute("data-subject").toLowerCase();

    const matchesCategory = !category || cardCategory === category;
    const matchesCounty = !swapCounty || cardSwapCounty === swapCounty;
    const matchesSubCounty = !swapSubCounty || cardSwapSubCounty === swapSubCounty;
    const matchesHardship = !hardship || cardHardship === hardship;
    const matchesSubject = !subject || cardSubject.includes(subject);

    if (matchesCategory && matchesCounty && matchesSubCounty && matchesHardship && matchesSubject) {
      card.style.display = "block";
      visibleCount++;
    } else {
      card.style.display = "none";
    }
  });

  // Remove any existing no-results message
  const noResultsMsg = document.getElementById("noResultsMessage");
  if (noResultsMsg) noResultsMsg.remove();

  // If none visible, show message
  if (visibleCount === 0) {
    const msg = document.createElement("div");
    msg.id = "noResultsMessage";
    msg.style = "text-align:center;padding:20px;color:white;";
    msg.innerHTML = "💔 No swap requests match your filters.";
    container.appendChild(msg);
  }

  // Hide the spinner after the filtering process is complete
  if (spinner) spinner.style.display = "none";  // Hide spinner

  displayActiveFilters();
}


function resetSwapFilters() {
  // Show the spinner before processing the reset
  const container = document.getElementById("swapCardContainer");
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";  // Show spinner

  // Reset the filter values
  document.getElementById("filterCategory").value = "";
  document.getElementById("filterSwapCounty").value = "";
  document.getElementById("filterSwapSubCounty").value = "";
  document.getElementById("filterHardship").value = "";
  document.getElementById("filterSubjectCombination").value = "";

  // Call filterSwaps to reshow all items
  filterSwaps();

  // Hide the spinner after resetting and filtering
  if (spinner) spinner.style.display = "none";  // Hide spinner
}


function displayActiveFilters() {
  const activeFilters = document.getElementById("activeFilters");
  if (!activeFilters) return;
  activeFilters.innerHTML = "";

  const filters = [
    { label: "Category", value: document.getElementById("filterCategory").value },
    { label: "Swap County", value: document.getElementById("filterSwapCounty").value },
    { label: "Sub-county", value: document.getElementById("filterSwapSubCounty").value },
    { label: "Hardship", value: document.getElementById("filterHardship").value },
    { label: "Subject", value: document.getElementById("filterSubjectCombination").value }
  ];

  filters.forEach(f => {
    if (f.value) {
      const badge = document.createElement("span");
      badge.textContent = `${f.label}: ${f.value}`;
      badge.style.background = "#43a047";
      badge.style.color = "white";
      badge.style.padding = "5px 10px";
      badge.style.borderRadius = "6px";
      badge.style.marginRight = "5px";
      badge.style.fontSize = "13px";
      activeFilters.appendChild(badge);
    }
  });
}

// ✅ Hook up dynamic filtering on input changes
document.addEventListener("DOMContentLoaded", () => {
  const inputs = [
    "filterCategory",
    "filterSwapCounty",
    "filterSwapSubCounty",
    "filterHardship",
    "filterSubjectCombination"
  ];

  inputs.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (el.tagName === "INPUT") {
        el.addEventListener("keyup", filterSwaps);
      } else {
        el.addEventListener("change", filterSwaps);
      }
    }
  });
});

// 🔥 VIP Auto-flagging helper
const hotCounties = ["Nairobi", "Kisumu", "Mombasa", "Kisii", "Nakuru"];

async function markAsVIPSwap(swapId) {
  try {
    await db.collection("teacherSwaps").doc(swapId).update({ isVIP: true });
    showCustomAlert("🔥 Swap marked as VIP successfully!", "success");
    loadSwaps(); // refresh list
  } catch (err) {
    showCustomAlert("❌ Failed to mark VIP: " + err.message, "error");
  }
}

async function showHotSwaps() {
  try {
    const snapshot = await db.collection("teacherSwaps").get();
    const vipCandidates = [];

    snapshot.forEach(doc => {
      const s = doc.data();
      if (
        (hotCounties.includes(s.county) || hotCounties.includes(s.swapCounty)) &&
        !s.isVIP
      ) {
        vipCandidates.push({ id: doc.id, ...s });
      }
    });

    renderSwaps(vipCandidates); // This renders hot swap candidates only
  } catch (err) {
    showCustomAlert("❌ Failed to load hot swaps: " + err.message, "error");
  }
}

async function showVipSwaps() {
  if (!isLoggedIn) {
    return showCustomAlert("Please login to view VIP swaps.", "error");
  }

  await loadUserPaymentStatus(); // make sure payment flags are set

  const container = document.getElementById("vipSwapsList");
  container.innerHTML = "<p>Loading VIP swaps...</p>";
  document.getElementById("vipSwapsModal").style.display = "block";

  try {
    const snapshot = await db.collection("teacherSwaps")
      .orderBy("timestamp", "desc")
      .get();

    if (snapshot.empty) {
      container.innerHTML = "<p>No VIP swaps available at the moment.</p>";
      return;
    }

    let html = `<div style="display:flex; flex-wrap:wrap; gap:10px;">`;
    snapshot.forEach(doc => {
      const s = doc.data();

      // 🔥 Auto-VIP if from/to counties are in hot list
      const isVip = s.isVIP || hotCounties.includes(s.county) || hotCounties.includes(s.swapCounty);

      if (!isVip) return; // Only show swaps considered VIP

      const name = s.teacherName || "-";
      const school = s.category || "-";
      const subject = s.subjectCombination || "-";
      const from = `${s.county || '-'} (${s.subCounty || '-'})`;
      const to = `${s.swapCounty || '-'} (${s.swapSubCounty || '-'})`;

      let phoneDisplay = "";

      if (isAdmin || hasPaidVip1000) {
        phoneDisplay = `<p><strong>📞 Phone:</strong> <a href="tel:${s.phone}" style="color:green;">${s.phone}</a></p>`;
      } else {
        phoneDisplay = `
          <p><strong>📞 Phone:</strong> 
            <button onclick="promptVipPayment()" style="background:crimson; color:white; border:none; padding:6px 10px; border-radius:5px;">
              💰 Pay KES 1000 to Unlock VIP
            </button>
          </p>`;
      }

      html += `
        <div style="border:1px solid #ddd; padding:10px; border-radius:8px; width:260px;">
          <p><strong>👤 Name:</strong> ${name}</p>
          <p><strong>🏫 School Type:</strong> ${school}</p>
          <p><strong>📚 Subject(s):</strong> ${subject}</p>
          <p><strong>🔁 Swap From:</strong> ${from}</p>
          <p><strong>➡️ Swap To:</strong> ${to}</p>
          ${phoneDisplay}
        </div>
      `;
    });

    html += `</div>`;
    container.innerHTML = html;

  } catch (err) {
    container.innerHTML = `<p style="color:red;">Failed to load VIP swaps: ${err.message}</p>`;
  }
}

function promptVipPayment() {
  const confirmPayment = confirm("To unlock all VIP swaps, please pay KES 1000 to Paybill 123456, Account: VIPACCESS. Have you completed payment?");
  if (confirmPayment) {
    // Simulate update (replace with actual admin approval logic)
    db.collection("users").doc(currentUserId).update({
      hasPaidVip1000: true
    }).then(() => {
      hasPaidVip1000 = true;
      showCustomAlert("VIP access unlocked. Please reopen the VIP swaps.", "success");
    }).catch(err => {
      showCustomAlert("Error unlocking VIP access: " + err.message, "error");
    });
  }
}
async function loadUserPaymentStatus() {
  if (!currentUserId) return;

  const userDoc = await db.collection("users").doc(currentUserId).get();
  const data = userDoc.data();

  hasPaid100 = data?.hasPaid100 || false;
  hasPaidVip1000 = data?.hasPaidVip1000 || false;
  isAdmin = data?.role === "admin"; // optional
}

// ✅ Toast confirmation helper
function showToastConfirm(message, onConfirm) {
  const toast = document.createElement("div");
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #fff3cd;
    color: #856404;
    padding: 14px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    font-size: 14px;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: fadeIn 0.3s ease-out;
  `;

  toast.innerHTML = `
    <span style="flex:1;">${message}</span>
    <button id="toastYes" style="
      background:#28a745;
      color:white;
      border:none;
      padding:4px 10px;
      border-radius:4px;
      cursor:pointer;">✅ Yes</button>
    <button id="toastNo" style="
      background:#dc3545;
      color:white;
      border:none;
      padding:4px 10px;
      border-radius:4px;
      cursor:pointer;">❌ No</button>
  `;

  document.body.appendChild(toast);

  document.getElementById("toastYes").onclick = () => {
    toast.remove();
    onConfirm();
  };
  document.getElementById("toastNo").onclick = () => {
    toast.remove();
  };

  setTimeout(() => toast.remove(), 8000); // auto-hide
}

async function loadAdminNotifications() {
  const list = document.getElementById("notificationList");
  const spinner = document.getElementById("loadingSpinner");

  // Show the spinner before starting the loading process
  if (spinner) spinner.style.display = "flex"; 

  list.innerHTML = "<p>Loading...</p>";

  try {
    const snapshot = await db.collection("adminNotifications")
      .orderBy("timestamp", "desc")
      .get();

    if (snapshot.empty) {
      list.innerHTML = "<p style='color:#666; font-style: italic;'>No admin notifications yet.</p>";
      updateAdminNotifBadge(0);
      return;
    }

    const notifications = [];
    snapshot.forEach(doc => {
      notifications.push({ id: doc.id, ref: doc.ref, ...doc.data() });
    });

    // Sort unread first
    notifications.sort((a, b) => {
      if (a.read !== b.read) return a.read ? 1 : -1;
      return (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0);
    });

    const unreadCount = notifications.filter(n => !n.read).length;
    updateAdminNotifBadge(unreadCount);

    let html = `
      <li style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
        ${unreadCount > 0 ? `
          <button onclick="confirmMarkAllAdminNotificationsAsRead(${unreadCount})"
            style="background:#4caf50;color:white;border:none;padding:6px 12px;
            border-radius:6px;cursor:pointer;">
            ✅ Mark All as Read (${unreadCount})
          </button>` : ""}
        <button onclick="confirmDeleteAllAdminNotifications()"
          style="background:#f44336;color:white;border:none;padding:6px 12px;
          border-radius:6px;cursor:pointer;">
          🗑️ Delete All
        </button>
      </li>
    `;

    notifications.forEach(n => {
      const color = getNotificationColor(n.type);
      const timestamp = n.timestamp?.toDate
        ? new Date(n.timestamp.toDate()).toLocaleString()
        : "Unknown date";

      html += `
        <li style="
          margin-bottom: 12px;
          padding: 12px 16px;
          border-radius: 10px;
          cursor: pointer;
          box-shadow: 0 2px 6px rgba(0,0,0,0.1);
          display: flex;
          flex-direction: column;
          gap: 6px;
          position: relative;
          background: ${n.read ? '#e0f7fa' : '#fff3e0'};
          border-left: 6px solid ${color};
        "
        onclick="openPostedItem('${(n.type || '').toLowerCase()}', '${n.itemId || ''}')"
        onmouseenter="this.style.backgroundColor='#dcedc8'"
        onmouseleave="this.style.backgroundColor='${n.read ? '#e0f7fa' : '#fff3e0'}'">

          <strong style="font-size: 1.1em; color: ${color};">
            ${escapeHTML(n.type || "Notification")}
          </strong>
          <span style="color:#333; line-height: 1.4;">
            ${escapeHTML(n.message || "")}
          </span>
          <small style="color: #666; font-size: 0.85em;">${timestamp}</small>

          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            ${!n.read ? `
              <button onclick="event.stopPropagation(); markAdminNotificationAsRead('${n.id}')"
                style="background:#4caf50;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                Mark as Read
              </button>` 
              : `<span style="color:green;font-size:12px;">✅ Read</span>`}

            <button onclick="event.stopPropagation(); confirmDeleteAdminNotification('${n.id}')"
              style="background:#f44336;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
              🗑️ Delete
            </button>
          </div>
        </li>
      `;
    });

    list.innerHTML = html;

  } catch (err) {
    list.innerHTML = `<p style="color:red;">Error loading notifications: ${err.message}</p>`;
  } finally {
    // Hide the spinner after the notifications are loaded
    if (spinner) spinner.style.display = "none";  // Hide spinner
  }

  function escapeHTML(str) {
    return str ? str.replace(/[&<>"']/g, tag =>
      ({"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[tag] || tag)
    ) : "";
  }

  function getNotificationColor(type) {
    if (!type) return '#607d8b';
    const t = type.toLowerCase();
    if (t.includes('error') || t.includes('fail') || t.includes('delete')) return '#e53935';
    if (t.includes('success') || t.includes('completed') || t.includes('updated')) return '#43a047';
    if (t.includes('warning') || t.includes('caution')) return '#fbc02d';
    if (t.includes('info') || t.includes('notification')) return '#1e88e5';
    return '#00796b';
  }
}

// ✅ Single read
async function markAdminNotificationAsRead(notificationId) {
  try {
    await db.collection("adminNotifications").doc(notificationId).update({ read: true });
    showCustomAlert("✅ Notification marked as read", "success");
  } catch (error) {
    showCustomAlert("❌ Error marking as read: " + error.message, "error");
  }
}

// ✅ Single delete (toast confirm)
function confirmDeleteAdminNotification(notificationId) {
  showToastConfirm("🗑️ Delete this notification?", () => deleteAdminNotification(notificationId));
}

async function deleteAdminNotification(notificationId) {
  // Show spinner when deletion starts
  document.getElementById('loadingSpinner').style.display = 'flex';

  try {
    await db.collection("adminNotifications").doc(notificationId).delete();
    // Hide spinner after successful deletion
    document.getElementById('loadingSpinner').style.display = 'none';

    showCustomAlert("🗑️ Notification deleted", "success");
  } catch (error) {
    // Hide spinner if there is an error
    document.getElementById('loadingSpinner').style.display = 'none';

    showCustomAlert("❌ Error deleting: " + error.message, "error");
  }
}


// ✅ Delete all (toast confirm)
function confirmDeleteAllAdminNotifications() {
  showToastConfirm("⚠️ Delete ALL admin notifications?", deleteAllAdminNotifications);
}

async function deleteAllAdminNotifications() {
  try {
    const snapshot = await db.collection("adminNotifications").get();
    if (snapshot.empty) {
      showCustomAlert("ℹ️ No notifications to delete", "info");
      return;
    }
    const batch = db.batch();
    snapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    showCustomAlert("🗑️ All admin notifications deleted", "success");
  } catch (error) {
    showCustomAlert("❌ Error deleting all: " + error.message, "error");
  }
}

// ✅ Mark all read (toast confirm)
function confirmMarkAllAdminNotificationsAsRead(unreadCount) {
  showToastConfirm(`Mark all ${unreadCount} as read?`, markAllAdminNotificationsAsRead);
}

async function markAllAdminNotificationsAsRead() {
  // Show spinner when the process starts
  document.getElementById('loadingSpinner').style.display = 'flex';

  try {
    const snapshot = await db.collection("adminNotifications").get();
    if (snapshot.empty) {
      // Hide the spinner if no notifications are found
      document.getElementById('loadingSpinner').style.display = 'none';
      showCustomAlert("ℹ️ No unread notifications", "info");
      return;
    }

    const batch = db.batch();
    snapshot.forEach(doc => batch.update(doc.ref, { read: true }));
    
    // Commit the batch
    await batch.commit();

    // Hide the spinner after the operation is successful
    document.getElementById('loadingSpinner').style.display = 'none';
    showCustomAlert("✅ All marked as read", "success");
  } catch (error) {
    // Hide the spinner if an error occurs
    document.getElementById('loadingSpinner').style.display = 'none';
    showCustomAlert("❌ Error marking all as read: " + error.message, "error");
  }
}


async function updateAdminNotifBadge() {
  const badge = document.getElementById("notifBadge");
  if (!isAdmin || !badge) return;

  try {
    const snapshot = await db.collection("adminNotifications")
      .where("read", "==", false)
      .get();

    const count = snapshot.size;

    if (count > 0) {
      badge.style.display = "inline-block";
      badge.textContent = count;
    } else {
      badge.style.display = "none";
    }
  } catch (err) {
    console.error("Failed to load notification badge:", err);
  }
}
let currentToastTimeout = null;

function showCustomToast(message) {
  // Remove any existing toast
  const existingToast = document.getElementById("customToast");
  if (existingToast) {
    existingToast.remove();
    clearTimeout(currentToastTimeout);
  }

  // Create new toast
  const toast = document.createElement("div");
  toast.id = "customToast";
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #323232;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 9999;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;
  `;
  toast.textContent = message;

  document.body.appendChild(toast);

  // Auto-remove after 3 seconds
  currentToastTimeout = setTimeout(() => {
    toast.remove();
  }, 3000);
}
async function deleteNotification(id) {
  const existingBox = document.getElementById("inlineNotifConfirmBox");
  if (existingBox) existingBox.remove();

  const box = document.createElement("div");
  box.id = "inlineNotifConfirmBox";
  box.style.cssText = `
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    padding: 18px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    z-index: 9999;
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    max-width: 90%;
    width: 320px;
    animation: fadeIn 0.3s ease;
  `;

  box.innerHTML = `
    <p style="margin: 0 0 16px; font-size: 15px; color: #333;">
      Are you sure you want to delete this notification?
    </p>
    <div style="display: flex; justify-content: center; gap: 10px;">
      <button id="notifConfirmYesBtn" style="background: #d32f2f; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">🗑️ Yes</button>
      <button id="notifConfirmNoBtn" style="background: #607d8b; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">Cancel</button>
    </div>
  `;

  document.body.appendChild(box);

  document.getElementById("notifConfirmYesBtn").onclick = async () => {
    // Show spinner when deletion starts
    document.getElementById('loadingSpinner').style.display = 'flex';

    box.remove();
    try {
      // Attempt to delete the notification
      await db.collection("adminNotifications").doc(id).delete();
      loadAdminNotifications();
      updateAdminNotifBadge();

      // Hide spinner after deletion completes
      document.getElementById('loadingSpinner').style.display = 'none';

      // Show success toast
      try {
        showCustomToast("✅ Notification deleted.");
      } catch (toastErr) {
        console.warn("Toast not initialized. Skipping toast.");
      }

    } catch (err) {
      // Hide spinner in case of error
      document.getElementById('loadingSpinner').style.display = 'none';

      console.error("Error deleting notification:", err);
      showCustomAlert("❌ Failed to delete: " + err.message, "error");
    }
  };

  document.getElementById("notifConfirmNoBtn").onclick = () => {
    box.remove();
  };
}

async function rateService(serviceId, stars) {
  if (!currentUser) {
    showCustomAlert("Error", "Please login to rate.");
    return;
  }
  
  const userId = currentUser.uid;
  const ratingRef = db.collection("ratings").doc(serviceId).collection("byUser").doc(userId);

  const existing = await ratingRef.get();
  if (existing.exists) {
    showCustomAlert("Error", "You already rated this service.");
    return;
  }

  // Show the spinner before the operation begins
  document.getElementById('loadingSpinner').style.display = 'flex';

  try {
    // Perform the rating
    await ratingRef.set({
      stars,
      ratedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Update the average rating
    updateAverageRating(serviceId);

    // Show success alert
    showCustomAlert("Success", "Your rating has been submitted.");
  } catch (err) {
    // Show error alert if the operation fails
    console.error("Error submitting rating:", err);
    showCustomAlert("Error", "Failed to submit your rating. Please try again.");
  } finally {
    // Hide the spinner after the operation is complete
    document.getElementById('loadingSpinner').style.display = 'none';
  }
}


async function updateAverageRating(serviceId) {
  const ratingSnap = await db.collection("ratings").doc(serviceId).collection("byUser").get();
  const total = ratingSnap.docs.reduce((sum, doc) => sum + doc.data().stars, 0);
  const count = ratingSnap.size;
  const avg = count ? (total / count).toFixed(1) : "No ratings yet";

  document.getElementById(`avgRating-${serviceId}`).innerText = `⭐ ${avg} (${count})`;

  // Fill stars based on average
  for (let i = 1; i <= 5; i++) {
    const starEl = document.getElementById(`star-${serviceId}-${i}`);
    if (starEl) starEl.style.color = i <= Math.round(avg) ? "#ffc107" : "#ccc";
  }
}

document.querySelector('#notifBadge').addEventListener('click', function() {
  showPage('messages'); // Open the messages page
  resetUnreadCount(); // Reset unread count to 0
});

function openPostedItem(type, itemId) {
  if (!type || !itemId) return;

  showPage(type); // Switch to the relevant page/tab

  let retries = 10; // retry every 200ms for 2 seconds
  const targetId = `${type}-${itemId}`;

  const tryScroll = () => {
    const target = document.getElementById(targetId);
    if (target) {
      target.scrollIntoView({ behavior: "smooth", block: "center" });
      target.style.transition = "background-color 0.5s ease";
      target.style.backgroundColor = "#fff9c4";
      setTimeout(() => {
        target.style.backgroundColor = "";
      }, 2000);
    } else if (retries > 0) {
      retries--;
      setTimeout(tryScroll, 200);
    } else {
      alert("❌ Item not found. It may not have loaded yet.");
    }
  };

  tryScroll();
}

function toggleEmojiPicker() {
  const picker = document.getElementById("emojiPicker");
  picker.style.display = picker.style.display === "block" ? "none" : "block";
  if (picker.innerHTML === '') populateEmojiPicker();
}

function populateEmojiPicker() {
  const picker = document.getElementById("emojiPicker");
  const emojis = ['😀','😁','😂','😅','😊','😍','😎','😢','😭','😡','😇','🤔','👍','🙏','💯','🔥','🎉','📱','💬','🕒','💖'];
  emojis.forEach(e => {
    const span = document.createElement("span");
    span.textContent = e;
    span.style.margin = "5px";
    span.style.fontSize = "20px";
    span.style.cursor = "pointer";
    span.onclick = () => {
      document.getElementById("chatInput").value += e;
      toggleEmojiPicker();
    };
    picker.appendChild(span);
  });
}

document.addEventListener('click', function(e) {
  const picker = document.getElementById("emojiPicker");
  if (picker && !picker.contains(e.target) && e.target.innerText !== '😀') {
    picker.style.display = "none";
  }
});

let previewFile = null;

function previewImage(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    document.getElementById('imagePreview').src = e.target.result;
    document.getElementById('imagePreviewContainer').style.display = 'block';
  };
  reader.readAsDataURL(file);
  previewFile = file;
}

function clearPreview() {
  previewFile = null;
  document.getElementById('mediaInput').value = ''; // Clear the file input
  document.getElementById('imagePreviewContainer').style.display = 'none'; // Hide preview
}

let recorder, audioBlob;

async function toggleRecording() {
  const recordBtn = document.getElementById("recordBtn");

  if (!recorder) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);
    const chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = async () => {
      audioBlob = new Blob(chunks, { type: 'audio/webm' });
      const storageRef = firebase.storage().ref(`voice_notes/${Date.now()}.webm`);
      await storageRef.put(audioBlob);
      const audioURL = await storageRef.getDownloadURL();
      await sendVoiceMessage(audioURL);
      recorder = null;
    };

    recorder.start();
    recordBtn.textContent = "⏹ Stop";
  } else {
    recorder.stop();
    recordBtn.textContent = "🎤";
  }
}

async function sendVoiceMessage(url) {
  const fromName = currentUser.displayName || currentUser.email;
  const timestamp = firebase.firestore.FieldValue.serverTimestamp();

  await db.collection("messages").doc(chatConversationId).collection("chats").add({
    from: fromName,
    fromUid: currentUser.uid,
    to: chatPartner.name,
    toUid: chatPartner.uid,
    type: "audio",
    content: url,
    read: false,
    timestamp
  });

  showCustomAlert("🎤 Voice note sent!", "success");
}
function shareLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation is not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(position => {
    const link = `https://www.google.com/maps?q=${position.coords.latitude},${position.coords.longitude}`;
    document.getElementById("chatInput").value = `My location: ${link}`;
    sendChatMessage('text');
  }, () => {
    alert("Failed to get your location");
  });
}
// Shows the alert popup
function showAlert(message) {
  // Check if an alert is already visible
  if (document.querySelector('.scroll-end-alert')) return;

  const alert = document.createElement('div');
  alert.className = 'scroll-end-alert';
  alert.textContent = message;
  document.body.appendChild(alert);

  setTimeout(() => {
    alert.remove();
  }, 3000); // Auto-remove after 3 seconds
}

// Detect scroll end inside a container
function watchScrollEnd(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.addEventListener('scroll', () => {
    const isAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 1;
    if (isAtBottom) {
      showAlert("🚩 You have reached the end for today.");
    }
  });
}

// Initialize for desired containers
document.addEventListener('DOMContentLoaded', () => {
  watchScrollEnd('jobContainer');
  watchScrollEnd('soulmateContainer');
  // Add more if needed
});
let toastTimeout;

function showCustomToast(message) {
  const toast = document.getElementById("customToast");
  const messageSpan = document.getElementById("toastMessage");
  
  messageSpan.textContent = message;
  toast.style.display = "block";
  
  // Trigger fade-in
  setTimeout(() => {
    toast.style.opacity = 1;
  }, 50);

  // Auto-dismiss after 5 seconds
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => {
    hideCustomToast();
  }, 5000);
}

function hideCustomToast() {
  const toast = document.getElementById("customToast");
  toast.style.opacity = 0;
  setTimeout(() => {
    toast.style.display = "none";
  }, 400);
}
async function deleteSoulmate(id) {
  // Remove any existing confirmation box
  const existingBox = document.getElementById("inlineToastConfirmBox");
  if (existingBox) existingBox.remove();

  // Create confirmation box
  const box = document.createElement("div");
  box.id = "inlineToastConfirmBox";
  box.style.cssText = `
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    padding: 18px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    z-index: 9999;
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    max-width: 90%;
    width: 300px;
    animation: fadeIn 0.3s ease;
  `;

  box.innerHTML = `
    <p style="margin: 0 0 16px; font-size: 15px; color: #333;">
      Are you sure you want to delete this soulmate profile?
    </p>
    <div style="display: flex; justify-content: center; gap: 10px;">
      <button id="confirmYesBtn" style="
        background: #e53935;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
      ">🗑️ Yes</button>
      <button id="confirmNoBtn" style="
        background: #607d8b;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
      ">Cancel</button>
    </div>
  `;

  document.body.appendChild(box);

  // Handle button events
  document.getElementById("confirmYesBtn").onclick = async () => {
    // Show spinner
    document.getElementById('loadingSpinner').style.display = 'flex';

    box.remove();
    try {
      await soulmateRef.doc(id).delete();

      // Hide spinner after deletion
      document.getElementById('loadingSpinner').style.display = 'none';

      showCustomAlert("✅ Profile deleted successfully.", "success");
      loadSoulmates(); // Refresh the soulmates list
    } catch (err) {
      // Hide spinner if error occurs
      document.getElementById('loadingSpinner').style.display = 'none';

      console.error("Error deleting soulmate:", err);
      showCustomAlert("❌ Failed to delete: " + err.message, "error");
    }
  };

  document.getElementById("confirmNoBtn").onclick = () => {
    box.remove();
    showCustomAlert("❎ Deletion canceled.", "info");
  };
}


  function toggleUsageNotes() {
    const notes = document.getElementById("usageNotes");
    notes.style.display = notes.style.display === "none" ? "block" : "none";
  }
function deleteMarketItem(id) {
  // Show spinner
  document.getElementById('loadingSpinner').style.display = 'flex';

  showCustomConfirm("Are you sure you want to delete this market item?", () => {
    marketRef.doc(id).delete()
      .then(() => {
        // Hide spinner after deletion is successful
        document.getElementById('loadingSpinner').style.display = 'none';

        showCustomAlert("🗑️ Item deleted successfully.", "success");
        loadMarketItems(); // refresh the market items
      })
      .catch(err => {
        // Hide spinner if error occurs
        document.getElementById('loadingSpinner').style.display = 'none';

        console.error("❌ Error deleting item:", err);
        showCustomAlert("❌ Error deleting item: " + err.message, "error");
      });
  });
}

async function loadTrendingItems() {
  const trendingContainer = document.getElementById("trendingContainer");

  // Show loading spinner at the center of the screen before fetching content
  document.getElementById("loadingSpinner").style.display = "flex"; // Show the spinner

  // Show loading spinner before fetching content
  trendingContainer.innerHTML = `
    <div style="width: 100%; text-align: center; padding: 30px;">
      <i class="fas fa-spinner fa-spin" style="font-size: 36px; color: #ff5722;"></i>
      <p style="color:#666; font-weight: bold; margin-top: 10px;">Fetching trending content...</p>
    </div>
  `;

  // Create an array of async loaders for each section
  const loaders = [];

  if (typeof loadSwaps === "function") loaders.push(loadSwaps());
  if (typeof loadServices === "function") loaders.push(loadServices());
  if (typeof loadSoulmates === "function") loaders.push(loadSoulmates());
  if (typeof loadBOMJobs === "function") loaders.push(loadBOMJobs());
  if (typeof loadMarketItems === "function") loaders.push(loadMarketItems());

  // Wait for all sections to load
  await Promise.allSettled(loaders);

  // After loading is complete, continue with the trending section logic
  const allSections = [
    { id: "swapCardContainer", className: "swap-card", label: "Swaps" },
    { id: "jobContainer", className: "job-card", label: "Jobs" },
    { id: "soulmateContainer", className: "soulmate-card", label: "Soulmate" },
    { id: "servicesContainer", className: "service-card", label: "Service" },
    { id: "marketContainer", className: "market-card", label: "Market" },
    { id: "resourcesTable", tag: "tr", hasBoostedText: true, label: "Resources" }
  ];

  let foundItems = [];

  // Loop through each section to find trending items
  allSections.forEach(({ id, className, tag, hasBoostedText, label }) => {
    const container = document.getElementById(id);
    if (!container) return;

    let items = className
      ? Array.from(container.getElementsByClassName(className))
      : tag
      ? Array.from(container.getElementsByTagName(tag))
      : [];

    items.forEach(item => {
      const text = item.innerText.toLowerCase();
      if (
        text.includes("boost") ||
        text.includes("🔥") ||
        (hasBoostedText && text.includes("trending"))
      ) {
        const wrapper = document.createElement("div");
        wrapper.className = "trending-highlight"; // Add animation class

        // Add trending label
        const labelTag = document.createElement("div");
        labelTag.innerHTML = `<span style="font-size:13px; background:#ff5722; color:white; padding:3px 8px; border-radius:4px; font-weight:bold;">🔥 Trending from ${label}</span>`;
        labelTag.style.marginBottom = "8px";

        wrapper.appendChild(labelTag);
        wrapper.appendChild(item.cloneNode(true));
        foundItems.push(wrapper);
      }
    });
  });

  // Sort by most recently added (newer elements are later in DOM)
  foundItems.reverse(); // Simple reversal to show newest first

  // If no items are found, display message
  if (foundItems.length === 0) {
    trendingContainer.innerHTML = `<p style="text-align:center; color:#999;">No trending items found at the moment.</p>`;
    return;
  }

  // Clear the loading spinner and insert the found trending items
  document.getElementById("loadingSpinner").style.display = "none"; // Hide the spinner
  trendingContainer.innerHTML = "";
  foundItems.forEach(card => trendingContainer.appendChild(card));
}

function closeReviewModal() {
  document.getElementById("reviewModal").style.display = "none";
}


function toggleMenu(alertId) {
  const menu = document.getElementById(`menu-${alertId}`);
  menu.style.display = menu.style.display === "block" ? "none" : "block";

  // Close others
  document.querySelectorAll('.dropdown-content').forEach(el => {
    if (el.id !== `menu-${alertId}`) el.style.display = "none";
  });
}
// Function to show the loading spinner
function showLoadingSpinner() {
    document.getElementById("loadingSpinner").style.display = "flex";
}

// Function to hide the loading spinner
function hideLoadingSpinner() {
    document.getElementById("loadingSpinner").style.display = "none";
}

// Function to display the reset password request form
function showPasswordReset() {
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("resetRequestForm").style.display = "block";
}

// Function to hide the reset password request form and show login form
function hidePasswordReset() {
    document.getElementById("resetRequestForm").style.display = "none";
    document.getElementById("resetPasswordForm").style.display = "none";
    document.getElementById("loginForm").style.display = "block";
}

// Function to send the password reset link
function sendResetLink(event) {
    event.preventDefault();
    const email = document.getElementById("resetEmail").value;

    // Show the loading spinner
    showLoadingSpinner();

    // Use Firebase Authentication to send a password reset link
    firebase.auth().sendPasswordResetEmail(email).then(() => {
        hideLoadingSpinner(); // Hide the spinner after the process is done
        showCustomAlert("Password reset link has been sent to your email.", "success");
        hidePasswordReset();
    }).catch((error) => {
        hideLoadingSpinner(); // Hide the spinner in case of an error
        showCustomAlert(error.message, "error");
    });
}

// Function to handle the password reset after the user clicks the reset link
function resetPassword(event) {
    event.preventDefault();

    const newPassword = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    if (newPassword === confirmPassword) {
        const urlParams = new URLSearchParams(window.location.search);
        const oobCode = urlParams.get('oobCode'); // Get the reset code from URL

        if (oobCode) {
            // Show the loading spinner
            showLoadingSpinner();

            // Use Firebase to confirm the password reset
            firebase.auth().confirmPasswordReset(oobCode, newPassword).then(() => {
                hideLoadingSpinner(); // Hide the spinner after the process is done
                showCustomAlert("Your password has been reset successfully!", "success");
                window.location.href = '/login'; // Redirect to login page
            }).catch((error) => {
                hideLoadingSpinner(); // Hide the spinner in case of an error
                showCustomAlert(error.message, "error");
            });
        } else {
            showCustomAlert("Invalid or expired reset link.", "error");
        }
    } else {
        showCustomAlert("Passwords do not match!", "error");
    }
}

// Function to handle login (for demonstration purposes)
function loginUser(event) {
    event.preventDefault();
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;

    // Show the loading spinner
    showLoadingSpinner();

    firebase.auth().signInWithEmailAndPassword(email, password).then((userCredential) => {
        hideLoadingSpinner(); // Hide the spinner after the process is done
        showCustomAlert("Login successful", "success");
        // Redirect or handle successful login
    }).catch((error) => {
        hideLoadingSpinner(); // Hide the spinner in case of an error
        showCustomAlert(error.message, "error");
    });
}

// Listen to scroll event on the container
const container = document.getElementById("soulmateContainer");
const endMessage = document.getElementById("endOfListMessage");

container.addEventListener("scroll", function () {
  const isAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 2;

  if (isAtBottom) {
    endMessage.style.display = "block";
  } else {
    endMessage.style.display = "none";
  }
});
</script>









</body>
</html>

